{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://the-mesh.dev/schemas/trir/expression.schema.json",
  "title": "TRIR Expression Schema (Tagged Union)",
  "description": "Typed Relational IR - Expression AST with discriminator tags",

  "$defs": {
    "Expression": {
      "description": "Any expression node - discriminated by 'type' field",
      "oneOf": [
        { "$ref": "#/$defs/Literal" },
        { "$ref": "#/$defs/FieldRef" },
        { "$ref": "#/$defs/InputRef" },
        { "$ref": "#/$defs/SelfRef" },
        { "$ref": "#/$defs/BinaryOp" },
        { "$ref": "#/$defs/UnaryOp" },
        { "$ref": "#/$defs/Aggregation" },
        { "$ref": "#/$defs/FunctionCall" },
        { "$ref": "#/$defs/IfThenElse" },
        { "$ref": "#/$defs/Case" },
        { "$ref": "#/$defs/DateOp" },
        { "$ref": "#/$defs/ListOp" }
      ],
      "discriminator": {
        "propertyName": "type"
      }
    },

    "Literal": {
      "description": "Literal value",
      "type": "object",
      "properties": {
        "type": { "const": "literal" },
        "value": {
          "oneOf": [
            { "type": "integer" },
            { "type": "number" },
            { "type": "string" },
            { "type": "boolean" },
            { "type": "null" },
            { "type": "array", "items": { "type": "string" } }
          ]
        }
      },
      "required": ["type", "value"],
      "additionalProperties": false
    },

    "FieldRef": {
      "description": "Reference to an entity field: entity.field or entity.field.nested",
      "type": "object",
      "properties": {
        "type": { "const": "ref" },
        "path": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*(\\.[a-zA-Z_][a-zA-Z0-9_]*)+$",
          "description": "Dot-separated path: 'invoice.amount' or 'invoice.customer.name'"
        }
      },
      "required": ["type", "path"],
      "additionalProperties": false
    },

    "InputRef": {
      "description": "Reference to function input parameter",
      "type": "object",
      "properties": {
        "type": { "const": "input" },
        "name": {
          "type": "string",
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$",
          "description": "Input parameter name"
        }
      },
      "required": ["type", "name"],
      "additionalProperties": false
    },

    "SelfRef": {
      "description": "Reference to self (current entity in derived formula)",
      "type": "object",
      "properties": {
        "type": { "const": "self" },
        "field": {
          "type": "string",
          "description": "Field name on self (empty string for self entity)"
        }
      },
      "required": ["type", "field"],
      "additionalProperties": false
    },

    "BinaryOp": {
      "description": "Binary operation",
      "type": "object",
      "properties": {
        "type": { "const": "binary" },
        "op": {
          "type": "string",
          "enum": [
            "add", "sub", "mul", "div", "mod",
            "eq", "ne", "lt", "le", "gt", "ge",
            "and", "or",
            "in", "not_in",
            "like", "not_like"
          ]
        },
        "left": { "$ref": "#/$defs/Expression" },
        "right": { "$ref": "#/$defs/Expression" }
      },
      "required": ["type", "op", "left", "right"],
      "additionalProperties": false
    },

    "UnaryOp": {
      "description": "Unary operation",
      "type": "object",
      "properties": {
        "type": { "const": "unary" },
        "op": {
          "type": "string",
          "enum": ["not", "neg", "is_null", "is_not_null"]
        },
        "expr": { "$ref": "#/$defs/Expression" }
      },
      "required": ["type", "op", "expr"],
      "additionalProperties": false
    },

    "Aggregation": {
      "description": "Aggregation over a collection",
      "type": "object",
      "properties": {
        "type": { "const": "agg" },
        "op": {
          "type": "string",
          "enum": ["sum", "count", "avg", "min", "max", "exists", "not_exists", "all", "any"]
        },
        "from": {
          "type": "string",
          "description": "Source entity name"
        },
        "as": {
          "type": "string",
          "default": "item",
          "description": "Alias for iteration variable"
        },
        "expr": {
          "$ref": "#/$defs/Expression",
          "description": "Expression to aggregate (for sum, avg, etc.)"
        },
        "where": {
          "$ref": "#/$defs/Expression",
          "description": "Filter condition"
        }
      },
      "required": ["type", "op", "from"],
      "additionalProperties": false
    },

    "FunctionCall": {
      "description": "Call to a derived function",
      "type": "object",
      "properties": {
        "type": { "const": "call" },
        "name": {
          "type": "string",
          "description": "Derived function name"
        },
        "args": {
          "type": "array",
          "items": { "$ref": "#/$defs/Expression" },
          "description": "Arguments to the function"
        }
      },
      "required": ["type", "name"],
      "additionalProperties": false
    },

    "IfThenElse": {
      "description": "Conditional if-then-else expression",
      "type": "object",
      "properties": {
        "type": { "const": "if" },
        "cond": { "$ref": "#/$defs/Expression" },
        "then": { "$ref": "#/$defs/Expression" },
        "else": { "$ref": "#/$defs/Expression" }
      },
      "required": ["type", "cond", "then", "else"],
      "additionalProperties": false
    },

    "Case": {
      "description": "Case expression with multiple branches",
      "type": "object",
      "properties": {
        "type": { "const": "case" },
        "branches": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "when": { "$ref": "#/$defs/Expression" },
              "then": { "$ref": "#/$defs/Expression" }
            },
            "required": ["when", "then"],
            "additionalProperties": false
          },
          "minItems": 1
        },
        "else": { "$ref": "#/$defs/Expression" }
      },
      "required": ["type", "branches"],
      "additionalProperties": false
    },

    "DateOp": {
      "description": "Date/time operations",
      "type": "object",
      "properties": {
        "type": { "const": "date" },
        "op": {
          "type": "string",
          "enum": ["diff", "add", "sub", "now", "today", "overlaps", "truncate"]
        },
        "args": {
          "type": "array",
          "items": { "$ref": "#/$defs/Expression" }
        },
        "unit": {
          "type": "string",
          "enum": ["days", "hours", "minutes", "seconds", "months", "years"]
        }
      },
      "required": ["type", "op"],
      "additionalProperties": false
    },

    "ListOp": {
      "description": "List/array operations",
      "type": "object",
      "properties": {
        "type": { "const": "list" },
        "op": {
          "type": "string",
          "enum": ["contains", "length", "first", "last", "at", "slice"]
        },
        "list": { "$ref": "#/$defs/Expression" },
        "args": {
          "type": "array",
          "items": { "$ref": "#/$defs/Expression" }
        }
      },
      "required": ["type", "op", "list"],
      "additionalProperties": false
    }
  },

  "$ref": "#/$defs/Expression"
}
