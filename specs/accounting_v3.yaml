# 計算可能な仕様書 v3: シナリオ + Requirements 統合版

meta:
  id: SPEC-ACCOUNTING-003
  title: "Accounting Spec v3 (Full Computable)"
  version: "v0.3"

# ===========================================
# Requirements (Who / Why / What)
# ===========================================
requirements:
  REQ-001:
    who: 経理担当者
    why: 入金を請求に紐づけて売掛金を消すため
    what: 部分消込ができること
    acceptance: [AT-001]

  REQ-002:
    who: 経理担当者
    why: 完済した請求を自動でクローズし、管理工数を減らすため
    what: 全額消込時に請求が自動クローズされること
    acceptance: [AT-002]

  REQ-003:
    who: 経理担当者
    why: 過剰な消込による会計不整合を防ぐため
    what: 残額を超える消込ができないこと
    acceptance: [AT-003]

# ===========================================
# State (データ構造)
# ===========================================
state:
  invoice:
    id: string
    customer_id: string
    amount: int
    status: enum[open, closed]

  payment:
    id: string
    customer_id: string
    amount: int

  allocation:
    invoice_id: string
    payment_id: string
    amount: int

# ===========================================
# Derived (計算式)
# ===========================================
derived:
  remaining:
    params: [invoice]
    formula: "invoice.amount - sum(allocation.amount where allocation.invoice_id = invoice.id)"

# ===========================================
# Functions (API仕様)
# ===========================================
functions:
  allocate_payment:
    input:
      invoice_id: string
      payment_id: string
      amount: int
    pre:
      - "invoice.status == 'open'"
      - "payment.amount >= input.amount"
      - "remaining(invoice) >= input.amount"
    post:
      - create: allocation
        set:
          amount: input.amount
          invoice_id: input.invoice_id
          payment_id: input.payment_id
      - when: "remaining(invoice) == 0"
        update: invoice
        set:
          status: closed
    error:
      - when: "remaining(invoice) < input.amount"
        code: OVER_ALLOCATION

# ===========================================
# Invariants (不変条件)
# ===========================================
invariants:
  - id: INV-001
    expr: "remaining(invoice) >= 0"
    description: "残額は常に0以上"

# ===========================================
# Scenarios (Given-When-Then を式で表現)
# ===========================================
scenarios:
  AT-001:
    title: 部分消込
    requirements: [REQ-001]
    given:
      state:
        invoice:
          - id: "INV-001"
            amount: 100000
            status: open
        payment:
          - id: "PAY-001"
            amount: 80000
        allocation: []
    when:
      call: allocate_payment
      input:
        invoice_id: "INV-001"
        payment_id: "PAY-001"
        amount: 80000
    then:
      assert:
        - "remaining(invoice) == 20000"
        - "invoice.status == 'open'"
      state:
        allocation:
          - invoice_id: "INV-001"
            payment_id: "PAY-001"
            amount: 80000

  AT-002:
    title: 全額消込で自動クローズ
    requirements: [REQ-002]
    given:
      state:
        invoice:
          - id: "INV-001"
            amount: 100000
            status: open
        payment:
          - id: "PAY-001"
            amount: 100000
        allocation: []
    when:
      call: allocate_payment
      input:
        invoice_id: "INV-001"
        payment_id: "PAY-001"
        amount: 100000
    then:
      assert:
        - "remaining(invoice) == 0"
        - "invoice.status == 'closed'"

  AT-003:
    title: 残額超過エラー
    requirements: [REQ-003]
    given:
      state:
        invoice:
          - id: "INV-001"
            amount: 100000
            status: open
        payment:
          - id: "PAY-001"
            amount: 150000
        allocation: []
    when:
      call: allocate_payment
      input:
        invoice_id: "INV-001"
        payment_id: "PAY-001"
        amount: 120000
    then:
      error: OVER_ALLOCATION
      assert:
        - "remaining(invoice) == 100000"  # 変化なし
