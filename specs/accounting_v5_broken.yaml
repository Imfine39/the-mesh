# 意図的に整合性を壊した仕様（検証用）

meta:
  id: SPEC-ACCOUNTING-BROKEN
  title: "整合性が壊れた仕様"

requirements:
  REQ-001:
    who: 経理担当者
    why: 入金を請求に紐づけて売掛金を消すため
    what: 部分消込ができること
    conditions:
      - id: COND-001-1
        description: 残額がある請求に対して消込できる
        acceptance: [AT-001]
      - id: COND-001-2
        description: 消込後、残額が正しく減少する
        acceptance: []  # ← ATが紐づいていない！

  REQ-002:
    who: 経理担当者
    what: 全額消込時に請求が自動クローズされること
    # conditions がない！

  REQ-003:
    who: 経理担当者
    what: 残額を超える消込ができないこと
    conditions:
      - id: COND-003-1
        description: 残額超過でエラー
        acceptance: [AT-999]  # ← 存在しないAT！

derived:
  remaining:
    formula: "invoice.amount - sum(allocation.amount)"
    # derived_from がない！

functions:
  allocate_payment:
    # implements がない！
    pre:
      - expr: "remaining(invoice) >= input.amount"

scenarios:
  AT-001:
    title: 部分消込
    # verifies がない！
    given:
      invoice: { amount: 100000 }
    when:
      call: allocate_payment
    then:
      assert:
        - "remaining(invoice) == 20000"

state:
  invoice:
    amount: int
  allocation:
    amount: int
