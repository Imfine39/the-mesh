# workflow_idea（提案：参照見落とし前提の運用）

## 目的

* **AIも人も参照を見落とす**前提で、見落としがあっても“事故らない”開発フローを作る。
* 「参照漏れによる多機能影響」を最小化する。

## 前提

* 参照漏れはゼロにならない（AIも人も同様）。
* 参照漏れは **「発見が遅いほど被害が大きい」**。
* だから **“早期検出 + 影響の封じ込め + 回復導線”** を組み込む。

---

## ベストと考える方法（ワークフロー全体像）

### 1. 参照の“棚卸し”を最初にやる

**やること**

* 設計フェーズで **依存関係を必ず一度棚卸し**する。
* 具体的には次の3カテゴリだけを必須にする（最小セット）。

  1. **owns**（API/DB/契約の変更対象）
  2. **depends_on**（共通ルール・マスタ・用語集・他機能前提）
  3. **acceptance**（AT）

**意図**

* 参照が“全方位”だと漏れるので、**最小で強制する**。

---

### 2. bundleは「機能の最小価値単位」に切る（小さくしすぎない＝分割を止める）

**考え方**

* bundleは “コンテキスト束” なので、**機能の最小価値単位（ユーザーに見える成果）で安定させる**。
* taskを細分化しすぎると参照情報が爆発するため、**AIに渡す単位はbundleに固定**。

**ルール**

* bundleは **Feature単位固定**。
* taskはbundleの中で並列化するが、参照情報はbundleに集約する。

**補足（細かく切るべき？への答え）**

* **機能（feature）は細かく切るべき**。ただし「bundleは最小価値単位に止める」。
* 例：
  * ❌「売上管理」→ 大きすぎる
  * ✅「売上サマリ閲覧」「売上CSV出力」「売上アラート通知」など、ユーザーが独立して価値を感じる単位に分割
* つまり **“小さく切る = featureを細かくする”** であり、
  **“小さく切りすぎない = bundleの粒度を壊さない”** という意味。

---

### 3. 「参照漏れを前提にした二重検出」

**AI + 人間の両方が見落とす前提なので、検出系を二層にする。**

#### 3.1 参照の“書き忘れ”検出（CI）

* frontmatter/index/bundleの整合性を validate で落とす。
* **書いた参照の整合性**を保証する。

#### 3.2 “書かれていない参照”の検出（レビュー補助）

* **参照チェックリストを固定化**し、毎回同じ観点で強制レビューする。
* 例：
  * ruleset / glossary / master は参照したか？
  * 既存の近接機能（類似・隣接Feature）を調べたか？
  * cross-cutting領域に影響がないか？

**意図**

* CIは「書かれた参照の正しさ」しか見れないため、
  **“書かれていない参照”はレビュー補助の仕組みで拾う**。

---

### 4. 参照漏れが起きても“影響を封じる”仕組み

**仕組み**

* contracts/db/domainを触る変更は **RFCに隔離**。
* 変更が横断する場合は **featureで抱えずRFCに逃がす**。

**意図**

* 影響が大きい領域は **「集約して追跡」** しないと漏れる。

---

### 5. 「完了＝ATが通る」の統一

**ルール**

* “終わった”は **ATがパスすること**。
* taskはATの通過に集約し、テストで証明されない作業は“未完了扱い”。

**意図**

* 実装漏れは最終的に **AT不通過として検知**できる。

#### 注意：他bundleのATが落ちるケース

* **bundle内のATが通っても、他bundleのATが落ちることは現実に起きる**。
* その場合は **影響範囲をRFCへ隔離**し、契約・依存関係の差分を集約して対処する。

#### 事前に止められないか？（可能な範囲で止める）

* **影響が大きい領域は早期に“全体AT”を流す**（少なくとも主要bundleのATセット）。
* **実装前に影響範囲を評価するチェックを必須化**する（下記参照）。
* それでも漏れる前提で、**最終的な防波堤としてRFC隔離を必須化**する。

#### 実装前に影響を見積もるための最小チェック

* **変更対象のowns一覧**（API/DB/イベント/共通ルール）を先に列挙する
* **depends_onの棚卸し**（ruleset/glossary/master/近接機能）を必須化する
* **近接bundleのAT一覧を先に参照**して、衝突しそうな契約を洗い出す

> 目的は「完全に防ぐ」ことではなく、**“実装前に怪しいところを可視化して事前に止める”**こと。

---

## まとめ（このフローの本質）

1. **参照漏れは必ず起きる**と認める
2. **書き忘れはCIで検出**し、**未記載の漏れはレビューで拾う**
3. **bundleで参照を集約**し、taskで細分化しすぎない
4. **横断的な影響はRFCで隔離**して追跡を簡単にする
5. **完了はATパスで証明する**

---

## 次の議論ポイント（必要なら）

* 参照チェックリストの具体テンプレ化
* bundleの最小/最大サイズ（どの程度の機能粒度まで許容するか）
* RFC化の具体トリガー（contracts/db/domain以外でどこまで含めるか）
