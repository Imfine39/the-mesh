meta:
  id: SPEC-ACCOUNTING-001
  title: "Accounting Spec (Invoice/Payment/Allocation)"
  version: "v0.1"

state:
  invoice:
    fields:
      id: string
      customer_id: string
      amount: int
      status:
        type: enum
        values: ["open", "closed"]

  payment:
    fields:
      id: string
      customer_id: string
      amount: int

  allocation:
    fields:
      invoice_id: string
      payment_id: string
      amount: int

derived:
  remaining:
    params: [invoice]
    formula: "invoice.amount - sum(allocation.amount where allocation.invoice_id = invoice.id)"
    depends_on:
      - state: invoice.amount
      - state: allocation.amount
      - state: allocation.invoice_id

functions:
  create_invoice:
    input:
      customer_id: string
      amount: int
    pre:
      - expr: "input.amount > 0"
        depends_on: []
    post:
      - action: "create invoice"
        set:
          invoice.amount: "input.amount"
          invoice.status: "open"
          invoice.customer_id: "input.customer_id"
    error: []

  register_payment:
    input:
      customer_id: string
      amount: int
    pre:
      - expr: "input.amount > 0"
        depends_on: []
    post:
      - action: "create payment"
        set:
          payment.amount: "input.amount"
          payment.customer_id: "input.customer_id"
    error: []

  allocate_payment:
    input:
      invoice_id: string
      payment_id: string
      amount: int
    pre:
      - expr: "invoice.status == 'open'"
        depends_on:
          - state: invoice.status
      - expr: "payment.amount >= input.amount"
        depends_on:
          - state: payment.amount
      - expr: "remaining(invoice) >= input.amount"
        depends_on:
          - derived: remaining
    post:
      - action: "create allocation"
        set:
          allocation.amount: "input.amount"
          allocation.invoice_id: "input.invoice_id"
          allocation.payment_id: "input.payment_id"
      - action: "update invoice status if fully paid"
        condition: "remaining(invoice) == 0"
        set:
          invoice.status: "closed"
        depends_on:
          - derived: remaining
    error:
      - condition: "remaining(invoice) < input.amount"
        code: "OVER_ALLOCATION"
        depends_on:
          - derived: remaining

invariants:
  - id: INV-001
    expr: "remaining(invoice) >= 0"
    description: "Invoice remaining amount must never be negative"
    depends_on:
      - derived: remaining
