# ECサイト注文管理仕様書（v5正式版）
# 注文・在庫・配送の仕様

meta:
  id: SPEC-ECOMMERCE-ORDER-V5
  title: "ECサイト - 注文管理"
  version: "v5.0"
  domain: ecommerce

# ============================================
# 要求定義
# ============================================
requirements:
  REQ-001:
    who: 顧客
    why: 商品を購入するため
    what: カートに商品を追加できること
    conditions:
      - id: COND-001-1
        description: 在庫がある商品をカートに追加できる
        acceptance: [AT-001]
      - id: COND-001-2
        description: 在庫数以上の数量は追加できない
        acceptance: [AT-002]

  REQ-002:
    who: 顧客
    why: 購入を確定するため
    what: カートの商品を注文できること
    conditions:
      - id: COND-002-1
        description: 注文時に在庫が確保される
        acceptance: [AT-003]
      - id: COND-002-2
        description: 注文時に在庫が減少する
        acceptance: [AT-003]
        verifies:
          - expr: "product.stock == before_stock - order_item.quantity"

  REQ-003:
    who: 顧客
    why: 購入を取りやめるため
    what: 注文をキャンセルできること
    conditions:
      - id: COND-003-1
        description: 発送前の注文はキャンセルできる
        acceptance: [AT-004]
      - id: COND-003-2
        description: キャンセル時に在庫が戻る
        acceptance: [AT-004]
      - id: COND-003-3
        description: 発送済みの注文はキャンセルできない
        acceptance: [AT-005]

  REQ-004:
    who: 倉庫担当者
    why: 顧客に商品を届けるため
    what: 注文を発送できること
    conditions:
      - id: COND-004-1
        description: 確定済み注文を発送済みにできる
        acceptance: [AT-006]

  REQ-005:
    who: 顧客
    why: 注文金額を確認するため
    what: 注文合計金額が正しく計算されること
    conditions:
      - id: COND-005-1
        description: 注文合計 = 商品単価 × 数量 の合計
        acceptance: [AT-007]

# ============================================
# 状態定義
# ============================================
state:
  product:
    id: string
    name: string
    price: int
    stock: int

  cart:
    id: string
    user_id: string
    status: enum[active, ordered]

  cart_item:
    id: string
    cart_id: string
    product_id: string
    quantity: int

  order:
    id: string
    user_id: string
    status: enum[pending, confirmed, shipped, delivered, cancelled]
    total_amount: int

  order_item:
    id: string
    order_id: string
    product_id: string
    quantity: int
    unit_price: int

# ============================================
# 計算式
# ============================================
derived:
  cart_total:
    description: カート合計金額
    derived_from: [REQ-005]
    formula: "sum(product.price * cart_item.quantity where cart_item.cart_id == cart.id)"

  order_total:
    description: 注文合計金額
    derived_from: [REQ-005]
    formula: "sum(order_item.unit_price * order_item.quantity where order_item.order_id == order.id)"

  cart_item_count:
    description: カート内の商品数
    derived_from: [REQ-001]
    formula: "sum(cart_item.quantity where cart_item.cart_id == cart.id)"

  available_stock:
    description: 利用可能在庫数
    derived_from: [REQ-001, REQ-002]
    formula: "product.stock"

# ============================================
# 関数定義
# ============================================
functions:
  add_to_cart:
    description: カートに商品を追加
    implements: [REQ-001]
    input:
      cart_id: string
      product_id: string
      quantity: int
    pre:
      - expr: "cart.status == 'active'"
        reason: "注文済みカートには追加できない"
    error:
      - code: OUT_OF_STOCK
        when: "product.stock < input.quantity"
        reason: "在庫が不足しています"
        required_by: REQ-001
    post:
      - action: "create cart_item"
        reason: "カートアイテムを作成"
        required_by: REQ-001

  place_order:
    description: 注文を確定
    implements: [REQ-002, REQ-005]
    input:
      cart_id: string
    pre:
      - expr: "cart.status == 'active'"
        reason: "既に注文済みのカート"
      - expr: "cart_item_count(cart) > 0"
        reason: "カートが空です"
    error:
      - code: INSUFFICIENT_STOCK
        when: "any(product.stock < cart_item.quantity for cart_item in cart.items)"
        reason: "在庫が確保できません"
        required_by: REQ-002
    post:
      - action: "create order with status = 'confirmed'"
        reason: "注文を作成"
        required_by: REQ-002
      - action: "decrease product.stock by cart_item.quantity"
        reason: "在庫を減らす"
        required_by: REQ-002
      - action: "cart.status = 'ordered'"
        reason: "カートを注文済みに"

  cancel_order:
    description: 注文をキャンセル
    implements: [REQ-003]
    input:
      order_id: string
    pre:
      - expr: "order.status == 'confirmed'"
        reason: "確定済み注文のみキャンセル可能"
    error:
      - code: ALREADY_SHIPPED
        when: "order.status == 'shipped'"
        reason: "発送済みの注文はキャンセルできません"
        required_by: REQ-003
    post:
      - action: "order.status = 'cancelled'"
        reason: "注文をキャンセル状態に"
        required_by: REQ-003
      - action: "increase product.stock by order_item.quantity"
        reason: "在庫を戻す"
        required_by: REQ-003

  ship_order:
    description: 注文を発送
    implements: [REQ-004]
    input:
      order_id: string
    pre:
      - expr: "order.status == 'confirmed'"
        reason: "確定済み注文のみ発送可能"
    post:
      - action: "order.status = 'shipped'"
        reason: "発送済みに更新"
        required_by: REQ-004

# ============================================
# シナリオ
# ============================================
scenarios:
  AT-001:
    title: 在庫がある商品をカートに追加
    verifies: [COND-001-1]
    given:
      product: { id: "PROD-001", name: "Tシャツ", price: 2000, stock: 10 }
      cart: { id: "CART-001", user_id: "USER-001", status: active }
      cart_item: []
    when:
      call: add_to_cart
      input: { cart_id: "CART-001", product_id: "PROD-001", quantity: 2 }
    then:
      success: true
      assert:
        - "cart_item_count(cart) == 2"

  AT-002:
    title: 在庫超過でエラー
    verifies: [COND-001-2]
    given:
      product: { id: "PROD-001", name: "Tシャツ", price: 2000, stock: 5 }
      cart: { id: "CART-001", user_id: "USER-001", status: active }
      cart_item: []
    when:
      call: add_to_cart
      input: { cart_id: "CART-001", product_id: "PROD-001", quantity: 10 }
    then:
      error: OUT_OF_STOCK

  AT-003:
    title: 注文確定で在庫が減少
    verifies: [COND-002-1, COND-002-2]
    given:
      product: { id: "PROD-001", name: "Tシャツ", price: 2000, stock: 10 }
      cart: { id: "CART-001", user_id: "USER-001", status: active }
      cart_item:
        - { id: "CI-001", cart_id: "CART-001", product_id: "PROD-001", quantity: 3 }
      order: []
    when:
      call: place_order
      input: { cart_id: "CART-001" }
    then:
      success: true
      assert:
        - "product.stock == 7"
        - "order.status == 'confirmed'"

  AT-004:
    title: 注文キャンセルで在庫が戻る
    verifies: [COND-003-1, COND-003-2]
    given:
      product: { id: "PROD-001", name: "Tシャツ", price: 2000, stock: 7 }
      order: { id: "ORD-001", user_id: "USER-001", status: confirmed, total_amount: 6000 }
      order_item:
        - { id: "OI-001", order_id: "ORD-001", product_id: "PROD-001", quantity: 3, unit_price: 2000 }
    when:
      call: cancel_order
      input: { order_id: "ORD-001" }
    then:
      success: true
      assert:
        - "product.stock == 10"
        - "order.status == 'cancelled'"

  AT-005:
    title: 発送済み注文はキャンセル不可
    verifies: [COND-003-3]
    given:
      product: { id: "PROD-001", name: "Tシャツ", price: 2000, stock: 7 }
      order: { id: "ORD-001", user_id: "USER-001", status: shipped, total_amount: 6000 }
      order_item:
        - { id: "OI-001", order_id: "ORD-001", product_id: "PROD-001", quantity: 3, unit_price: 2000 }
    when:
      call: cancel_order
      input: { order_id: "ORD-001" }
    then:
      error: ALREADY_SHIPPED

  AT-006:
    title: 注文を発送
    verifies: [COND-004-1]
    given:
      order: { id: "ORD-001", user_id: "USER-001", status: confirmed, total_amount: 6000 }
      order_item: []
    when:
      call: ship_order
      input: { order_id: "ORD-001" }
    then:
      success: true
      assert:
        - "order.status == 'shipped'"

  AT-007:
    title: 注文合計金額の計算
    verifies: [COND-005-1]
    given:
      order: { id: "ORD-001", user_id: "USER-001", status: confirmed, total_amount: 0 }
      order_item:
        - { id: "OI-001", order_id: "ORD-001", product_id: "PROD-001", quantity: 2, unit_price: 2000 }
        - { id: "OI-002", order_id: "ORD-001", product_id: "PROD-002", quantity: 1, unit_price: 5000 }
    when:
      call: place_order
      input: { cart_id: "CART-001" }
    then:
      success: true
      assert:
        - "order_total(order) == 9000"

# ============================================
# 不変条件
# ============================================
invariants:
  - id: INV-001
    expr: "product.stock >= 0"
    description: "在庫は常に0以上"
  - id: INV-002
    expr: "order_item.quantity > 0"
    description: "注文数量は常に正"
  - id: INV-003
    expr: "order_item.unit_price >= 0"
    description: "単価は常に0以上"
