# タスク管理システム仕様書（v5正式版）
# プロジェクト・タスク・担当者の仕様

meta:
  id: SPEC-TASK-MGMT-V5
  title: "タスク管理システム"
  version: "v5.0"
  domain: project_management

# ============================================
# 要求定義
# ============================================
requirements:
  REQ-001:
    who: プロジェクトマネージャー
    why: プロジェクトの進捗を管理するため
    what: タスクを作成・管理できること
    conditions:
      - id: COND-001-1
        description: プロジェクトにタスクを追加できる
        acceptance: [AT-001]
      - id: COND-001-2
        description: タスクに担当者をアサインできる
        acceptance: [AT-002]

  REQ-002:
    who: 開発者
    why: 作業状況を共有するため
    what: タスクのステータスを更新できること
    conditions:
      - id: COND-002-1
        description: タスクを開始できる（todo → in_progress）
        acceptance: [AT-003]
      - id: COND-002-2
        description: タスクを完了できる（in_progress → done）
        acceptance: [AT-004]
      - id: COND-002-3
        description: 完了したタスクは再オープンできる
        acceptance: [AT-005]

  REQ-003:
    who: プロジェクトマネージャー
    why: 進捗状況を把握するため
    what: プロジェクトの進捗率が計算されること
    conditions:
      - id: COND-003-1
        description: 進捗率 = 完了タスク数 / 全タスク数
        acceptance: [AT-006]
        verifies:
          - expr: "progress_rate(project) == done_count / total_count"

  REQ-004:
    who: 開発者
    why: 作業の優先順位を明確にするため
    what: タスクに優先度を設定できること
    conditions:
      - id: COND-004-1
        description: タスクに高・中・低の優先度を設定できる
        acceptance: [AT-007]

  REQ-005:
    who: プロジェクトマネージャー
    why: 期限管理のため
    what: タスクに期限を設定できること
    conditions:
      - id: COND-005-1
        description: タスクに期限を設定できる
        acceptance: [AT-008]
      - id: COND-005-2
        description: 期限超過タスクを検出できる
        acceptance: [AT-009]

  REQ-006:
    who: 開発者
    why: 作業時間を記録するため
    what: タスクに作業時間を記録できること
    conditions:
      - id: COND-006-1
        description: タスクに作業時間を追加できる
        acceptance: [AT-010]

# ============================================
# 状態定義
# ============================================
state:
  project:
    id: string
    name: string
    status: enum[active, completed, archived]

  member:
    id: string
    name: string
    email: string
    role: enum[manager, developer, viewer]

  task:
    id: string
    project_id: string
    title: string
    description: string
    status: enum[todo, in_progress, done]
    priority: enum[high, medium, low]
    assignee_id: string
    due_date: string
    estimated_hours: int

  time_entry:
    id: string
    task_id: string
    member_id: string
    hours: int
    date: string

# ============================================
# 計算式
# ============================================
derived:
  total_tasks:
    description: プロジェクトの全タスク数
    derived_from: [REQ-003]
    formula: "count(task where task.project_id == project.id)"

  done_tasks:
    description: プロジェクトの完了タスク数
    derived_from: [REQ-003]
    formula: "count(task where task.project_id == project.id and task.status == 'done')"

  progress_rate:
    description: プロジェクト進捗率（%）
    derived_from: [REQ-003]
    formula: "(done_tasks(project) / total_tasks(project)) * 100"

  actual_hours:
    description: タスクの実績時間
    derived_from: [REQ-006]
    formula: "sum(time_entry.hours where time_entry.task_id == task.id)"

  remaining_hours:
    description: タスクの残り時間
    derived_from: [REQ-006]
    formula: "task.estimated_hours - actual_hours(task)"

# ============================================
# 関数定義
# ============================================
functions:
  create_task:
    description: タスクを作成
    implements: [REQ-001]
    input:
      project_id: string
      title: string
      priority: string
    pre:
      - expr: "project.status == 'active'"
        reason: "アクティブなプロジェクトにのみタスクを追加可能"
    post:
      - action: "create task with status = 'todo'"
        reason: "新規タスクを作成"
        required_by: REQ-001

  assign_task:
    description: タスクに担当者をアサイン
    implements: [REQ-001]
    input:
      task_id: string
      assignee_id: string
    pre:
      - expr: "task.status != 'done'"
        reason: "完了タスクにはアサインできない"
    post:
      - action: "task.assignee_id = input.assignee_id"
        reason: "担当者を設定"
        required_by: REQ-001

  start_task:
    description: タスクを開始
    implements: [REQ-002]
    input:
      task_id: string
    pre:
      - expr: "task.status == 'todo'"
        reason: "未着手タスクのみ開始可能"
      - expr: "task.assignee_id != null"
        reason: "担当者がアサインされていないと開始できない"
    error:
      - code: NOT_ASSIGNED
        when: "task.assignee_id == null"
        reason: "担当者が未設定です"
        required_by: REQ-002
    post:
      - action: "task.status = 'in_progress'"
        reason: "進行中に更新"
        required_by: REQ-002

  complete_task:
    description: タスクを完了
    implements: [REQ-002]
    input:
      task_id: string
    pre:
      - expr: "task.status == 'in_progress'"
        reason: "進行中タスクのみ完了可能"
    post:
      - action: "task.status == 'done'"
        reason: "完了に更新"
        required_by: REQ-002

  reopen_task:
    description: タスクを再オープン
    implements: [REQ-002]
    input:
      task_id: string
    pre:
      - expr: "task.status == 'done'"
        reason: "完了タスクのみ再オープン可能"
    post:
      - action: "task.status = 'todo'"
        reason: "未着手に戻す"
        required_by: REQ-002

  log_time:
    description: 作業時間を記録
    implements: [REQ-006]
    input:
      task_id: string
      hours: int
    pre:
      - expr: "input.hours > 0"
        reason: "記録時間は正の値"
    post:
      - action: "create time_entry"
        reason: "作業時間を記録"
        required_by: REQ-006

# ============================================
# シナリオ
# ============================================
scenarios:
  AT-001:
    title: プロジェクトにタスクを追加
    verifies: [COND-001-1]
    given:
      project: { id: "PRJ-001", name: "Webサイトリニューアル", status: active }
      task: []
    when:
      call: create_task
      input: { project_id: "PRJ-001", title: "デザイン作成", priority: "high" }
    then:
      success: true
      assert:
        - "total_tasks(project) == 1"

  AT-002:
    title: タスクに担当者をアサイン
    verifies: [COND-001-2]
    given:
      member: { id: "MEM-001", name: "田中太郎", email: "tanaka@example.com", role: developer }
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: todo, priority: high, assignee_id: null }
    when:
      call: assign_task
      input: { task_id: "TASK-001", assignee_id: "MEM-001" }
    then:
      success: true
      assert:
        - "task.assignee_id == 'MEM-001'"

  AT-003:
    title: タスクを開始
    verifies: [COND-002-1]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: todo, priority: high, assignee_id: "MEM-001" }
    when:
      call: start_task
      input: { task_id: "TASK-001" }
    then:
      success: true
      assert:
        - "task.status == 'in_progress'"

  AT-004:
    title: タスクを完了
    verifies: [COND-002-2]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: in_progress, priority: high, assignee_id: "MEM-001" }
    when:
      call: complete_task
      input: { task_id: "TASK-001" }
    then:
      success: true
      assert:
        - "task.status == 'done'"

  AT-005:
    title: 完了タスクを再オープン
    verifies: [COND-002-3]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: done, priority: high, assignee_id: "MEM-001" }
    when:
      call: reopen_task
      input: { task_id: "TASK-001" }
    then:
      success: true
      assert:
        - "task.status == 'todo'"

  AT-006:
    title: プロジェクト進捗率の計算
    verifies: [COND-003-1]
    given:
      project: { id: "PRJ-001", name: "Webサイトリニューアル", status: active }
      task:
        - { id: "TASK-001", project_id: "PRJ-001", title: "タスク1", status: done, priority: medium, assignee_id: "MEM-001" }
        - { id: "TASK-002", project_id: "PRJ-001", title: "タスク2", status: done, priority: medium, assignee_id: "MEM-001" }
        - { id: "TASK-003", project_id: "PRJ-001", title: "タスク3", status: in_progress, priority: medium, assignee_id: "MEM-001" }
        - { id: "TASK-004", project_id: "PRJ-001", title: "タスク4", status: todo, priority: medium, assignee_id: null }
    when:
      call: complete_task
      input: { task_id: "TASK-003" }
    then:
      success: true
      assert:
        - "progress_rate(project) == 75"

  AT-007:
    title: タスクに優先度を設定
    verifies: [COND-004-1]
    given:
      project: { id: "PRJ-001", name: "Webサイトリニューアル", status: active }
      task: []
    when:
      call: create_task
      input: { project_id: "PRJ-001", title: "緊急バグ修正", priority: "high" }
    then:
      success: true
      assert:
        - "task.priority == 'high'"

  AT-008:
    title: タスクに期限を設定
    verifies: [COND-005-1]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: todo, priority: high, assignee_id: "MEM-001", due_date: "2024-12-31" }
    when:
      call: start_task
      input: { task_id: "TASK-001" }
    then:
      success: true
      assert:
        - "task.due_date == '2024-12-31'"

  AT-009:
    title: 担当者未設定でエラー
    verifies: [COND-002-1]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: todo, priority: high, assignee_id: null }
    when:
      call: start_task
      input: { task_id: "TASK-001" }
    then:
      error: NOT_ASSIGNED

  AT-010:
    title: 作業時間を記録
    verifies: [COND-006-1]
    given:
      task: { id: "TASK-001", project_id: "PRJ-001", title: "デザイン作成", status: in_progress, priority: high, assignee_id: "MEM-001", estimated_hours: 8 }
      time_entry: []
    when:
      call: log_time
      input: { task_id: "TASK-001", hours: 2 }
    then:
      success: true
      assert:
        - "actual_hours(task) == 2"
        - "remaining_hours(task) == 6"

# ============================================
# 不変条件
# ============================================
invariants:
  - id: INV-001
    expr: "progress_rate(project) >= 0 and progress_rate(project) <= 100"
    description: "進捗率は0〜100%の範囲"
  - id: INV-002
    expr: "time_entry.hours > 0"
    description: "記録時間は常に正"
  - id: INV-003
    expr: "task.estimated_hours >= 0"
    description: "見積時間は0以上"
