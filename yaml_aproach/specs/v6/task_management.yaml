# タスク管理システム仕様書（v6正式版）
# タスク・プロジェクト管理の仕様
# v6: 構造化式形式 + selfキーワード

meta:
  id: SPEC-TASK-MANAGEMENT-V6
  title: "タスク管理システム"
  version: "v6.0"
  domain: project_management

# ============================================
# 状態定義
# ============================================
state:
  project:
    id: string
    name: string
    status: enum[active, completed, cancelled]
    start_date: string
    due_date: string

  task:
    id: string
    project_id: string
    title: string
    description: string
    assignee_id: string
    status: enum[todo, in_progress, review, done, cancelled]
    priority: enum[low, medium, high, urgent]
    estimated_hours: int
    actual_hours: int
    due_date: string

  user:
    id: string
    name: string
    email: string
    role: enum[developer, manager, admin]

# ============================================
# 計算式
# ============================================
derived:
  project_progress:
    description: プロジェクト進捗率（完了タスク数/全タスク数）
    formula:
      divide:
        - count:
            from: "task"
            where:
              and:
                - "item.project_id == self.id"
                - "item.status == 'done'"
        - count:
            from: "task"
            where: "item.project_id == self.id"

  task_count:
    description: プロジェクト内のタスク数
    formula:
      count:
        from: "task"
        where: "item.project_id == self.id"

  completed_task_count:
    description: 完了タスク数
    formula:
      count:
        from: "task"
        where:
          and:
            - "item.project_id == self.id"
            - "item.status == 'done'"

  total_estimated_hours:
    description: プロジェクト見積もり工数合計
    formula:
      sum:
        expr: "item.estimated_hours"
        from: "task as item"
        where: "item.project_id == self.id"

  total_actual_hours:
    description: プロジェクト実績工数合計
    formula:
      sum:
        expr: "item.actual_hours"
        from: "task as item"
        where: "item.project_id == self.id"

# ============================================
# 関数定義
# ============================================
functions:
  create_task:
    description: タスクを作成
    input:
      project_id: string
      title: string
      description: string
      assignee_id: string
      priority: string
      estimated_hours: int
      due_date: string
    pre:
      - expr: "self.status == 'active'"
        entity: project
        reason: "アクティブなプロジェクトのみタスク追加可能"
    post:
      - action:
          create: task
          with:
            project_id: "input.project_id"
            title: "input.title"
            description: "input.description"
            assignee_id: "input.assignee_id"
            status: "'todo'"
            priority: "input.priority"
            estimated_hours: "input.estimated_hours"
            actual_hours: 0
            due_date: "input.due_date"
        reason: "タスクを作成"

  start_task:
    description: タスクを開始
    input:
      task_id: string
    pre:
      - expr: "self.status == 'todo'"
        entity: task
        reason: "未着手タスクのみ開始可能"
    post:
      - action:
          update: task
          set:
            status: "'in_progress'"
        reason: "タスクを進行中に"

  complete_task:
    description: タスクを完了
    input:
      task_id: string
      actual_hours: int
    pre:
      - expr:
          in:
            field: "self.status"
            values: ["in_progress", "review"]
        entity: task
        reason: "進行中またはレビュー中のタスクのみ完了可能"
    post:
      - action:
          update: task
          set:
            status: "'done'"
            actual_hours: "input.actual_hours"
        reason: "タスクを完了に"

  cancel_task:
    description: タスクをキャンセル
    input:
      task_id: string
    pre:
      - expr:
          in:
            field: "self.status"
            values: ["todo", "in_progress"]
        entity: task
        reason: "未完了タスクのみキャンセル可能"
    post:
      - action:
          update: task
          set:
            status: "'cancelled'"
        reason: "タスクをキャンセル"

  complete_project:
    description: プロジェクトを完了
    input:
      project_id: string
    pre:
      - expr: "self.status == 'active'"
        entity: project
        reason: "アクティブなプロジェクトのみ完了可能"
    error:
      - code: INCOMPLETE_TASKS
        when:
          exists:
            from: "task"
            where:
              and:
                - "item.project_id == input.project_id"
                - not:
                    in:
                      field: "item.status"
                      values: ["done", "cancelled"]
        reason: "未完了タスクがあります"
    post:
      - action:
          update: project
          set:
            status: "'completed'"
        reason: "プロジェクトを完了"

# ============================================
# シナリオ
# ============================================
scenarios:
  AT-001:
    title: タスクを作成
    given:
      project: { id: "PROJ-001", name: "新機能開発", status: "active", start_date: "2024-01-01", due_date: "2024-03-31" }
      user: { id: "USER-001", name: "山田太郎", email: "yamada@example.com", role: "developer" }
      task: []
    when:
      call: create_task
      input: { project_id: "PROJ-001", title: "ログイン機能", description: "ログイン画面を実装", assignee_id: "USER-001", priority: "high", estimated_hours: 8, due_date: "2024-01-15" }
    then:
      success: true
      assert:
        - expr: "task.status == 'todo'"

  AT-002:
    title: タスクを開始
    given:
      task: { id: "TASK-001", project_id: "PROJ-001", title: "ログイン機能", description: "", assignee_id: "USER-001", status: "todo", priority: "high", estimated_hours: 8, actual_hours: 0, due_date: "2024-01-15" }
    when:
      call: start_task
      input: { task_id: "TASK-001" }
    then:
      success: true
      assert:
        - expr: "task.status == 'in_progress'"

  AT-003:
    title: タスクを完了
    given:
      task: { id: "TASK-001", project_id: "PROJ-001", title: "ログイン機能", description: "", assignee_id: "USER-001", status: "in_progress", priority: "high", estimated_hours: 8, actual_hours: 0, due_date: "2024-01-15" }
    when:
      call: complete_task
      input: { task_id: "TASK-001", actual_hours: 10 }
    then:
      success: true
      assert:
        - expr: "task.status == 'done'"
        - expr: "task.actual_hours == 10"

  AT-004:
    title: 完了タスクは開始不可
    given:
      task: { id: "TASK-001", project_id: "PROJ-001", title: "ログイン機能", description: "", assignee_id: "USER-001", status: "done", priority: "high", estimated_hours: 8, actual_hours: 10, due_date: "2024-01-15" }
    when:
      call: start_task
      input: { task_id: "TASK-001" }
    then:
      error: PRE_CONDITION_FAILED

  AT-005:
    title: プロジェクト完了
    given:
      project: { id: "PROJ-001", name: "新機能開発", status: "active", start_date: "2024-01-01", due_date: "2024-03-31" }
      task:
        - { id: "TASK-001", project_id: "PROJ-001", title: "タスク1", description: "", assignee_id: "USER-001", status: "done", priority: "high", estimated_hours: 8, actual_hours: 10, due_date: "2024-01-15" }
    when:
      call: complete_project
      input: { project_id: "PROJ-001" }
    then:
      success: true
      assert:
        - expr: "project.status == 'completed'"

  AT-006:
    title: 未完了タスクがあるとプロジェクト完了不可
    given:
      project: { id: "PROJ-001", name: "新機能開発", status: "active", start_date: "2024-01-01", due_date: "2024-03-31" }
      task:
        - { id: "TASK-001", project_id: "PROJ-001", title: "タスク1", description: "", assignee_id: "USER-001", status: "in_progress", priority: "high", estimated_hours: 8, actual_hours: 0, due_date: "2024-01-15" }
    when:
      call: complete_project
      input: { project_id: "PROJ-001" }
    then:
      error: INCOMPLETE_TASKS
