# 予約システム仕様書（v6正式版）
# ホテル・施設予約の仕様
# v6: 構造化式形式 + selfキーワード

meta:
  id: SPEC-RESERVATION-V6
  title: "施設予約システム"
  version: "v6.0"
  domain: hospitality

# ============================================
# 状態定義
# ============================================
state:
  room:
    id: string
    room_number: string
    room_type: enum[single, double, twin, suite]
    capacity: int
    price_per_night: int
    status: enum[available, occupied, maintenance]

  guest:
    id: string
    name: string
    email: string

  reservation:
    id: string
    room_id: string
    guest_id: string
    check_in_date: string
    check_out_date: string
    num_guests: int
    status: enum[pending, confirmed, checked_in, checked_out, cancelled]
    total_amount: int

# ============================================
# 計算式
# ============================================
derived:
  stay_duration:
    description: 宿泊日数
    formula:
      date_diff:
        from: "self.check_in_date"
        to: "self.check_out_date"
        unit: "days"

  reservation_total:
    description: 予約合計金額
    formula:
      multiply:
        - "room.price_per_night"
        - { call: stay_duration, args: [self] }

  days_until_checkin:
    description: チェックインまでの日数
    formula:
      date_diff:
        from: { today: true }
        to: "self.check_in_date"
        unit: "days"

  cancellation_fee_rate:
    description: キャンセル料率
    formula:
      case:
        - when:
            ge: [{ call: days_until_checkin, args: [self] }, 7]
          then: 0
        - when:
            ge: [{ call: days_until_checkin, args: [self] }, 3]
          then: 0.3
        - else: 1.0

# ============================================
# 関数定義
# ============================================
functions:
  create_reservation:
    description: 予約を作成
    input:
      room_id: string
      guest_id: string
      check_in_date: string
      check_out_date: string
      num_guests: int
    pre:
      - expr: "self.status == 'available'"
        entity: room
        reason: "利用可能な部屋のみ予約できる"
    error:
      - code: ROOM_NOT_AVAILABLE
        when:
          not_exists:
            from: "reservation"
            where:
              and:
                - "item.room_id == input.room_id"
                - "item.status == 'confirmed'"
                - overlaps:
                    range1: ["item.check_in_date", "item.check_out_date"]
                    range2: ["input.check_in_date", "input.check_out_date"]
        reason: "指定期間に既存の予約があります"
    post:
      - action:
          create: reservation
          with:
            room_id: "input.room_id"
            guest_id: "input.guest_id"
            check_in_date: "input.check_in_date"
            check_out_date: "input.check_out_date"
            num_guests: "input.num_guests"
            status: "'confirmed'"
            total_amount: 0
        reason: "予約を作成"

  cancel_reservation:
    description: 予約をキャンセル
    input:
      reservation_id: string
    pre:
      - expr: "self.status == 'confirmed'"
        entity: reservation
        reason: "確定済み予約のみキャンセル可能"
    error:
      - code: ALREADY_CHECKED_IN
        when:
          eq: ["reservation.status", "'checked_in'"]
        reason: "チェックイン後はキャンセルできません"
    post:
      - action:
          update: reservation
          set:
            status: "'cancelled'"
        reason: "予約をキャンセル"

  check_in:
    description: チェックイン
    input:
      reservation_id: string
    pre:
      - expr: "self.status == 'confirmed'"
        entity: reservation
        reason: "確定済み予約のみチェックイン可能"
    post:
      - action:
          update: reservation
          set:
            status: "'checked_in'"
        reason: "チェックイン完了"
      - action:
          update: room
          set:
            status: "'occupied'"
        reason: "部屋を使用中に"

  check_out:
    description: チェックアウト
    input:
      reservation_id: string
    pre:
      - expr: "self.status == 'checked_in'"
        entity: reservation
        reason: "チェックイン中の予約のみチェックアウト可能"
    post:
      - action:
          update: reservation
          set:
            status: "'checked_out'"
        reason: "チェックアウト完了"
      - action:
          update: room
          set:
            status: "'available'"
        reason: "部屋を利用可能に"

# ============================================
# シナリオ
# ============================================
scenarios:
  AT-001:
    title: 空き部屋を予約
    given:
      room: { id: "ROOM-001", room_number: "101", room_type: "single", capacity: 1, price_per_night: 8000, status: "available" }
      guest: { id: "GUEST-001", name: "田中太郎", email: "tanaka@example.com" }
      reservation: []
    when:
      call: create_reservation
      input: { room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-01", check_out_date: "2024-03-03", num_guests: 1 }
    then:
      success: true
      assert:
        - expr: "reservation.status == 'confirmed'"

  AT-002:
    title: 予約済み部屋は予約不可
    given:
      room: { id: "ROOM-001", room_number: "101", room_type: "single", capacity: 1, price_per_night: 8000, status: "available" }
      guest: { id: "GUEST-001", name: "田中太郎", email: "tanaka@example.com" }
      reservation:
        - { id: "RES-001", room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-01", check_out_date: "2024-03-03", num_guests: 1, status: "confirmed", total_amount: 16000 }
    when:
      call: create_reservation
      input: { room_id: "ROOM-001", guest_id: "GUEST-002", check_in_date: "2024-03-02", check_out_date: "2024-03-04", num_guests: 1 }
    then:
      error: ROOM_NOT_AVAILABLE

  AT-003:
    title: 予約キャンセル
    given:
      reservation: { id: "RES-001", room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-10", check_out_date: "2024-03-12", num_guests: 1, status: "confirmed", total_amount: 16000 }
    when:
      call: cancel_reservation
      input: { reservation_id: "RES-001" }
    then:
      success: true
      assert:
        - expr: "reservation.status == 'cancelled'"

  AT-004:
    title: チェックイン
    given:
      room: { id: "ROOM-001", room_number: "101", room_type: "single", capacity: 1, price_per_night: 8000, status: "available" }
      reservation: { id: "RES-001", room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-01", check_out_date: "2024-03-03", num_guests: 1, status: "confirmed", total_amount: 16000 }
    when:
      call: check_in
      input: { reservation_id: "RES-001" }
    then:
      success: true
      assert:
        - expr: "reservation.status == 'checked_in'"
        - expr: "room.status == 'occupied'"

  AT-005:
    title: チェックアウト
    given:
      room: { id: "ROOM-001", room_number: "101", room_type: "single", capacity: 1, price_per_night: 8000, status: "occupied" }
      reservation: { id: "RES-001", room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-01", check_out_date: "2024-03-03", num_guests: 1, status: "checked_in", total_amount: 16000 }
    when:
      call: check_out
      input: { reservation_id: "RES-001" }
    then:
      success: true
      assert:
        - expr: "reservation.status == 'checked_out'"
        - expr: "room.status == 'available'"

  AT-006:
    title: チェックイン済みはキャンセル不可
    given:
      reservation: { id: "RES-001", room_id: "ROOM-001", guest_id: "GUEST-001", check_in_date: "2024-03-01", check_out_date: "2024-03-03", num_guests: 1, status: "checked_in", total_amount: 16000 }
    when:
      call: cancel_reservation
      input: { reservation_id: "RES-001" }
    then:
      error: ALREADY_CHECKED_IN
