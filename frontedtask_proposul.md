# Frontend Task Structure Proposal

## 背景

現在のThe Meshはバックエンド特化で、タスクは「機能（function）単位」で切られている。フロントエンド対応を検討するにあたり、タスクの粒度をどう設定すべきかを検討する。

## 課題

フロントエンドタスクの区切り方には以下の選択肢がある：

| 区切り方 | メリット | デメリット |
|---------|---------|-----------|
| 機能単位 | バックエンドと一致 | 1機能が複数画面に影響 |
| 画面単位 | ユーザー視点で明確 | 1画面に複数機能が混在 |
| コンポーネント単位 | 再利用性が高い | タスク爆発の可能性 |

## 上流工程ドキュメントからの考察

### RTM（要件トレーサビリティマトリクス）の構造

`上流工程/02_要件定義/07_RTM_要件トレーサビリティ.md` より：

```
要件ID → 画面設計ID → ER設計ID → テストケースID
REQ-GL-001 → UI-GL-001 → ER-GL-001 → TC-GL-001
```

重要な発見：
- 要件（REQ）は機能レベル
- UI設計（UI）は画面レベル
- 1つの画面が複数要件をカバーする場合がある
  - 例: UI-GL-003 は REQ-GL-003 と REQ-GL-004 をカバー

### アーキテクチャ設計からの示唆

`上流工程/03_基本設計/01_アーキテクチャ設計_会計モジュール.md` より：

共通コンポーネント：
- 認証・認可
- 監査ログ
- マスタ管理
- ワークフロー
- 帳票出力

→ これらは画面横断で使用される

## 提案: 3層構造タスク

```
Level 1: Common Components（共通コンポーネント）
    ↓ 依存
Level 2: Views（画面） ← メインタスク単位
    ↓ 構成
Level 3: Routes（ルーティング・ナビゲーション）
```

### Level 1: Common Components

画面横断で使用される再利用可能コンポーネント。

```yaml
components:
  - id: AccountSelector
    type: input
    props: [accounts, selected, onChange]

  - id: AmountInput
    type: input
    props: [value, currency, onChange]
    validation: positive_number

  - id: DateRangePicker
    type: input
    props: [startDate, endDate, onChange]

  - id: TransactionTable
    type: display
    props: [transactions, columns, onRowClick]
    features: [sorting, filtering, pagination]
```

**タスク粒度**: コンポーネント単位（依存なし、独立開発可能）

### Level 2: Views（メインタスク単位）

RTMのUI-IDに対応する画面単位。

```yaml
views:
  - id: UI-GL-001
    name: 仕訳入力画面
    type: form
    requirements: [REQ-GL-001]  # 要件へのリンク
    components: [AccountSelector, AmountInput, DatePicker]
    functions: [createJournalEntry]  # バックエンド機能へのリンク

  - id: UI-GL-003
    name: 試算表照会画面
    type: list
    requirements: [REQ-GL-003, REQ-GL-004]  # 複数要件
    components: [AccountSelector, DateRangePicker, TransactionTable]
    functions: [getTrialBalance, exportTrialBalance]
```

**タスク粒度**: View単位（これがメインタスク単位）

メリット：
- RTMのUI-IDと1:1対応
- ユーザーストーリーと一致
- テスト（E2E）の単位として適切

### Level 3: Routes

画面間のナビゲーションとルーティング。

```yaml
routes:
  - path: /gl/journal/new
    view: UI-GL-001
    guards: [authenticated, hasRole:accountant]

  - path: /gl/trial-balance
    view: UI-GL-003
    guards: [authenticated]
```

**タスク粒度**: 通常は独立タスクにしない（View実装に含める）

## TRIRスキーマ拡張案

### 現行スキーマ（mesh.schema.json）

```json
{
  "views": {
    "type": "array",
    "items": {
      "properties": {
        "id": { "type": "string" },
        "type": { "enum": ["list", "detail", "form", "dashboard"] },
        "entity": { "type": "string" },
        "fields": { "type": "array" }
      }
    }
  }
}
```

### 拡張案

```json
{
  "views": {
    "items": {
      "properties": {
        "id": { "type": "string" },
        "requirementIds": {
          "type": "array",
          "items": { "type": "string" }
        },
        "components": {
          "type": "array",
          "items": { "$ref": "#/definitions/componentRef" }
        },
        "functions": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  },
  "components": {
    "type": "array",
    "items": {
      "properties": {
        "id": { "type": "string" },
        "type": { "enum": ["input", "display", "layout", "action"] },
        "props": { "type": "array" },
        "events": { "type": "array" }
      }
    }
  }
}
```

## タスクパッケージ構造

### バックエンド（現行）

```
tasks/
  feature_createJournalEntry/
    TASK.md
    context.json
    tests/
```

### フロントエンド（提案）

```
tasks/
  component_AccountSelector/      # Level 1
    TASK.md
    context.json
    tests/

  view_UI-GL-001/                 # Level 2 (メイン)
    TASK.md
    context.json
    tests/

  view_UI-GL-003/
    TASK.md
    context.json
    tests/
```

## 依存関係

```mermaid
graph TD
    subgraph "Level 1: Components"
        C1[AccountSelector]
        C2[AmountInput]
        C3[DateRangePicker]
    end

    subgraph "Level 2: Views"
        V1[UI-GL-001 仕訳入力]
        V2[UI-GL-003 試算表]
    end

    subgraph "Backend Functions"
        F1[createJournalEntry]
        F2[getTrialBalance]
    end

    C1 --> V1
    C2 --> V1
    C1 --> V2
    C3 --> V2

    V1 --> F1
    V2 --> F2
```

## テスト戦略

| タスクレベル | テストタイプ | 内容 |
|-------------|------------|------|
| Component | Unit Test | Storybook + Jest |
| View | Integration Test | React Testing Library |
| View | E2E Test | Playwright/Cypress |
| Route | E2E Test | Navigation tests |

---

## モックベース要件定義ツール構想

フロントエンド対応と合わせて、要件定義プロセス自体をツール化する構想。

### 基本コンセプト

ユーザーシナリオごとにモック（ワイヤーフレーム）の遷移を提示し、視覚的に確認しながら要件を詰めていく。

### UI構成: 左右分割レイアウト

```
┌────────────────────────────────────────────────────────────────────────────────┐
│ 📁 SC-GL-001: 通常仕訳登録                                    [◀ 前] [次 ▶]   │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ┌─ モック ──────────────────────┐   ┌─ スペック ────────────────────────────┐ │
│  │                               │   │                                       │ │
│  │  ┌─────────────────────────┐  │   │  [フロー] [決定表] [API] [状態]       │ │
│  │  │     仕訳入力画面        │  │   │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │ │
│  │  │  UI-GL-001              │  │   │                                       │ │
│  │  ├─────────────────────────┤  │   │  📍 現在: 仕訳入力                    │ │
│  │  │                         │  │   │                                       │ │
│  │  │  日付: [2024/01/15  ▼]  │  │   │  ┌─────┐    ┌─────┐    ┌─────┐       │ │
│  │  │        ~~~~~~~~~~~~     │  │   │  │入力 │ ─→ │確認 │ ─→ │完了 │       │ │
│  │  │        選択中           │  │   │  └──┬──┘    └─────┘    └─────┘       │ │
│  │  │                         │  │   │     │                                 │ │
│  │  │  借方: [現金      ▼]    │  │   │     │ 100万以上                       │ │
│  │  │  貸方: [売上      ▼]    │  │   │     ▼                                 │ │
│  │  │                         │  │   │  ┌─────┐    ┌─────┐                   │ │
│  │  │  金額: [¥ 50,000    ]   │  │   │  │承認 │ ─→ │承認 │ ─→ ...           │ │
│  │  │                         │  │   │  │申請 │    │待ち │                   │ │
│  │  │  [登録] [キャンセル]    │  │   │  └─────┘    └─────┘                   │ │
│  │  │                         │  │   │                                       │ │
│  │  └─────────────────────────┘  │   ├───────────────────────────────────────┤ │
│  │                               │   │  ▼ 日付フィールド詳細                 │ │
│  │  ──────────────────────────   │   │                                       │ │
│  │  📌 選択中: 日付フィールド    │   │  型: Date                             │ │
│  │                               │   │  必須: ✓                              │ │
│  │                               │   │  バリデーション:                      │ │
│  │                               │   │  ┌───────────────────────────────┐   │ │
│  │                               │   │  │ ✓ 営業日であること            │   │ │
│  │                               │   │  │ ✓ 過去30日以内               │   │ │
│  │                               │   │  └───────────────────────────────┘   │ │
│  └───────────────────────────────┘   └───────────────────────────────────────┘ │
│                                                                                │
├────────────────────────────────────────────────────────────────────────────────┤
│  シナリオ: [1.入力]→[2.確認]→[3.完了]                    進捗: ████░░ 2/3     │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 右パネルのタブ

| タブ | 内容 |
|------|------|
| フロー | 画面遷移とシナリオフロー |
| 決定表 | パターン分岐（条件×結果マトリクス） |
| API | バックエンド処理・機能呼び出し |
| 状態 | 状態遷移図 |
| エンティティ | この画面で使用するデータ構造 |
| システム | バッチ、外部連携、ポリシー等 |

### モックUIの限界

**モックだけでは詰め切れない要素**：

1. **エッジケースの網羅性**
   - 上流工程の「取引パターン洗い出し」では42パターンを体系的に洗い出し
   - モックでは「思いつく」ものしか出てこない

2. **見えない業務ルール**
   ```
   モックで見える: [金額入力] → 「必須」「数値」

   モックで見えにくい:
   - 「月間累計が1000万超えたら部長承認必要」
   - 「同一取引先への支払いは1日1回まで」
   - 「前期比20%以上の増減は要確認フラグ」
   ```

3. **計算ロジックの詳細**
   - 端数処理（切り捨て？四捨五入？）
   - 計算タイミング（行ごと？合計後？）
   - 税率適用ルール

4. **「見た目は同じ、ロジックは違う」問題**
   - 画面A: 税込入力 → 税抜・税額を自動計算
   - 画面B: 税抜入力 → 税込を自動計算
   - モックだけでは区別がつかない

### 解決策: 4層アプローチ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          要件詰めのレイヤー                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Layer 1: モックUI                                                          │
│  ────────────────                                                           │
│  「何を作るか」の全体像を可視化                                              │
│  → Happy Path、基本フロー                                                   │
│                                                                             │
│                    ↓ これだけでは足りない                                   │
│                                                                             │
│  Layer 2: パターンチェックリスト                                            │
│  ────────────────────────────                                               │
│  「考慮すべきパターン」を体系的に問いかけ                                    │
│                                                                             │
│  ┌─ 各画面/機能に対して ─────────────────────────────────────────────────┐ │
│  │  □ 正常系バリエーション                                               │ │
│  │    - 最小ケース / 最大ケース / 代表的な業務パターン                    │ │
│  │  □ 異常系・エラー                                                     │ │
│  │    - 入力値エラー / 業務エラー / システムエラー                        │ │
│  │  □ 境界・特殊ケース                                                   │ │
│  │    - ゼロ、負数、最大値 / 期首、期末、月末                            │ │
│  │  □ 状態遷移                                                           │ │
│  │    - 来れる状態 / 遷移先 / 戻る・キャンセル                           │ │
│  │  □ 権限・マルチユーザー                                               │ │
│  │    - 操作可能者 / 同時操作 / 代理操作                                 │ │
│  │  □ 計算・集計                                                         │ │
│  │    - 計算式 / 端数処理 / 再計算タイミング                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│                    ↓                                                        │
│                                                                             │
│  Layer 3: 決定表・ルール定義                                                │
│  ─────────────────────────                                                  │
│  パターンチェックで出た内容を構造化                                          │
│                                                                             │
│                    ↓                                                        │
│                                                                             │
│  Layer 4: TRIR Spec                                                         │
│  ──────────────────                                                         │
│  機械可読な仕様へ変換                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### ツールのモード構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Mock Requirements Tool                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─ モード切替 ─────────────────────────────────────────────────────────┐  │
│  │  [📱 モック]  [✅ チェック]  [📊 決定表]  [📄 レビュー]             │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  📱 モックモード: 画面設計・フロー確認（Layer 1）                           │
│  ✅ チェックモード: 各画面にチェックリストを適用し網羅性確保（Layer 2）     │
│  📊 決定表モード: 洗い出したパターンを構造化（Layer 3）                     │
│  📄 レビューモード: 顧客確認用ドキュメント生成                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### チェックモードUI例

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ✅ チェックモード: UI-GL-001 仕訳入力画面                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─ モック ─────────────┐  ┌─ チェックリスト ──────────────────────────┐   │
│  │                      │  │                                           │   │
│  │  [モック表示]        │  │  ▼ 正常系バリエーション         3/5 完了  │   │
│  │                      │  │  ┌─────────────────────────────────────┐ │   │
│  │                      │  │  │ ✅ 最小ケース                       │ │   │
│  │                      │  │  │ ✅ 最大ケース                       │ │   │
│  │                      │  │  │ ✅ 複合仕訳                         │ │   │
│  │                      │  │  │ ⬜ 外貨建仕訳 ← 未検討              │ │   │
│  │                      │  │  │ ⬜ 自動仕訳からの修正 ← 未検討      │ │   │
│  │                      │  │  └─────────────────────────────────────┘ │   │
│  │                      │  │                                           │   │
│  │                      │  │  ▶ 異常系・エラー              0/8 完了  │   │
│  │                      │  │  ▶ 境界・特殊ケース            0/6 完了  │   │
│  │                      │  │  ▶ 状態遷移                    2/4 完了  │   │
│  │                      │  │  ▶ 権限・マルチユーザー        0/5 完了  │   │
│  │                      │  │  ▶ 計算・集計                  1/3 完了  │   │
│  │                      │  │                                           │   │
│  └──────────────────────┘  │  完了率: 18% ████░░░░░░░░░░░░░░░░░░░░░   │   │
│                             └───────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### TRIR要素のカバレッジ

| 要素カテゴリ | カバー率 | 方法 |
|-------------|---------|------|
| UI系（views, routes, scenarios） | 100% | モック直接 |
| ロジック系（functions, constraints, stateMachines） | 90% | タブパネル |
| データ系（entities, relations） | 80% | 自動推論 + 確認 |
| システム系（schedules, events, policies） | 70% | システムタブで対応 |

**結論**: モック + チェックリスト + 決定表の組み合わせで90%以上カバー可能。
残りは TRIR JSON 直接編集または専用エディタで補完。

---

## 次のステップ

### フロントエンドタスク構造
1. [ ] TRIRスキーマへの `components` セクション追加
2. [ ] `views` スキーマの拡張（requirementIds, functions リンク）
3. [ ] フロントエンドタスクパッケージジェネレーター実装
4. [ ] コンポーネントライブラリテンプレート作成
5. [ ] E2Eテストジェネレーター実装

### モックベース要件定義ツール
6. [ ] シナリオ + ワイヤーフレームのデータ構造設計
7. [ ] パターンチェックリストのテンプレート作成
8. [ ] モック → TRIR Spec 変換ロジック設計
9. [ ] プロトタイプUI実装

## 参考ドキュメント

- `上流工程/02_要件定義/07_RTM_要件トレーサビリティ.md`
- `上流工程/03_基本設計/01_アーキテクチャ設計_会計モジュール.md`
- `src/the_mesh/generators/task_package_gen.py`
- `src/the_mesh/schemas/mesh.schema.json`
