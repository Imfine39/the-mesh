# バッチ・ジョブネット設計

| 項目 | 内容 |
|------|------|
| 文書番号 | DET-BAT-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2025/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. バッチ処理一覧

### 1.1 日次バッチ

| バッチID | バッチ名 | 実行時刻 | 所要時間 | 優先度 | 業種 |
|----------|----------|----------|----------|--------|------|
| BAT-D001 | 為替レート取込 | 06:00 | 5分 | 高 | 共通 |
| BAT-D002 | EB入出金取込 | 06:30 | 30分 | 高 | 共通 |
| BAT-D003 | インボイス番号検証 | 07:00 | 15分 | 高 | 共通 |
| BAT-D010 | 売上データ取込 | 08:00 | 60分 | 中 | IT/コンサル |
| BAT-D011 | 仕入データ取込 | 08:00 | 60分 | 中 | IT/コンサル |
| BAT-D020 | 賃料請求データ生成 | 08:00 | 30分 | 中 | 不動産 |
| BAT-D021 | 賃料入金照合 | 09:00 | 30分 | 中 | 不動産 |
| BAT-D030 | 有価証券約定取込 | 08:00 | 20分 | 中 | 有価証券 |
| BAT-D031 | 配当・利金取込 | 09:00 | 15分 | 中 | 有価証券 |
| BAT-D050 | 自動仕訳生成 | 10:00 | 45分 | 高 | 共通 |
| BAT-D051 | 入金自動消込 | 11:00 | 30分 | 中 | 共通 |
| BAT-D052 | 銀行照合 | 12:00 | 20分 | 中 | 共通 |
| BAT-D090 | 日次集計・チェック | 18:00 | 30分 | 中 | 共通 |
| BAT-D091 | 監査ログハッシュ生成 | 23:00 | 15分 | 高 | 共通 |

### 1.2 月次バッチ

| バッチID | バッチ名 | 実行タイミング | 所要時間 | 優先度 | 業種 |
|----------|----------|----------------|----------|--------|------|
| BAT-M001 | 減価償却計算 | 月末+3営業日 | 60分 | 高 | 共通 |
| BAT-M002 | 為替換算差額計算 | 月末+3営業日 | 30分 | 高 | 共通 |
| BAT-M003 | 経過勘定計上 | 月末+3営業日 | 30分 | 中 | 共通 |
| BAT-M010 | 有価証券時価評価 | 月末+3営業日 | 45分 | 高 | 有価証券 |
| BAT-M011 | 債券償却原価計算 | 月末+3営業日 | 20分 | 中 | 有価証券 |
| BAT-M020 | 物件収支集計 | 月末+3営業日 | 30分 | 中 | 不動産 |
| BAT-M021 | 敷金台帳更新 | 月末+3営業日 | 15分 | 中 | 不動産 |
| BAT-M050 | 月次締め前チェック | 月末+5営業日 | 30分 | 高 | 共通 |
| BAT-M051 | 月次締め処理 | 月末+5営業日 | 120分 | 高 | 共通 |
| BAT-M060 | 帳票一括出力 | 月末+7営業日 | 60分 | 中 | 共通 |
| BAT-M061 | 消費税集計 | 月末+7営業日 | 30分 | 中 | 共通 |
| BAT-M070 | パーティション作成 | 月末 | 10分 | 低 | 共通 |

### 1.3 四半期・年次バッチ

| バッチID | バッチ名 | 実行タイミング | 所要時間 | 優先度 |
|----------|----------|----------------|----------|--------|
| BAT-Q001 | 四半期決算締め | 四半期末+10営業日 | 180分 | 高 |
| BAT-Q002 | 税効果計算 | 四半期末+10営業日 | 60分 | 高 |
| BAT-Q003 | 連結パッケージ出力 | 四半期末+15営業日 | 45分 | 中 |
| BAT-Y001 | 年次決算締め | 期末+15営業日 | 240分 | 高 |
| BAT-Y002 | 繰越処理 | 期末+15営業日 | 90分 | 高 |
| BAT-Y003 | 法人税申告データ生成 | 期末+30営業日 | 60分 | 中 |
| BAT-Y004 | 消費税申告データ生成 | 期末+30営業日 | 45分 | 中 |
| BAT-Y010 | データアーカイブ | 期首+1ヶ月 | 180分 | 低 |
| BAT-Y011 | 古パーティション削除 | 期首+2ヶ月 | 30分 | 低 |

### 1.4 随時バッチ

| バッチID | バッチ名 | トリガー | 所要時間 | 優先度 |
|----------|----------|----------|----------|--------|
| BAT-O001 | 大量仕訳インポート | 手動起動 | 可変 | 中 |
| BAT-O002 | マスタ一括更新 | 手動起動 | 可変 | 中 |
| BAT-O003 | 証憑一括取込 | 手動起動 | 可変 | 低 |
| BAT-O004 | タイムスタンプ一括付与 | 手動起動 | 可変 | 中 |
| BAT-O010 | 月次締め解除 | 承認後起動 | 30分 | 高 |

---

## 2. ジョブネット設計

### 2.1 日次ジョブネット

```
[日次ジョブネット：JN-DAILY]

開始（06:00）
    │
    ▼
┌─────────────────┐
│ BAT-D001        │ 為替レート取込（メインバンク/フォールバック）
│ 為替レート取込  │
└────────┬────────┘
         │ 成功
         ▼
┌─────────────────┐
│ BAT-D002        │ 全銀EDI/API経由でEB明細取込
│ EB入出金取込    │
└────────┬────────┘
         │ 成功
         ▼
┌─────────────────┐
│ BAT-D003        │ 新規仕入先のインボイス番号を国税庁照会
│ インボイス検証  │
└────────┬────────┘
         │ 成功
         ├─────────────────────────────────────────────┐
         │                                             │
         ▼                                             ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ BAT-D010        │  │ BAT-D020        │  │ BAT-D030        │
│ 売上データ取込  │  │ 賃料請求生成    │  │ 約定取込        │
│ (IT/コンサル)   │  │ (不動産)        │  │ (有価証券)      │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ BAT-D011        │  │ BAT-D021        │  │ BAT-D031        │
│ 仕入データ取込  │  │ 賃料入金照合    │  │ 配当・利金取込  │
│ (IT/コンサル)   │  │ (不動産)        │  │ (有価証券)      │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                   │                   │
         └─────────────┬─────┴───────────────────┘
                       │ 全て成功
                       ▼
             ┌─────────────────┐
             │ BAT-D050        │ 各種取込データから仕訳自動生成
             │ 自動仕訳生成    │
             └────────┬────────┘
                      │ 成功
                      ▼
             ┌─────────────────┐
             │ BAT-D051        │ 入金データと請求書の自動マッチング
             │ 入金自動消込    │
             └────────┬────────┘
                      │ 成功
                      ▼
             ┌─────────────────┐
             │ BAT-D052        │ 帳簿残高と銀行残高の照合
             │ 銀行照合        │
             └────────┬────────┘
                      │
                      ▼
             ┌─────────────────┐
             │ BAT-D090        │ 日次の貸借一致チェック、異常検知
             │ 日次集計チェック│
             └────────┬────────┘
                      │
                      ▼
                    終了

[夜間処理]
23:00 ─→ BAT-D091（監査ログハッシュ生成）─→ 終了
```

### 2.2 月次締めジョブネット

```
[月次締めジョブネット：JN-MONTHLY-CLOSE]

開始（手動起動/スケジュール）
    │
    ▼
┌─────────────────────┐
│ 前提条件チェック    │
│ ・日次バッチ完了    │
│ ・未承認仕訳確認    │
│ ・必須データ確認    │
└──────────┬──────────┘
           │ OK
           ├─────────────────────────────────────────┐
           │                                         │
           ▼                                         ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ BAT-M001        │  │ BAT-M002        │  │ BAT-M003        │
│ 減価償却計算    │  │ 為替換算差額    │  │ 経過勘定計上    │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                   │                   │
         └─────────────┬─────┴───────────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼
┌─────────────────┐      ┌─────────────────┐
│ BAT-M010        │      │ BAT-M020        │
│ 有価証券評価    │      │ 物件収支集計    │
│ (有価証券)      │      │ (不動産)        │
└────────┬────────┘      └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │ 全て成功
                     ▼
           ┌─────────────────┐
           │ BAT-M050        │ 締め前の整合性チェック
           │ 締め前チェック  │
           └────────┬────────┘
                    │ OK
                    ▼
           ┌─────────────────┐
           │ BAT-M051        │ 残高確定、締めフラグ設定
           │ 月次締め処理    │
           └────────┬────────┘
                    │ 成功
                    ├─────────────────────────┐
                    ▼                         ▼
           ┌─────────────────┐      ┌─────────────────┐
           │ BAT-M060        │      │ BAT-M061        │
           │ 帳票一括出力    │      │ 消費税集計      │
           └────────┬────────┘      └────────┬────────┘
                    │                         │
                    └───────────┬─────────────┘
                                ▼
                              終了
```

### 2.3 年次決算ジョブネット

```
[年次決算ジョブネット：JN-YEARLY-CLOSE]

開始（手動起動）
    │
    ▼
┌─────────────────────┐
│ 前提条件チェック    │
│ ・第4四半期締め完了 │
│ ・監査調整仕訳確認  │
└──────────┬──────────┘
           │ OK
           ▼
┌─────────────────┐
│ BAT-Y001        │ 年度末残高の確定
│ 年次決算締め    │
└────────┬────────┘
         │ 成功
         ▼
┌─────────────────┐
│ BAT-Y002        │ 期首残高の生成、損益勘定の繰越
│ 繰越処理        │
└────────┬────────┘
         │ 成功
         ├─────────────────────────┐
         ▼                         ▼
┌─────────────────┐      ┌─────────────────┐
│ BAT-Y003        │      │ BAT-Y004        │
│ 法人税申告データ│      │ 消費税申告データ│
└────────┬────────┘      └────────┬────────┘
         │                         │
         └───────────┬─────────────┘
                     ▼
                   終了

[アーカイブ処理（期首後）]

開始（スケジュール）
    │
    ▼
┌─────────────────┐
│ BAT-Y010        │ 7年超過データのアーカイブ
│ データアーカイブ│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ BAT-Y011        │ アーカイブ済みパーティションの削除
│ パーティション  │
│ 削除            │
└────────┬────────┘
         │
         ▼
       終了
```

---

## 3. バッチ処理詳細

### 3.1 為替レート取込（BAT-D001）

| 項目 | 内容 |
|------|------|
| バッチID | BAT-D001 |
| バッチ名 | 為替レート取込 |
| 実行タイミング | 毎日 06:00 |
| 処理概要 | 外部API/ファイルから為替レートを取得し、レートマスタを更新 |
| 入力 | 外部API（メインバンク）、バックアップAPI（サブバンク） |
| 出力 | M_FX_RATEテーブル |
| 前提条件 | なし |
| 後続処理 | BAT-D002（EB入出金取込） |

**処理フロー**

```typescript
// ============================================================
// 為替レート取込バッチ
// ============================================================

interface FxRateBatchConfig {
  mainBankApi: ApiConfig;
  subBankApi: ApiConfig;
  targetCurrencies: CurrencyCode[];
  rateTypes: RateType[];
  varianceThreshold: number;  // 前日比許容範囲（%）
}

class FxRateImportBatch extends BaseBatch {
  private config: FxRateBatchConfig;

  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    log.info('為替レート取込バッチ開始');

    try {
      // 1. メインバンクAPIからレート取得
      let rates = await this.fetchFromMainBank();

      // フォールバック
      if (!rates || rates.length === 0) {
        log.warn('メインバンクAPI失敗、サブバンクへフォールバック');
        rates = await this.fetchFromSubBank();
      }

      if (!rates || rates.length === 0) {
        throw new BatchError('全APIからの取得に失敗', 'BAT-D001-E001');
      }

      // 2. レート妥当性チェック
      const validatedRates = await this.validateRates(rates);
      const warningRates = validatedRates.filter(r => r.hasWarning);

      if (warningRates.length > 0) {
        await this.sendWarningNotification(warningRates);
      }

      // 3. M_FX_RATEに登録
      const savedCount = await this.saveRates(validatedRates);

      // 4. 完了ログ
      log.info(`為替レート取込完了: ${savedCount}件`);

      return {
        status: 'SUCCESS',
        processedCount: savedCount,
        warningCount: warningRates.length
      };

    } catch (error) {
      log.error('為替レート取込エラー', error);
      await this.handleError(error, context);
      throw error;
    }
  }

  /**
   * レート妥当性チェック
   * 前日比±5%を超える場合は警告
   */
  private async validateRates(rates: FxRate[]): Promise<ValidatedFxRate[]> {
    const yesterday = await this.getYesterdayRates();
    const threshold = this.config.varianceThreshold / 100;

    return rates.map(rate => {
      const prevRate = yesterday.find(
        y => y.currencyPair === rate.currencyPair && y.rateType === rate.rateType
      );

      let hasWarning = false;
      let warningMessage: string | undefined;

      if (prevRate) {
        const variance = Math.abs(rate.rate - prevRate.rate) / prevRate.rate;
        if (variance > threshold) {
          hasWarning = true;
          warningMessage = `前日比 ${(variance * 100).toFixed(2)}% の変動`;
        }
      }

      return { ...rate, hasWarning, warningMessage };
    });
  }
}
```

**エラー処理**

| エラー種別 | エラーコード | 処理 | リトライ |
|------------|--------------|------|----------|
| メインAPI接続エラー | BAT-D001-E001 | サブAPIへフォールバック | 3回 |
| サブAPI接続エラー | BAT-D001-E002 | 前日レート仮適用、アラート | 3回 |
| レート異常値 | BAT-D001-W001 | 警告通知、処理継続 | - |
| DB更新エラー | BAT-D001-E003 | 処理中断、アラート | 1回 |

### 3.2 EB入出金取込（BAT-D002）

| 項目 | 内容 |
|------|------|
| バッチID | BAT-D002 |
| バッチ名 | EB入出金取込 |
| 実行タイミング | 毎日 06:30 |
| 処理概要 | 全銀EDI/API経由で銀行明細を取込み、入金・出金データを生成 |
| 入力 | 銀行API/全銀EDIファイル |
| 出力 | T_BANK_STATEMENT、T_RECEIPT（入金）、T_PAYMENT（出金） |
| 前提条件 | BAT-D001完了 |
| 後続処理 | BAT-D003、BAT-D01x/02x/03x |

**処理フロー**

```typescript
class EBImportBatch extends BaseBatch {
  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    log.info('EB入出金取込バッチ開始');

    const results: BankStatementImportResult[] = [];

    // 口座ごとに処理
    const accounts = await this.getBankAccounts();

    for (const account of accounts) {
      try {
        // 1. 明細取得
        const statements = await this.fetchStatements(account);
        log.info(`${account.bankName} ${account.accountNo}: ${statements.length}件取得`);

        // 2. 重複チェック（既存データとの照合）
        const newStatements = await this.filterDuplicates(statements);

        // 3. 入金/出金の分類
        for (const stmt of newStatements) {
          if (stmt.transactionType === 'CREDIT') {
            // 入金データ生成
            await this.createReceiptData(stmt);
          } else {
            // 出金データ生成（既存支払との照合）
            await this.matchPaymentData(stmt);
          }
        }

        // 4. 銀行明細テーブルに保存
        await this.saveBankStatements(newStatements);

        results.push({
          accountId: account.accountId,
          importedCount: newStatements.length,
          status: 'SUCCESS'
        });

      } catch (error) {
        log.error(`口座 ${account.accountNo} の処理エラー`, error);
        results.push({
          accountId: account.accountId,
          importedCount: 0,
          status: 'ERROR',
          errorMessage: error.message
        });
      }
    }

    // 5. サマリー作成
    const totalImported = results.reduce((sum, r) => sum + r.importedCount, 0);
    const errorCount = results.filter(r => r.status === 'ERROR').length;

    if (errorCount > 0) {
      await this.sendPartialErrorNotification(results);
    }

    return {
      status: errorCount === 0 ? 'SUCCESS' : 'PARTIAL',
      processedCount: totalImported,
      errorCount
    };
  }
}
```

### 3.3 自動仕訳生成（BAT-D050）

| 項目 | 内容 |
|------|------|
| バッチID | BAT-D050 |
| バッチ名 | 自動仕訳生成 |
| 実行タイミング | 毎日 10:00 |
| 処理概要 | 各種取込データから仕訳を自動生成 |
| 入力 | T_SALES_IMPORT、T_PURCHASE_IMPORT、T_RECEIPT、T_RENT_BILL、T_SECURITIES_TRADE等 |
| 出力 | T_JOURNAL_HEADER、T_JOURNAL_DETAIL |
| 前提条件 | BAT-D01x/02x/03x完了 |
| 後続処理 | BAT-D051（入金消込） |

**処理フロー**

```typescript
class AutoJournalBatch extends BaseBatch {
  private journalGenerator: JournalGeneratorService;

  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    log.info('自動仕訳生成バッチ開始');

    const targetDate = context.targetDate || new Date();
    let totalGenerated = 0;
    let errorCount = 0;

    // チェックポイントからの再開対応
    const checkpoint = await this.loadCheckpoint();
    const startPhase = checkpoint?.phase || 1;

    try {
      // Phase 1: 売上仕訳
      if (startPhase <= 1) {
        const salesResult = await this.generateSalesJournals(targetDate);
        totalGenerated += salesResult.count;
        await this.saveCheckpoint({ phase: 2, count: totalGenerated });
      }

      // Phase 2: 仕入仕訳
      if (startPhase <= 2) {
        const purchaseResult = await this.generatePurchaseJournals(targetDate);
        totalGenerated += purchaseResult.count;
        await this.saveCheckpoint({ phase: 3, count: totalGenerated });
      }

      // Phase 3: 入金仕訳
      if (startPhase <= 3) {
        const receiptResult = await this.generateReceiptJournals(targetDate);
        totalGenerated += receiptResult.count;
        await this.saveCheckpoint({ phase: 4, count: totalGenerated });
      }

      // Phase 4: 支払仕訳
      if (startPhase <= 4) {
        const paymentResult = await this.generatePaymentJournals(targetDate);
        totalGenerated += paymentResult.count;
        await this.saveCheckpoint({ phase: 5, count: totalGenerated });
      }

      // Phase 5: 賃料仕訳（不動産）
      if (startPhase <= 5) {
        const rentResult = await this.generateRentJournals(targetDate);
        totalGenerated += rentResult.count;
        await this.saveCheckpoint({ phase: 6, count: totalGenerated });
      }

      // Phase 6: 有価証券仕訳
      if (startPhase <= 6) {
        const secResult = await this.generateSecuritiesJournals(targetDate);
        totalGenerated += secResult.count;
        await this.saveCheckpoint({ phase: 7, count: totalGenerated });
      }

      // チェックポイントクリア
      await this.clearCheckpoint();

      log.info(`自動仕訳生成完了: ${totalGenerated}件`);

      return {
        status: 'SUCCESS',
        processedCount: totalGenerated,
        errorCount
      };

    } catch (error) {
      log.error('自動仕訳生成エラー', error);
      throw error;
    }
  }

  /**
   * 売上仕訳生成
   */
  private async generateSalesJournals(targetDate: Date): Promise<JournalGenerationResult> {
    const pendingSales = await this.salesRepository.findPendingJournals(targetDate);
    let count = 0;

    for (const sale of pendingSales) {
      try {
        const journal = await this.journalGenerator.generateJournal({
          journalType: 'AR_SALES',
          journalDate: sale.salesDate,
          sourceType: '02',  // AR
          sourceId: sale.salesId,
          lines: this.buildSalesJournalLines(sale)
        });

        // 売上データのジャーナルIDを更新
        await this.salesRepository.updateJournalId(sale.salesId, journal.journalId);
        count++;

      } catch (error) {
        this.log.warn(`売上 ${sale.salesId} の仕訳生成失敗`, error);
      }
    }

    return { count };
  }
}
```

### 3.4 減価償却計算（BAT-M001）

| 項目 | 内容 |
|------|------|
| バッチID | BAT-M001 |
| バッチ名 | 減価償却計算 |
| 実行タイミング | 月末+3営業日 |
| 処理概要 | 稼働中の全資産について月次償却費を計算し、仕訳を生成 |
| 入力 | T_FIXED_ASSET |
| 出力 | T_JOURNAL_HEADER/DETAIL、T_DEPRECIATION_HISTORY |
| 前提条件 | 当月の日次バッチ完了 |
| 後続処理 | BAT-M050（月次締め前チェック） |

**処理フロー**

```typescript
class DepreciationBatch extends BaseBatch {
  private depreciationEngine: DepreciationEngine;

  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    const fiscalPeriod = context.fiscalPeriod;  // YYYYMM

    log.info(`減価償却計算バッチ開始: ${fiscalPeriod}`);

    // 1. 対象資産の抽出
    const assets = await this.assetRepository.findActiveAssets({
      status: 'ACTIVE',
      bookValueGreaterThan: 1  // 残存価額超
    });

    log.info(`対象資産: ${assets.length}件`);

    let processedCount = 0;
    let totalAccDepreciation = new Decimal(0);
    let totalTaxDepreciation = new Decimal(0);
    const errors: DepreciationError[] = [];

    // 2. 資産ごとに償却計算
    for (const asset of assets) {
      try {
        // 会計上の償却計算
        const accResult = this.depreciationEngine.calculateMonthlyDepreciation({
          assetId: asset.assetId,
          method: asset.accDepreciationMethod,
          acquisitionCost: asset.acquisitionCost,
          residualValue: asset.accResidualValue,
          usefulLifeMonths: asset.accUsefulLifeMonths,
          serviceStartDate: asset.serviceStartDate,
          calculationDate: new Date(fiscalPeriod.slice(0, 4) + '-' + fiscalPeriod.slice(4) + '-01'),
          accumulatedDepreciation: asset.accAccumDepreciation,
          bookValue: asset.accBookValue
        });

        // 税務上の償却計算
        const taxResult = this.depreciationEngine.calculateMonthlyDepreciation({
          assetId: asset.assetId,
          method: asset.taxDepreciationMethod,
          acquisitionCost: asset.acquisitionCost,
          residualValue: asset.taxResidualValue,
          usefulLifeMonths: asset.taxUsefulLifeMonths,
          serviceStartDate: asset.serviceStartDate,
          calculationDate: new Date(fiscalPeriod.slice(0, 4) + '-' + fiscalPeriod.slice(4) + '-01'),
          accumulatedDepreciation: asset.taxAccumDepreciation,
          bookValue: asset.taxBookValue,
          depreciationRate: asset.taxDepreciationRate,
          guaranteeAmount: asset.taxGuaranteeAmount
        });

        // 3. 資産台帳更新
        await this.assetRepository.updateDepreciation(asset.assetId, {
          accAccumDepreciation: accResult.newAccumulatedDepreciation,
          accBookValue: accResult.newBookValue,
          taxAccumDepreciation: taxResult.newAccumulatedDepreciation,
          taxBookValue: taxResult.newBookValue
        });

        // 4. 償却履歴記録
        await this.depreciationHistoryRepository.save({
          assetId: asset.assetId,
          fiscalPeriod,
          accDepreciation: accResult.monthlyDepreciation,
          accAccumDepreciation: accResult.newAccumulatedDepreciation,
          accBookValue: accResult.newBookValue,
          taxDepreciation: taxResult.monthlyDepreciation,
          taxAccumDepreciation: taxResult.newAccumulatedDepreciation,
          taxBookValue: taxResult.newBookValue,
          differenceAmount: accResult.monthlyDepreciation.minus(taxResult.monthlyDepreciation)
        });

        totalAccDepreciation = totalAccDepreciation.plus(accResult.monthlyDepreciation);
        totalTaxDepreciation = totalTaxDepreciation.plus(taxResult.monthlyDepreciation);
        processedCount++;

      } catch (error) {
        log.warn(`資産 ${asset.assetId} の償却計算エラー`, error);
        errors.push({ assetId: asset.assetId, error: error.message });
      }
    }

    // 5. 償却仕訳の一括生成（科目・部門別に集約）
    const journals = await this.generateDepreciationJournals(fiscalPeriod);

    log.info(`減価償却計算完了: ${processedCount}件, 会計償却: ${totalAccDepreciation}, 税務償却: ${totalTaxDepreciation}`);

    if (errors.length > 0) {
      await this.sendErrorReport(errors);
    }

    return {
      status: errors.length === 0 ? 'SUCCESS' : 'PARTIAL',
      processedCount,
      errorCount: errors.length,
      details: {
        totalAccDepreciation: totalAccDepreciation.toString(),
        totalTaxDepreciation: totalTaxDepreciation.toString(),
        journalCount: journals.length
      }
    };
  }
}
```

### 3.5 月次締め処理（BAT-M051）

| 項目 | 内容 |
|------|------|
| バッチID | BAT-M051 |
| バッチ名 | 月次締め処理 |
| 実行タイミング | 月末+5営業日（手動起動可） |
| 処理概要 | 対象月の仕訳を確定し、残高を更新 |
| 入力 | T_JOURNAL_HEADER/DETAIL |
| 出力 | T_ACCOUNT_BALANCE、M_PERIOD_STATUS |
| 前提条件 | BAT-M050（締め前チェック）OK |
| 後続処理 | BAT-M060（帳票出力） |

**処理フロー**

```typescript
class MonthlyCloseBatch extends BaseBatch {
  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    const fiscalPeriod = context.fiscalPeriod;

    log.info(`月次締め処理開始: ${fiscalPeriod}`);

    // トランザクション開始
    const transaction = await this.db.beginTransaction();

    try {
      // 1. 前提条件チェック（再確認）
      const preCheck = await this.runPreClosingCheck(fiscalPeriod);
      if (!preCheck.passed) {
        throw new BatchError(`前提条件エラー: ${preCheck.errors.join(', ')}`, 'BAT-M051-E001');
      }

      // 2. 未承認仕訳の確認
      const unapprovedCount = await this.journalRepository.countUnapproved(fiscalPeriod);
      if (unapprovedCount > 0) {
        throw new BatchError(`未承認仕訳が ${unapprovedCount} 件あります`, 'BAT-M051-E002');
      }

      // 3. 仕訳データの集計
      log.info('仕訳集計開始');
      const aggregation = await this.aggregateJournals(fiscalPeriod);

      // 4. 残高テーブル更新
      log.info('残高更新開始');
      await this.updateAccountBalances(fiscalPeriod, aggregation, transaction);

      // 5. 貸借一致検証
      const balanceCheck = await this.verifyTrialBalance(fiscalPeriod);
      if (!balanceCheck.balanced) {
        await transaction.rollback();
        throw new BatchError(
          `貸借不一致: 借方=${balanceCheck.debitTotal}, 貸方=${balanceCheck.creditTotal}`,
          'BAT-M051-E003'
        );
      }

      // 6. 期間ステータス更新（締め済み）
      await this.periodStatusRepository.updateStatus(fiscalPeriod, 'CLOSED', transaction);

      // 7. コミット
      await transaction.commit();

      log.info(`月次締め処理完了: ${fiscalPeriod}`);

      return {
        status: 'SUCCESS',
        processedCount: aggregation.journalCount,
        details: {
          debitTotal: balanceCheck.debitTotal.toString(),
          creditTotal: balanceCheck.creditTotal.toString()
        }
      };

    } catch (error) {
      await transaction.rollback();
      log.error('月次締め処理エラー', error);
      throw error;
    }
  }

  /**
   * 締め前チェック
   */
  private async runPreClosingCheck(fiscalPeriod: string): Promise<PreClosingCheckResult> {
    const errors: string[] = [];

    // 必須バッチの完了確認
    const requiredBatches = ['BAT-M001', 'BAT-M002', 'BAT-M003', 'BAT-M050'];
    for (const batchId of requiredBatches) {
      const status = await this.batchLogRepository.getLatestStatus(batchId, fiscalPeriod);
      if (status !== 'SUCCESS') {
        errors.push(`${batchId} が未完了または失敗`);
      }
    }

    // 前月の締め確認
    const prevPeriod = this.getPreviousPeriod(fiscalPeriod);
    const prevStatus = await this.periodStatusRepository.getStatus(prevPeriod);
    if (prevStatus !== 'CLOSED') {
      errors.push(`前月 ${prevPeriod} が未締め`);
    }

    return {
      passed: errors.length === 0,
      errors
    };
  }
}
```

---

## 4. 障害時対応

### 4.1 リカバリ方針

| 障害種別 | リカバリ方法 | 所要時間 | 承認要否 |
|----------|--------------|----------|----------|
| 処理途中でのエラー | チェックポイントからリスタート | 15分 | 不要 |
| DB障害 | DBリカバリ後、バッチ再実行 | 1-2時間 | 要 |
| 外部IF障害 | 手動データ投入後、バッチ再実行 | 状況依存 | 要 |
| サーバー障害 | DR環境での実行 | 2-4時間 | 要 |
| 月次締め後のエラー発見 | 締め解除→修正→再締め | 1-2時間 | 要（経理部長） |

### 4.2 チェックポイント機構

```typescript
// ============================================================
// チェックポイント機構
// ============================================================

interface BatchCheckpoint {
  batchId: string;
  executionId: string;
  phase: number;
  lastProcessedKey: string;
  processedCount: number;
  savedAt: Date;
  additionalData?: Record<string, any>;
}

class CheckpointManager {
  private redisClient: RedisClient;

  /**
   * チェックポイント保存
   */
  async saveCheckpoint(checkpoint: BatchCheckpoint): Promise<void> {
    const key = `checkpoint:${checkpoint.batchId}:${checkpoint.executionId}`;
    await this.redisClient.set(key, JSON.stringify(checkpoint));
    await this.redisClient.expire(key, 86400 * 7);  // 7日間保持
  }

  /**
   * チェックポイント読込
   */
  async loadCheckpoint(batchId: string, executionId: string): Promise<BatchCheckpoint | null> {
    const key = `checkpoint:${batchId}:${executionId}`;
    const data = await this.redisClient.get(key);
    return data ? JSON.parse(data) : null;
  }

  /**
   * チェックポイント削除
   */
  async clearCheckpoint(batchId: string, executionId: string): Promise<void> {
    const key = `checkpoint:${batchId}:${executionId}`;
    await this.redisClient.del(key);
  }
}

/**
 * チェックポイント対応バッチ基底クラス
 */
abstract class CheckpointBatch extends BaseBatch {
  protected checkpointManager: CheckpointManager;
  protected checkpointInterval: number = 100;  // デフォルト100件ごと

  protected async processWithCheckpoint<T>(
    items: T[],
    processor: (item: T, index: number) => Promise<void>,
    getKey: (item: T) => string
  ): Promise<number> {
    const checkpoint = await this.checkpointManager.loadCheckpoint(
      this.batchId,
      this.executionId
    );

    const startIndex = checkpoint ? checkpoint.processedCount : 0;
    let processedCount = startIndex;

    for (let i = startIndex; i < items.length; i++) {
      try {
        await processor(items[i], i);
        processedCount++;

        // チェックポイント保存
        if (processedCount % this.checkpointInterval === 0) {
          await this.checkpointManager.saveCheckpoint({
            batchId: this.batchId,
            executionId: this.executionId,
            phase: 1,
            lastProcessedKey: getKey(items[i]),
            processedCount,
            savedAt: new Date()
          });
        }

      } catch (error) {
        // エラー発生時もチェックポイント保存
        await this.checkpointManager.saveCheckpoint({
          batchId: this.batchId,
          executionId: this.executionId,
          phase: 1,
          lastProcessedKey: getKey(items[i - 1]),
          processedCount,
          savedAt: new Date(),
          additionalData: { error: error.message }
        });
        throw error;
      }
    }

    // 正常完了時はチェックポイント削除
    await this.checkpointManager.clearCheckpoint(this.batchId, this.executionId);

    return processedCount;
  }
}
```

### 4.3 月次締め解除（ロールバック）

```typescript
// ============================================================
// 月次締め解除バッチ（BAT-O010）
// ============================================================

class MonthlyCloseRollbackBatch extends BaseBatch {
  async execute(context: BatchContext): Promise<BatchResult> {
    const log = this.createLogger(context);
    const fiscalPeriod = context.fiscalPeriod;
    const reason = context.params.reason;
    const approvedBy = context.params.approvedBy;

    log.info(`月次締め解除開始: ${fiscalPeriod}, 理由: ${reason}`);

    // 1. 権限チェック
    if (!await this.authService.hasPermission(approvedBy, 'MONTHLY_CLOSE_ROLLBACK')) {
      throw new BatchError('締め解除の権限がありません', 'BAT-O010-E001');
    }

    // 2. 後続締めの確認
    const nextPeriod = this.getNextPeriod(fiscalPeriod);
    const nextStatus = await this.periodStatusRepository.getStatus(nextPeriod);
    if (nextStatus === 'CLOSED') {
      throw new BatchError(
        `後続期間 ${nextPeriod} が締め済みのため解除できません`,
        'BAT-O010-E002'
      );
    }

    // トランザクション開始
    const transaction = await this.db.beginTransaction();

    try {
      // 3. 期間ステータスを「オープン」に変更
      await this.periodStatusRepository.updateStatus(fiscalPeriod, 'OPEN', transaction);

      // 4. 残高テーブルの確定フラグを解除
      await this.accountBalanceRepository.unconfirmPeriod(fiscalPeriod, transaction);

      // 5. 監査ログ記録
      await this.auditLogger.log({
        action: 'MONTHLY_CLOSE_ROLLBACK',
        documentId: fiscalPeriod,
        details: {
          reason,
          approvedBy,
          rollbackAt: new Date()
        }
      }, transaction);

      // 6. コミット
      await transaction.commit();

      // 7. 関係者へ通知
      await this.notificationService.send({
        type: 'MONTHLY_CLOSE_ROLLBACK',
        recipients: ['accounting-team', 'audit-team'],
        data: { fiscalPeriod, reason, approvedBy }
      });

      log.info(`月次締め解除完了: ${fiscalPeriod}`);

      return {
        status: 'SUCCESS',
        details: { fiscalPeriod, reason, approvedBy }
      };

    } catch (error) {
      await transaction.rollback();
      log.error('月次締め解除エラー', error);
      throw error;
    }
  }
}
```

---

## 5. ジョブスケジューラ設定

### 5.1 スケジュール定義（YAML形式）

```yaml
# ============================================================
# 会計システム バッチスケジュール定義
# ============================================================

# 日次ジョブネット
jobNets:
  JN-DAILY:
    description: "日次バッチ処理"
    schedule:
      type: cron
      expression: "0 6 * * *"  # 毎日6:00
    timezone: "Asia/Tokyo"
    timeout: 21600  # 6時間
    alertOnStart: false
    alertOnComplete: false
    alertOnError: true

    jobs:
      - id: BAT-D001
        name: 為替レート取込
        class: FxRateImportBatch
        timeout: 600
        retry:
          maxAttempts: 3
          backoffSeconds: 60
        onError: continue  # エラーでも後続実行（警告は出す）

      - id: BAT-D002
        name: EB入出金取込
        class: EBImportBatch
        dependsOn: [BAT-D001]
        timeout: 1800
        retry:
          maxAttempts: 2
          backoffSeconds: 120
        onError: stop

      - id: BAT-D003
        name: インボイス番号検証
        class: InvoiceVerificationBatch
        dependsOn: [BAT-D002]
        timeout: 900
        retry:
          maxAttempts: 2
          backoffSeconds: 60

      - id: BAT-D010
        name: 売上データ取込
        class: SalesImportBatch
        dependsOn: [BAT-D003]
        timeout: 3600
        parallelWith: [BAT-D011, BAT-D020, BAT-D030]

      - id: BAT-D011
        name: 仕入データ取込
        class: PurchaseImportBatch
        dependsOn: [BAT-D003]
        timeout: 3600
        parallelWith: [BAT-D010, BAT-D020, BAT-D030]

      - id: BAT-D020
        name: 賃料請求生成
        class: RentBillingBatch
        dependsOn: [BAT-D003]
        timeout: 1800
        parallelWith: [BAT-D010, BAT-D011, BAT-D030]
        condition: "company.industryType == 'PROPERTY'"

      - id: BAT-D021
        name: 賃料入金照合
        class: RentReceiptMatchBatch
        dependsOn: [BAT-D020]
        timeout: 1800
        condition: "company.industryType == 'PROPERTY'"

      - id: BAT-D030
        name: 約定取込
        class: SecuritiesTradeImportBatch
        dependsOn: [BAT-D003]
        timeout: 1200
        parallelWith: [BAT-D010, BAT-D011, BAT-D020]
        condition: "company.industryType == 'SECURITIES'"

      - id: BAT-D031
        name: 配当・利金取込
        class: DividendInterestImportBatch
        dependsOn: [BAT-D030]
        timeout: 900
        condition: "company.industryType == 'SECURITIES'"

      - id: BAT-D050
        name: 自動仕訳生成
        class: AutoJournalBatch
        dependsOn: [BAT-D010, BAT-D011, BAT-D021, BAT-D031]
        waitForAll: true
        timeout: 2700
        retry:
          maxAttempts: 1
          backoffSeconds: 300

      - id: BAT-D051
        name: 入金自動消込
        class: AutoClearingBatch
        dependsOn: [BAT-D050]
        timeout: 1800

      - id: BAT-D052
        name: 銀行照合
        class: BankReconciliationBatch
        dependsOn: [BAT-D051]
        timeout: 1200

      - id: BAT-D090
        name: 日次集計チェック
        class: DailyCheckBatch
        dependsOn: [BAT-D052]
        timeout: 1800

  # 夜間ジョブ
  JN-NIGHTLY:
    description: "夜間バッチ処理"
    schedule:
      type: cron
      expression: "0 23 * * *"  # 毎日23:00
    timezone: "Asia/Tokyo"

    jobs:
      - id: BAT-D091
        name: 監査ログハッシュ生成
        class: AuditLogHashBatch
        timeout: 900

  # 月次締めジョブネット
  JN-MONTHLY-CLOSE:
    description: "月次締め処理"
    schedule:
      type: manual  # 手動起動
    timeout: 43200  # 12時間
    alertOnStart: true
    alertOnComplete: true
    alertOnError: true

    jobs:
      - id: BAT-M001
        name: 減価償却計算
        class: DepreciationBatch
        timeout: 3600
        parallelWith: [BAT-M002, BAT-M003]

      - id: BAT-M002
        name: 為替換算差額計算
        class: FxRevaluationBatch
        timeout: 1800
        parallelWith: [BAT-M001, BAT-M003]

      - id: BAT-M003
        name: 経過勘定計上
        class: AccrualBatch
        timeout: 1800
        parallelWith: [BAT-M001, BAT-M002]

      - id: BAT-M010
        name: 有価証券時価評価
        class: SecuritiesValuationBatch
        dependsOn: [BAT-M001, BAT-M002, BAT-M003]
        waitForAll: true
        timeout: 2700
        condition: "company.industryType == 'SECURITIES'"
        parallelWith: [BAT-M020]

      - id: BAT-M020
        name: 物件収支集計
        class: PropertyPLBatch
        dependsOn: [BAT-M001, BAT-M002, BAT-M003]
        waitForAll: true
        timeout: 1800
        condition: "company.industryType == 'PROPERTY'"
        parallelWith: [BAT-M010]

      - id: BAT-M050
        name: 締め前チェック
        class: PreClosingCheckBatch
        dependsOn: [BAT-M010, BAT-M020]
        waitForAll: true
        timeout: 1800

      - id: BAT-M051
        name: 月次締め処理
        class: MonthlyCloseBatch
        dependsOn: [BAT-M050]
        timeout: 7200
        retry:
          maxAttempts: 0  # リトライ不可

      - id: BAT-M060
        name: 帳票一括出力
        class: ReportGenerationBatch
        dependsOn: [BAT-M051]
        timeout: 3600
        parallelWith: [BAT-M061]

      - id: BAT-M061
        name: 消費税集計
        class: ConsumptionTaxBatch
        dependsOn: [BAT-M051]
        timeout: 1800
        parallelWith: [BAT-M060]

  # 年次決算ジョブネット
  JN-YEARLY-CLOSE:
    description: "年次決算処理"
    schedule:
      type: manual
    timeout: 86400  # 24時間
    alertOnStart: true
    alertOnComplete: true
    alertOnError: true

    jobs:
      - id: BAT-Y001
        name: 年次決算締め
        class: YearlyCloseBatch
        timeout: 14400

      - id: BAT-Y002
        name: 繰越処理
        class: CarryForwardBatch
        dependsOn: [BAT-Y001]
        timeout: 5400

      - id: BAT-Y003
        name: 法人税申告データ生成
        class: CorporateTaxDataBatch
        dependsOn: [BAT-Y002]
        timeout: 3600
        parallelWith: [BAT-Y004]

      - id: BAT-Y004
        name: 消費税申告データ生成
        class: ConsumptionTaxDataBatch
        dependsOn: [BAT-Y002]
        timeout: 2700
        parallelWith: [BAT-Y003]
```

---

## 6. 監視・ログ

### 6.1 ログ出力仕様

| ログ種別 | 出力先 | 出力内容 | 保管期間 |
|----------|--------|----------|----------|
| 実行ログ | CloudWatch/ファイル | 開始/終了時刻、処理件数、ステータス | 3ヶ月 |
| エラーログ | CloudWatch/ファイル | エラー内容、スタックトレース | 1年 |
| 性能ログ | CloudWatch Metrics | 処理時間、リソース使用状況 | 1ヶ月 |
| 監査ログ | T_AUDIT_LOG | データ変更内容（ハッシュチェーン付き） | 10年 |
| 業務ログ | T_BATCH_LOG | バッチ実行結果サマリー | 7年 |

### 6.2 監視項目

| 監視項目 | 閾値 | アラートレベル | アクション |
|----------|------|----------------|------------|
| 実行時間 | 想定の150% | Warning | Slack通知 |
| 実行時間 | 想定の200% | Critical | 電話連絡、強制終了検討 |
| エラー率 | 1%以上 | Warning | Slack通知 |
| エラー率 | 5%以上 | Critical | 処理中断、電話連絡 |
| バッチ異常終了 | - | Critical | 電話連絡、インシデント起票 |
| スケジュール遅延 | 30分以上 | Warning | Slack通知 |
| 後続バッチへの影響 | - | Critical | 関係者エスカレーション |

### 6.3 アラート通知先

| アラートレベル | 通知先 | 通知方法 |
|----------------|--------|----------|
| Info | 運用チーム | Slack |
| Warning | 運用チーム、IT部 | Slack、メール |
| Critical | 運用チーム、IT部、経理部 | Slack、メール、電話 |

---

## 7. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2025/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] 全てのバッチ処理が一覧化されているか
- [ ] ジョブの依存関係が正しく定義されているか
- [ ] 並列実行可能なジョブが特定されているか
- [ ] 業種別（IT/コンサル、不動産、有価証券）のバッチが網羅されているか
- [ ] 処理時間の見積もりが妥当か
- [ ] エラー処理とリカバリ方法が定義されているか
- [ ] チェックポイントによるリスタートが可能か
- [ ] アラート通知先が適切か
- [ ] 月次締め/年次締めのロールバック手順があるか
- [ ] インボイス制度対応バッチが含まれているか
- [ ] 電帳法対応（タイムスタンプ、監査ログ）バッチが含まれているか
- [ ] J-SOX統制要件を満たしているか
- [ ] 運用チームのレビューを受けているか
