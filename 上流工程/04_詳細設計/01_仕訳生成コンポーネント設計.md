# 仕訳生成コンポーネント設計

| 項目 | 内容 |
|------|------|
| 文書番号 | DET-JNL-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2026/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. コンポーネント概要

### 1.1 目的

| 項目 | 内容 |
|------|------|
| 目的 | 取引イベント/伝票から仕訳を自動生成し、GLに計上する |
| 入力 | 取引イベント、伝票データ、マスタ情報、仕訳ルール |
| 出力 | 仕訳ヘッダ、仕訳明細、勘定残高更新 |
| 呼び出し元 | AR/AP/FA/Property/Securities/外部連携/手動入力画面/バッチ処理 |
| 呼び出し先 | マスタ参照サービス、仕訳登録サービス、残高更新サービス |

### 1.2 処理フロー概要

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         仕訳生成コンポーネント                                   │
│                                                                                 │
│  [入力]              [処理]                                    [出力]           │
│                                                                                 │
│  取引イベント        ┌────────────────────┐                                    │
│  /伝票データ ───────→│①入力バリデーション│                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│  仕訳ルール         ┌────────────────────┐                                    │
│  マスタ ───────────→│②仕訳パターン決定  │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│  勘定科目           ┌────────────────────┐                                    │
│  マスタ ───────────→│③勘定科目決定      │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│  税コード           ┌────────────────────┐                                    │
│  マスタ ───────────→│④税コード決定      │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│  セグメント         ┌────────────────────┐                                    │
│  マスタ ───────────→│⑤分析軸設定        │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│  為替レート         ┌────────────────────┐                                    │
│  マスタ ───────────→│⑥金額計算・換算    │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│                      ┌────────────────────┐                                    │
│                      │⑦貸借一致検証      │                                    │
│                      └─────────┬──────────┘                                    │
│                                ▼                                               │
│                      ┌────────────────────┐       ┌─────────────────────┐     │
│                      │⑧仕訳データ生成    │──────→│仕訳ヘッダ/明細     │     │
│                      └─────────┬──────────┘       └─────────────────────┘     │
│                                ▼                                               │
│                      ┌────────────────────┐       ┌─────────────────────┐     │
│                      │⑨仕訳登録          │──────→│T_JOURNAL_HEADER    │     │
│                      └─────────┬──────────┘       │T_JOURNAL_LINE      │     │
│                                ▼                  └─────────────────────┘     │
│                      ┌────────────────────┐       ┌─────────────────────┐     │
│                      │⑩残高更新（承認後）│──────→│T_ACCOUNT_BALANCE   │     │
│                      └────────────────────┘       └─────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 入力仕様

### 2.1 入力データ構造

```typescript
/**
 * 仕訳生成リクエスト
 */
interface JournalGenerationRequest {
  // ===== ヘッダ情報 =====
  /** 会社コード（必須）4桁 */
  companyCode: string;

  /** 取引日（必須）*/
  transactionDate: Date;

  /** 伝票区分（必須）01:通常 02:調整 03:決算 */
  journalType: JournalType;

  /** 摘要（任意）最大200文字 */
  description?: string;

  /** 通貨コード（必須）デフォルト:JPY */
  currencyCode: string;

  /** 為替レート（外貨時必須）*/
  fxRate?: number;

  /** レート種別（外貨時）TTM/TTB/TTS/SPOT */
  rateType?: RateType;

  /** レート日付（外貨時）*/
  rateDate?: Date;

  /** 発生元モジュール（必須）*/
  sourceModule: SourceModule;

  /** 発生元伝票種別（任意）*/
  sourceDocType?: string;

  /** 発生元伝票ID（任意）*/
  sourceDocId?: string;

  // ===== 明細情報 =====
  /** 仕訳明細（必須）1件以上 */
  lines: JournalLineInput[];

  // ===== 証憑情報 =====
  /** 証憑ID（任意）*/
  documentIds?: string[];
}

/**
 * 仕訳明細入力
 */
interface JournalLineInput {
  /** 借方/貸方（必須）*/
  drCr: DrCr;

  /** 勘定科目コード（必須）7桁 */
  accountCode: string;

  /** 補助科目コード（条件必須）得意先/仕入先コード等 */
  subAccountCode?: string;

  /** 補助科目種別（補助科目がある場合）CU:得意先 VE:仕入先 */
  subAccountType?: SubAccountType;

  /** 取引金額・原通貨（必須）*/
  amountTransaction: number;

  /** 税コード（条件必須）課税科目の場合 */
  taxCode?: string;

  /** 税額（任意）自動計算可、手動指定も可 */
  taxAmount?: number;

  /** インボイス登録番号（仕入時）T+13桁 */
  invoiceRegNumber?: string;

  /** 利益センター（条件必須）*/
  profitCenter?: string;

  /** コストセンター（条件必須）*/
  costCenter?: string;

  /** プロジェクトコード（任意）*/
  projectCode?: string;

  /** 物件コード（不動産関連時）*/
  propertyCode?: string;

  /** ポートフォリオコード（有価証券関連時）*/
  portfolioCode?: string;

  /** 明細摘要（任意）最大100文字 */
  lineDescription?: string;
}

/**
 * 列挙型定義
 */
enum JournalType {
  NORMAL = '01',      // 通常仕訳
  ADJUSTMENT = '02',  // 調整仕訳
  CLOSING = '03',     // 決算仕訳
  REVERSAL = '04'     // 取消仕訳
}

enum SourceModule {
  GL = 'GL',          // 総勘定元帳（手動入力）
  AR = 'AR',          // 売掛金
  AP = 'AP',          // 買掛金
  FA = 'FA',          // 固定資産
  PR = 'PR',          // 不動産
  SC = 'SC',          // 有価証券
  TX = 'TX',          // 税務
  EX = 'EX',          // 外部連携
  BT = 'BT'           // バッチ処理
}

enum DrCr {
  DR = 'DR',  // 借方
  CR = 'CR'   // 貸方
}

enum RateType {
  TTM = 'TTM',    // 電信仲値
  TTB = 'TTB',    // 電信買相場
  TTS = 'TTS',    // 電信売相場
  SPOT = 'SPOT',  // スポットレート
  M_END = 'M_END' // 月末レート
}

enum SubAccountType {
  CU = 'CU',  // 得意先
  VE = 'VE',  // 仕入先
  BA = 'BA',  // 銀行口座
  EM = 'EM',  // 従業員
  AS = 'AS'   // 資産
}
```

### 2.2 発生元別入力パターン

| 発生元 | 主な伝票種別 | 自動設定項目 | 備考 |
|--------|-------------|-------------|------|
| AR | 請求書、入金 | 得意先、売掛金科目 | 請求書番号から自動取得 |
| AP | 請求書、支払 | 仕入先、買掛金科目、インボイス番号 | 請求書番号から自動取得 |
| FA | 取得、償却、除却 | 資産番号、固定資産科目 | 資産番号から自動取得 |
| PR | 賃料、敷金 | 物件コード、テナント | 契約番号から自動取得 |
| SC | 売買、評価、配当 | 銘柄、保有区分 | 取引番号から自動取得 |
| GL | 手動入力 | - | 全項目手動入力 |
| BT | 月次処理 | 処理種別に応じて自動 | バッチパラメータから |

### 2.3 入力バリデーション

#### 必須チェック

| No | 項目 | チェック内容 | エラーコード |
|----|------|--------------|--------------|
| V01 | 会社コード | 必須、4桁 | E001 |
| V02 | 取引日 | 必須、日付形式 | E002 |
| V03 | 伝票区分 | 必須、有効な値 | E003 |
| V04 | 通貨コード | 必須、3桁 | E004 |
| V05 | 発生元モジュール | 必須、有効な値 | E005 |
| V06 | 明細 | 1件以上必須 | E006 |
| V07 | 明細.借貸区分 | 必須、DR/CR | E007 |
| V08 | 明細.勘定科目 | 必須、7桁 | E008 |
| V09 | 明細.金額 | 必須、正の数 | E009 |

#### 整合性チェック

| No | 項目 | チェック内容 | エラーコード |
|----|------|--------------|--------------|
| C01 | 会社コード | マスタ存在、有効期間内 | E101 |
| C02 | 取引日 | 締め済み期間でないこと | E102 |
| C03 | 取引日 | 未来日付でないこと（決算仕訳除く） | E103 |
| C04 | 通貨コード | マスタ存在 | E104 |
| C05 | 為替レート | 外貨の場合は必須 | E105 |
| C06 | 為替レート | 妥当な範囲（前日比±10%） | E106 |
| C07 | 勘定科目 | マスタ存在、有効期間内 | E107 |
| C08 | 税コード | 課税科目の場合は必須 | E108 |
| C09 | 税コード | マスタ存在、有効期間内 | E109 |
| C10 | 補助科目 | 必須フラグ=1の科目の場合は必須 | E110 |
| C11 | 利益センター | P/L科目の場合は必須 | E111 |
| C12 | コストセンター | 費用科目の場合は必須 | E112 |
| C13 | インボイス番号 | 課税仕入れの場合は必須（経過措置除く） | E113 |
| C14 | インボイス番号 | T+13桁数字形式 | E114 |
| C15 | 物件コード | 物件必須科目の場合は必須 | E115 |
| C16 | ポートフォリオ | PF必須科目の場合は必須 | E116 |

---

## 3. 処理ロジック

### 3.1 仕訳パターン決定ロジック

```typescript
/**
 * 仕訳パターン決定
 * 発生元と伝票種別から適用する仕訳ルールを特定
 */
class JournalPatternResolver {

  constructor(
    private postingRuleRepository: PostingRuleRepository
  ) {}

  /**
   * 仕訳パターンを決定
   */
  async resolve(request: JournalGenerationRequest): Promise<PostingRule[]> {
    // 1. 発生元モジュールと伝票種別から仕訳ルールを検索
    const rules = await this.postingRuleRepository.findBySource(
      request.sourceModule,
      request.sourceDocType
    );

    if (rules.length === 0) {
      // ルールが見つからない場合は手動入力モード
      return [];
    }

    // 2. 有効期間でフィルタリング
    const validRules = rules.filter(rule =>
      this.isValidOnDate(rule, request.transactionDate)
    );

    // 3. 優先度順にソート
    return validRules.sort((a, b) => a.priority - b.priority);
  }

  private isValidOnDate(rule: PostingRule, date: Date): boolean {
    return rule.validFrom <= date && rule.validTo >= date;
  }
}
```

### 3.2 勘定科目決定ロジック

```typescript
/**
 * 勘定科目決定ロジック
 */
class AccountDeterminer {

  constructor(
    private accountRepository: AccountRepository,
    private postingRuleRepository: PostingRuleRepository
  ) {}

  /**
   * 勘定科目を決定
   */
  async determine(
    lineInput: JournalLineInput,
    postingRule: PostingRule | null,
    transactionDate: Date,
    companyCode: string
  ): Promise<Account> {

    let accountCode: string;

    // 1. 明示的に科目コードが指定されている場合
    if (lineInput.accountCode) {
      accountCode = lineInput.accountCode;
    }
    // 2. 仕訳ルールから科目を決定
    else if (postingRule) {
      accountCode = this.getAccountFromRule(postingRule, lineInput);
    }
    else {
      throw new ValidationError('E008', '勘定科目コードが必要です');
    }

    // 3. 科目マスタを取得
    const account = await this.accountRepository.findByCode(
      companyCode,
      accountCode
    );

    if (!account) {
      throw new ValidationError('E107', `無効な勘定科目です: ${accountCode}`);
    }

    // 4. 有効期間チェック
    if (!this.isValidOnDate(account, transactionDate)) {
      throw new ValidationError('E107', `科目が有効期間外です: ${accountCode}`);
    }

    // 5. 補助科目の必須チェック
    if (account.subAccountRequired === '1' && !lineInput.subAccountCode) {
      throw new ValidationError('E110', `補助科目が必須です: ${account.accountNameJp}`);
    }

    return account;
  }

  private getAccountFromRule(rule: PostingRule, lineInput: JournalLineInput): string {
    // 仕訳ルールの借貸区分に応じて科目を取得
    if (lineInput.drCr === DrCr.DR) {
      return rule.debitAccountCode;
    } else {
      return rule.creditAccountCode;
    }
  }

  private isValidOnDate(account: Account, date: Date): boolean {
    return account.validFrom <= date && account.validTo >= date;
  }
}
```

### 3.3 税コード決定ロジック

```typescript
/**
 * 税コード決定ロジック（インボイス制度対応）
 */
class TaxCodeDeterminer {

  constructor(
    private taxCodeRepository: TaxCodeRepository,
    private vendorRepository: VendorRepository,
    private invoiceVerifier: InvoiceVerifier
  ) {}

  /**
   * 税コードを決定
   */
  async determine(
    lineInput: JournalLineInput,
    account: Account,
    transactionDate: Date
  ): Promise<TaxCode | null> {

    // 1. 税区分対象外の科目の場合
    if (account.taxApplicable === '0') {
      return null;
    }

    // 2. 明示的に税コードが指定されている場合
    if (lineInput.taxCode) {
      return await this.validateAndGetTaxCode(lineInput.taxCode, transactionDate);
    }

    // 3. 自動判定
    return await this.autoDetectTaxCode(lineInput, account, transactionDate);
  }

  /**
   * 税コードの自動判定
   */
  private async autoDetectTaxCode(
    lineInput: JournalLineInput,
    account: Account,
    transactionDate: Date
  ): Promise<TaxCode> {

    // 仕入（借方・費用/資産科目）の場合
    if (lineInput.drCr === DrCr.DR && this.isPurchaseAccount(account)) {
      return await this.determinePurchaseTaxCode(lineInput, transactionDate);
    }

    // 売上（貸方・収益科目）の場合
    if (lineInput.drCr === DrCr.CR && this.isSalesAccount(account)) {
      return await this.determineSalesTaxCode(account, transactionDate);
    }

    // それ以外は税コード必須チェック
    if (account.taxApplicable === '1') {
      throw new ValidationError('E108', '税コードを選択してください');
    }

    return null;
  }

  /**
   * 課税仕入れの税コード決定（インボイス制度対応）
   */
  private async determinePurchaseTaxCode(
    lineInput: JournalLineInput,
    transactionDate: Date
  ): Promise<TaxCode> {

    // インボイス登録番号がある場合
    if (lineInput.invoiceRegNumber) {
      // 登録番号の検証
      const isValid = await this.invoiceVerifier.verify(lineInput.invoiceRegNumber);

      if (isValid) {
        // 適格請求書発行事業者からの仕入れ → 100%控除
        return await this.getTaxCode('P10', transactionDate);  // 課税仕入10%
      }
    }

    // 仕入先マスタから登録番号を確認
    if (lineInput.subAccountCode && lineInput.subAccountType === SubAccountType.VE) {
      const vendor = await this.vendorRepository.findByCode(lineInput.subAccountCode);

      if (vendor?.invoiceRegNumber) {
        return await this.getTaxCode('P10', transactionDate);
      }
    }

    // 適格請求書なし → 経過措置適用
    return this.getTransitionalTaxCode(transactionDate);
  }

  /**
   * 経過措置の税コード決定
   */
  private getTransitionalTaxCode(transactionDate: Date): TaxCode {
    const date = transactionDate;

    // 2023/10/1 - 2026/9/30: 80%控除
    if (date < new Date('2026-10-01')) {
      return {
        taxCode: 'P10N80',
        taxRate: 10.00,
        deductionRate: 80.00,
        description: '課税仕入10%（経過措置80%控除）'
      };
    }

    // 2026/10/1 - 2029/9/30: 50%控除
    if (date < new Date('2029-10-01')) {
      return {
        taxCode: 'P10N50',
        taxRate: 10.00,
        deductionRate: 50.00,
        description: '課税仕入10%（経過措置50%控除）'
      };
    }

    // 2029/10/1以降: 控除不可
    return {
      taxCode: 'P10N00',
      taxRate: 10.00,
      deductionRate: 0.00,
      description: '課税仕入10%（控除不可）'
    };
  }

  /**
   * 課税売上の税コード決定
   */
  private async determineSalesTaxCode(
    account: Account,
    transactionDate: Date
  ): Promise<TaxCode> {
    // デフォルトは標準税率10%
    return await this.getTaxCode('S10', transactionDate);
  }

  private isPurchaseAccount(account: Account): boolean {
    // 5000000台（費用）または1300000台（固定資産）等
    const category = account.accountCategory;
    return category === '5' ||
           (category === '1' && account.accountCode.startsWith('13'));
  }

  private isSalesAccount(account: Account): boolean {
    // 4000000台（収益）
    return account.accountCategory === '4';
  }

  private async validateAndGetTaxCode(
    taxCode: string,
    transactionDate: Date
  ): Promise<TaxCode> {
    const code = await this.taxCodeRepository.findByCode(taxCode);

    if (!code) {
      throw new ValidationError('E109', `無効な税コードです: ${taxCode}`);
    }

    if (code.validFrom > transactionDate || code.validTo < transactionDate) {
      throw new ValidationError('E109', `税コードが有効期間外です: ${taxCode}`);
    }

    return code;
  }

  private async getTaxCode(code: string, date: Date): Promise<TaxCode> {
    return await this.taxCodeRepository.findByCode(code);
  }
}
```

### 3.4 分析軸設定ロジック

```typescript
/**
 * 分析軸（セグメント）設定ロジック
 */
class SegmentSetter {

  constructor(
    private profitCenterRepository: ProfitCenterRepository,
    private costCenterRepository: CostCenterRepository,
    private projectRepository: ProjectRepository,
    private propertyRepository: PropertyRepository,
    private portfolioRepository: PortfolioRepository
  ) {}

  /**
   * 分析軸を設定
   */
  async setSegments(
    lineInput: JournalLineInput,
    account: Account,
    userContext: UserContext,
    companyCode: string
  ): Promise<SegmentResult> {

    const result: SegmentResult = {};

    // 1. 利益センター（PC）
    result.profitCenter = await this.determineProfitCenter(
      lineInput, account, userContext, companyCode
    );

    // 2. コストセンター（CC）
    result.costCenter = await this.determineCostCenter(
      lineInput, account, userContext, companyCode
    );

    // 3. プロジェクト（PRJ）
    if (lineInput.projectCode) {
      result.projectCode = await this.validateProject(
        lineInput.projectCode, companyCode
      );
    }

    // 4. 物件（不動産）
    if (account.propertyRequired === '1') {
      result.propertyCode = await this.determineProperty(
        lineInput, companyCode
      );
    }

    // 5. ポートフォリオ（有価証券）
    if (account.portfolioRequired === '1') {
      result.portfolioCode = await this.determinePortfolio(
        lineInput, companyCode
      );
    }

    return result;
  }

  /**
   * 利益センター決定
   */
  private async determineProfitCenter(
    lineInput: JournalLineInput,
    account: Account,
    userContext: UserContext,
    companyCode: string
  ): Promise<string | null> {

    // P/L科目でない場合は不要
    if (account.bsPlFlag !== 'P') {
      return null;
    }

    // 明示的に指定されている場合
    if (lineInput.profitCenter) {
      await this.validateProfitCenter(lineInput.profitCenter, companyCode);
      return lineInput.profitCenter;
    }

    // 必須の場合はユーザーデフォルトを適用
    if (account.pcRequired === '1') {
      if (userContext.defaultProfitCenter) {
        return userContext.defaultProfitCenter;
      }
      throw new ValidationError('E111', '利益センターが必須です');
    }

    return null;
  }

  /**
   * コストセンター決定
   */
  private async determineCostCenter(
    lineInput: JournalLineInput,
    account: Account,
    userContext: UserContext,
    companyCode: string
  ): Promise<string | null> {

    // 費用科目でない場合は不要
    if (account.accountCategory !== '5') {
      return null;
    }

    // 明示的に指定されている場合
    if (lineInput.costCenter) {
      await this.validateCostCenter(lineInput.costCenter, companyCode);
      return lineInput.costCenter;
    }

    // 必須の場合はユーザーデフォルトを適用
    if (account.ccRequired === '1') {
      if (userContext.defaultCostCenter) {
        return userContext.defaultCostCenter;
      }
      throw new ValidationError('E112', 'コストセンターが必須です');
    }

    return null;
  }

  /**
   * 物件コード決定（不動産）
   */
  private async determineProperty(
    lineInput: JournalLineInput,
    companyCode: string
  ): Promise<string> {

    if (!lineInput.propertyCode) {
      throw new ValidationError('E115', '物件コードが必須です');
    }

    const property = await this.propertyRepository.findByCode(
      lineInput.propertyCode
    );

    if (!property || property.companyCode !== companyCode) {
      throw new ValidationError('E115', `無効な物件コードです: ${lineInput.propertyCode}`);
    }

    return lineInput.propertyCode;
  }

  /**
   * ポートフォリオ決定（有価証券）
   */
  private async determinePortfolio(
    lineInput: JournalLineInput,
    companyCode: string
  ): Promise<string> {

    if (!lineInput.portfolioCode) {
      throw new ValidationError('E116', 'ポートフォリオコードが必須です');
    }

    const portfolio = await this.portfolioRepository.findByCode(
      lineInput.portfolioCode
    );

    if (!portfolio) {
      throw new ValidationError('E116', `無効なポートフォリオコードです: ${lineInput.portfolioCode}`);
    }

    return lineInput.portfolioCode;
  }

  // バリデーションメソッド（省略）
  private async validateProfitCenter(code: string, companyCode: string): Promise<void> { }
  private async validateCostCenter(code: string, companyCode: string): Promise<void> { }
  private async validateProject(code: string, companyCode: string): Promise<string> { return code; }
}

interface SegmentResult {
  profitCenter?: string;
  costCenter?: string;
  projectCode?: string;
  propertyCode?: string;
  portfolioCode?: string;
}
```

### 3.5 金額計算ロジック

```typescript
/**
 * 金額計算ロジック
 */
class AmountCalculator {

  constructor(
    private fxRateRepository: FxRateRepository
  ) {}

  /**
   * 金額を計算
   */
  async calculate(
    lineInput: JournalLineInput,
    taxCode: TaxCode | null,
    currencyCode: string,
    fxRate: number | null,
    companyCode: string
  ): Promise<AmountResult> {

    const result: AmountResult = {
      amountTransaction: lineInput.amountTransaction,
      amountBase: 0,
      taxAmountTransaction: 0,
      taxAmountBase: 0
    };

    // 1. 基準通貨換算
    if (currencyCode === 'JPY') {
      result.amountBase = lineInput.amountTransaction;
    } else {
      if (!fxRate) {
        throw new ValidationError('E105', '為替レートが必要です');
      }

      // 外貨換算（四捨五入で円未満切り捨て）
      result.amountBase = this.roundToYen(
        lineInput.amountTransaction * fxRate
      );
    }

    // 2. 消費税計算
    if (taxCode) {
      const taxResult = this.calculateTax(
        result.amountTransaction,
        result.amountBase,
        taxCode,
        lineInput.taxAmount  // 手動指定がある場合
      );

      result.taxAmountTransaction = taxResult.taxTransaction;
      result.taxAmountBase = taxResult.taxBase;
    }

    return result;
  }

  /**
   * 消費税計算
   */
  private calculateTax(
    amountTransaction: number,
    amountBase: number,
    taxCode: TaxCode,
    manualTaxAmount?: number
  ): { taxTransaction: number; taxBase: number } {

    // 手動指定がある場合はそれを使用
    if (manualTaxAmount !== undefined) {
      return {
        taxTransaction: manualTaxAmount,
        taxBase: manualTaxAmount  // 円建て前提
      };
    }

    const taxRate = taxCode.taxRate;

    if (taxCode.taxInclusiveFlag === '1') {
      // 内税計算
      // 税額 = 税込金額 × 税率 / (100 + 税率)
      const taxBase = Math.floor(
        amountBase * taxRate / (100 + taxRate)
      );
      const taxTransaction = Math.floor(
        amountTransaction * taxRate / (100 + taxRate)
      );

      return { taxTransaction, taxBase };
    } else {
      // 外税計算
      // 税額 = 税抜金額 × 税率 / 100
      const taxBase = Math.floor(amountBase * taxRate / 100);
      const taxTransaction = Math.floor(amountTransaction * taxRate / 100);

      return { taxTransaction, taxBase };
    }
  }

  /**
   * 円未満四捨五入
   */
  private roundToYen(amount: number): number {
    return Math.round(amount);
  }
}

interface AmountResult {
  amountTransaction: number;  // 原通貨金額
  amountBase: number;         // 基準通貨金額
  taxAmountTransaction: number;  // 税額（原通貨）
  taxAmountBase: number;         // 税額（基準通貨）
}
```

### 3.6 貸借一致検証

```typescript
/**
 * 貸借一致検証
 */
class BalanceValidator {

  /**
   * 貸借一致を検証
   */
  validate(lines: ProcessedJournalLine[]): void {
    // 借方合計
    const debitTotal = lines
      .filter(line => line.drCr === DrCr.DR)
      .reduce((sum, line) => sum + line.amountBase, 0);

    // 貸方合計
    const creditTotal = lines
      .filter(line => line.drCr === DrCr.CR)
      .reduce((sum, line) => sum + line.amountBase, 0);

    // 一致チェック
    if (debitTotal !== creditTotal) {
      const diff = debitTotal - creditTotal;
      throw new ValidationError(
        'E120',
        `貸借が一致しません（借方: ${debitTotal.toLocaleString()}円, ` +
        `貸方: ${creditTotal.toLocaleString()}円, 差額: ${diff.toLocaleString()}円）`
      );
    }
  }

  /**
   * 税額の貸借一致を検証（税額明細がある場合）
   */
  validateTaxBalance(lines: ProcessedJournalLine[]): void {
    // 仮払消費税（借方）合計
    const inputTaxTotal = lines
      .filter(line => line.drCr === DrCr.DR && this.isInputTaxAccount(line.accountCode))
      .reduce((sum, line) => sum + line.amountBase, 0);

    // 課税仕入の税額合計
    const purchaseTaxTotal = lines
      .filter(line => line.drCr === DrCr.DR && line.taxAmountBase > 0)
      .reduce((sum, line) => sum + line.taxAmountBase, 0);

    // 仮受消費税（貸方）合計
    const outputTaxTotal = lines
      .filter(line => line.drCr === DrCr.CR && this.isOutputTaxAccount(line.accountCode))
      .reduce((sum, line) => sum + line.amountBase, 0);

    // 課税売上の税額合計
    const salesTaxTotal = lines
      .filter(line => line.drCr === DrCr.CR && line.taxAmountBase > 0)
      .reduce((sum, line) => sum + line.taxAmountBase, 0);

    // 検証（税額明細がある場合のみ）
    if (inputTaxTotal > 0 && inputTaxTotal !== purchaseTaxTotal) {
      console.warn(`仮払消費税と課税仕入税額が不一致: 仮払=${inputTaxTotal}, 税額=${purchaseTaxTotal}`);
    }

    if (outputTaxTotal > 0 && outputTaxTotal !== salesTaxTotal) {
      console.warn(`仮受消費税と課税売上税額が不一致: 仮受=${outputTaxTotal}, 税額=${salesTaxTotal}`);
    }
  }

  private isInputTaxAccount(accountCode: string): boolean {
    return accountCode.startsWith('2160');  // 仮払消費税
  }

  private isOutputTaxAccount(accountCode: string): boolean {
    return accountCode.startsWith('2170');  // 仮受消費税
  }
}
```

---

## 4. 出力仕様

### 4.1 出力データ構造

```typescript
/**
 * 仕訳生成結果
 */
interface JournalGenerationResult {
  /** 処理成功フラグ */
  success: boolean;

  /** 仕訳ID（成功時） */
  journalId?: number;

  /** 伝票番号（成功時） */
  journalNumber?: string;

  /** 仕訳ヘッダ（成功時） */
  header?: JournalHeader;

  /** 仕訳明細（成功時） */
  lines?: JournalLine[];

  /** エラー情報（失敗時） */
  errors?: ValidationError[];

  /** 警告情報 */
  warnings?: Warning[];
}

/**
 * 仕訳ヘッダ
 */
interface JournalHeader {
  journalId: number;
  companyCode: string;
  journalNumber: string;
  journalDate: Date;
  fiscalPeriod: string;
  journalType: JournalType;
  description: string;
  currencyCode: string;
  fxRate: number;
  rateType: RateType;
  rateDate: Date;
  status: JournalStatus;
  sourceModule: SourceModule;
  sourceDocType: string;
  sourceDocId: string;
  totalDebit: number;
  totalCredit: number;
  createdAt: Date;
  createdBy: string;
  updatedAt: Date;
  updatedBy: string;
}

/**
 * 仕訳明細
 */
interface JournalLine {
  journalId: number;
  lineNo: number;
  drCr: DrCr;
  accountCode: string;
  accountName: string;
  subAccountCode: string;
  subAccountName: string;
  subAccountType: SubAccountType;
  amountTransaction: number;
  amountBase: number;
  taxCode: string;
  taxAmountTransaction: number;
  taxAmountBase: number;
  invoiceRegNumber: string;
  profitCenter: string;
  costCenter: string;
  projectCode: string;
  propertyCode: string;
  portfolioCode: string;
  lineDescription: string;
  createdAt: Date;
  createdBy: string;
}

/**
 * 仕訳ステータス
 */
enum JournalStatus {
  DRAFT = '10',       // 下書き
  PENDING = '20',     // 承認待ち
  APPROVED = '30',    // 承認済み
  REJECTED = '40',    // 否認
  CANCELLED = '50'    // 取消
}
```

---

## 5. メインコンポーネント実装

```typescript
/**
 * 仕訳生成サービス（メインコンポーネント）
 */
@Injectable()
export class JournalGenerationService {

  constructor(
    private inputValidator: InputValidator,
    private patternResolver: JournalPatternResolver,
    private accountDeterminer: AccountDeterminer,
    private taxCodeDeterminer: TaxCodeDeterminer,
    private segmentSetter: SegmentSetter,
    private amountCalculator: AmountCalculator,
    private balanceValidator: BalanceValidator,
    private journalRepository: JournalRepository,
    private journalNumberGenerator: JournalNumberGenerator,
    private auditLogger: AuditLogger
  ) {}

  /**
   * 仕訳を生成
   */
  @Transactional()
  async generate(
    request: JournalGenerationRequest,
    userContext: UserContext
  ): Promise<JournalGenerationResult> {

    const correlationId = generateCorrelationId();

    try {
      // ===== Step 1: 入力バリデーション =====
      await this.inputValidator.validate(request);

      // ===== Step 2: 仕訳パターン決定 =====
      const postingRules = await this.patternResolver.resolve(request);

      // ===== Step 3-7: 明細処理 =====
      const processedLines: ProcessedJournalLine[] = [];

      for (let i = 0; i < request.lines.length; i++) {
        const lineInput = request.lines[i];
        const rule = postingRules[i] || null;

        // 3. 勘定科目決定
        const account = await this.accountDeterminer.determine(
          lineInput, rule, request.transactionDate, request.companyCode
        );

        // 4. 税コード決定
        const taxCode = await this.taxCodeDeterminer.determine(
          lineInput, account, request.transactionDate
        );

        // 5. 分析軸設定
        const segments = await this.segmentSetter.setSegments(
          lineInput, account, userContext, request.companyCode
        );

        // 6. 金額計算
        const amounts = await this.amountCalculator.calculate(
          lineInput, taxCode, request.currencyCode,
          request.fxRate, request.companyCode
        );

        // 処理済み明細を追加
        processedLines.push({
          lineNo: i + 1,
          drCr: lineInput.drCr,
          accountCode: account.accountCode,
          accountName: account.accountNameJp,
          subAccountCode: lineInput.subAccountCode,
          subAccountType: lineInput.subAccountType,
          ...amounts,
          taxCode: taxCode?.taxCode,
          invoiceRegNumber: lineInput.invoiceRegNumber,
          ...segments,
          lineDescription: lineInput.lineDescription
        });
      }

      // ===== Step 7: 貸借一致検証 =====
      this.balanceValidator.validate(processedLines);

      // ===== Step 8: 仕訳データ生成 =====
      const journalNumber = await this.journalNumberGenerator.generate(
        request.companyCode,
        request.transactionDate
      );

      const header = this.createHeader(request, journalNumber, processedLines, userContext);
      const lines = this.createLines(processedLines, userContext);

      // ===== Step 9: 仕訳登録 =====
      const journalId = await this.journalRepository.save(header, lines);

      // ===== Step 10: 証憑紐付け（存在する場合） =====
      if (request.documentIds?.length > 0) {
        await this.linkDocuments(journalId, request.documentIds);
      }

      // ===== 監査ログ記録 =====
      await this.auditLogger.log({
        correlationId,
        operation: 'JOURNAL_CREATE',
        userId: userContext.userId,
        targetType: 'JOURNAL',
        targetId: journalNumber,
        afterValue: { header, lines },
        result: 'SUCCESS'
      });

      return {
        success: true,
        journalId,
        journalNumber,
        header: { ...header, journalId },
        lines: lines.map((line, i) => ({ ...line, journalId, lineNo: i + 1 }))
      };

    } catch (error) {
      // エラー時の監査ログ
      await this.auditLogger.log({
        correlationId,
        operation: 'JOURNAL_CREATE',
        userId: userContext.userId,
        targetType: 'JOURNAL',
        result: 'FAILURE',
        errorCode: error.code,
        errorMessage: error.message
      });

      if (error instanceof ValidationError) {
        return {
          success: false,
          errors: [error]
        };
      }

      throw error;
    }
  }

  private createHeader(
    request: JournalGenerationRequest,
    journalNumber: string,
    lines: ProcessedJournalLine[],
    userContext: UserContext
  ): Partial<JournalHeader> {

    const totalDebit = lines
      .filter(l => l.drCr === DrCr.DR)
      .reduce((sum, l) => sum + l.amountBase, 0);

    return {
      companyCode: request.companyCode,
      journalNumber,
      journalDate: request.transactionDate,
      fiscalPeriod: this.getFiscalPeriod(request.transactionDate),
      journalType: request.journalType,
      description: request.description,
      currencyCode: request.currencyCode,
      fxRate: request.fxRate || 1,
      rateType: request.rateType || RateType.TTM,
      rateDate: request.rateDate || request.transactionDate,
      status: JournalStatus.DRAFT,
      sourceModule: request.sourceModule,
      sourceDocType: request.sourceDocType,
      sourceDocId: request.sourceDocId,
      totalDebit,
      totalCredit: totalDebit,
      createdBy: userContext.userId,
      updatedBy: userContext.userId
    };
  }

  private createLines(
    processedLines: ProcessedJournalLine[],
    userContext: UserContext
  ): Partial<JournalLine>[] {
    return processedLines.map((line, index) => ({
      lineNo: index + 1,
      drCr: line.drCr,
      accountCode: line.accountCode,
      subAccountCode: line.subAccountCode,
      subAccountType: line.subAccountType,
      amountTransaction: line.amountTransaction,
      amountBase: line.amountBase,
      taxCode: line.taxCode,
      taxAmountTransaction: line.taxAmountTransaction,
      taxAmountBase: line.taxAmountBase,
      invoiceRegNumber: line.invoiceRegNumber,
      profitCenter: line.profitCenter,
      costCenter: line.costCenter,
      projectCode: line.projectCode,
      propertyCode: line.propertyCode,
      portfolioCode: line.portfolioCode,
      lineDescription: line.lineDescription,
      createdBy: userContext.userId
    }));
  }

  private getFiscalPeriod(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    return `${year}${month}`;
  }

  private async linkDocuments(journalId: number, documentIds: string[]): Promise<void> {
    // 証憑紐付け処理
  }
}
```

---

## 6. エラー処理

### 6.1 エラーコード一覧

| コード | カテゴリ | メッセージ | 対処方法 |
|--------|----------|------------|----------|
| E001 | 必須 | 会社コードは必須です | 会社コードを入力 |
| E002 | 必須 | 取引日は必須です | 取引日を入力 |
| E003 | 必須 | 伝票区分は必須です | 伝票区分を選択 |
| E004 | 必須 | 通貨コードは必須です | 通貨コードを入力 |
| E005 | 必須 | 発生元モジュールは必須です | 発生元を指定 |
| E006 | 必須 | 明細が1件以上必要です | 明細を入力 |
| E007 | 必須 | 借貸区分は必須です | 借方/貸方を選択 |
| E008 | 必須 | 勘定科目コードは必須です | 科目を選択 |
| E009 | 必須 | 金額は正の数を入力してください | 金額を確認 |
| E101 | 整合性 | 無効な会社コードです | 会社コードを確認 |
| E102 | 整合性 | 締め済み期間には入力できません | 日付を確認/締め解除 |
| E103 | 整合性 | 未来日付は入力できません | 日付を確認 |
| E104 | 整合性 | 無効な通貨コードです | 通貨を確認 |
| E105 | 整合性 | 為替レートが必要です | レートを入力 |
| E106 | 整合性 | 為替レートが異常値です | レートを確認 |
| E107 | 整合性 | 無効な勘定科目です | 科目を確認 |
| E108 | 整合性 | 税コードが必要です | 税コードを選択 |
| E109 | 整合性 | 無効な税コードです | 税コードを確認 |
| E110 | 整合性 | 補助科目が必要です | 補助科目を入力 |
| E111 | 整合性 | 利益センターが必要です | PCを選択 |
| E112 | 整合性 | コストセンターが必要です | CCを選択 |
| E113 | 整合性 | インボイス登録番号が必要です | 番号を入力 |
| E114 | 整合性 | インボイス登録番号の形式が不正です | 形式を確認 |
| E115 | 整合性 | 無効な物件コードです | 物件を確認 |
| E116 | 整合性 | 無効なポートフォリオコードです | PFを確認 |
| E120 | 論理 | 貸借が一致しません | 金額を確認 |
| E121 | 論理 | 伝票番号の採番に失敗しました | 再試行 |
| E130 | システム | データベースエラー | システム管理者に連絡 |

### 6.2 リトライ方針

| エラー種別 | リトライ | 回数 | 間隔 | 理由 |
|------------|----------|------|------|------|
| バリデーションエラー（E0xx, E1xx） | 不可 | - | - | 入力修正が必要 |
| 論理エラー（E12x） | 不可 | - | - | 入力修正が必要 |
| DB接続エラー | 可 | 3回 | 1秒 | 一時的障害の可能性 |
| マスタ参照エラー | 可 | 1回 | - | キャッシュ更新 |
| タイムアウト | 可 | 2回 | 2秒 | 一時的負荷 |
| 採番エラー（E121） | 可 | 3回 | 100ms | 競合の可能性 |

---

## 7. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2026/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] 入力パラメータが全て定義されているか
- [ ] 発生元モジュール別の入力パターンが網羅されているか
- [ ] バリデーションルールが網羅されているか
- [ ] 科目決定ロジックが要件を満たしているか
- [ ] 税コード決定ロジックがインボイス制度に対応しているか
- [ ] 経過措置（80%/50%/0%）の判定が正しいか
- [ ] セグメント（PC/CC/PRJ/物件/PF）の設定ロジックが適切か
- [ ] 外貨換算ロジックが正しいか
- [ ] 端数処理ルールが正しく実装されているか
- [ ] 貸借一致チェックが実装されているか
- [ ] エラーコードとメッセージが適切か
- [ ] リトライ方針が適切か
- [ ] 監査ログが適切に記録されるか
- [ ] 開発チームのレビューを受けているか
