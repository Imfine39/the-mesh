# 物理ER・テーブル定義

| 項目 | 内容 |
|------|------|
| 文書番号 | DET-TBL-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2025/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. テーブル設計方針

### 1.1 命名規約

| 対象 | 規約 | 例 |
|------|------|-----|
| テーブル名 | [種別]_[名称] | M_ACCOUNT, T_JOURNAL |
| 種別プレフィックス | M_=マスタ, T_=トランザクション, W_=ワーク, H_=履歴, R_=関連 | |
| カラム名 | スネークケース（小文字） | account_cd, created_at |
| 主キー | [テーブル名]_id or 複合キー | journal_id |
| 外部キー | 参照先カラム名と同名 | company_cd, account_cd |
| フラグ | [名称]_flag | active_flag, delete_flag |
| 日時 | [動詞]_at | created_at, updated_at |
| 日付 | [名称]_date | slip_date, due_date |
| コード | [名称]_cd | account_cd, tax_cd |
| 金額 | [名称]_amt または amount_[修飾] | total_amt, amount_base |

### 1.2 データ型規約

| 論理型 | 物理型（PostgreSQL） | 備考 |
|--------|---------------------|------|
| 文字（固定長） | CHAR(n) | コード類 |
| 文字（可変長） | VARCHAR(n) | 名称類、摘要 |
| 整数 | INTEGER/BIGINT | ID、数量 |
| 金額 | DECIMAL(18,2) | 円単位（小数2桁） |
| 金額（高精度） | DECIMAL(23,6) | 外貨金額 |
| 為替レート | DECIMAL(18,6) | 小数6桁 |
| 税率 | DECIMAL(5,2) | パーセント |
| 数量 | DECIMAL(18,4) | 株数等 |
| 日付 | DATE | |
| タイムスタンプ | TIMESTAMP WITH TIME ZONE | |
| フラグ | CHAR(1) | '0'/'1' |
| JSON | JSONB | 可変構造データ |
| UUID | UUID | 一意識別子 |
| テキスト（大） | TEXT | 長文 |

### 1.3 共通監査カラム

全テーブルに以下の監査カラムを設置：

```sql
-- 監査カラム（全テーブル共通）
created_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- 作成日時
created_by          VARCHAR(50)              NOT NULL,                            -- 作成者
updated_at          TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- 更新日時
updated_by          VARCHAR(50)              NOT NULL,                            -- 更新者
version             INTEGER                  NOT NULL DEFAULT 1,                  -- 楽観ロック用バージョン
deleted_flag        CHAR(1)                  NOT NULL DEFAULT '0'                 -- 論理削除フラグ
```

---

## 2. マスタテーブル

### 2.1 会社マスタ（M_COMPANY）

```sql
-- ================================================
-- テーブル名: M_COMPANY（会社マスタ）
-- 目的: グループ会社の基本情報を管理
-- ================================================
CREATE TABLE M_COMPANY (
    -- 主キー
    company_cd              CHAR(4)             NOT NULL,   -- 会社コード

    -- 基本情報
    company_name_jp         VARCHAR(100)        NOT NULL,   -- 会社名（日本語）
    company_name_en         VARCHAR(100),                   -- 会社名（英語）
    company_name_short      VARCHAR(20),                    -- 会社名（略称）
    corporate_number        CHAR(13),                       -- 法人番号
    invoice_number          CHAR(14),                       -- 適格請求書発行事業者番号（T+13桁）

    -- 住所情報
    postal_code             CHAR(8),                        -- 郵便番号
    address1                VARCHAR(100),                   -- 住所1
    address2                VARCHAR(100),                   -- 住所2
    phone_number            VARCHAR(20),                    -- 電話番号
    fax_number              VARCHAR(20),                    -- FAX番号

    -- 会計設定
    base_currency_cd        CHAR(3)             NOT NULL DEFAULT 'JPY',  -- 基軸通貨
    fiscal_year_start_month SMALLINT            NOT NULL DEFAULT 4,      -- 会計年度開始月
    accounting_standard     CHAR(4)             NOT NULL DEFAULT 'JGAP', -- 会計基準（JGAP/IFRS）
    tax_method              CHAR(2)             NOT NULL DEFAULT '01',   -- 消費税計算方式
    industry_type           CHAR(2)             NOT NULL,                -- 業種区分

    -- グループ情報
    parent_company_cd       CHAR(4),                        -- 親会社コード
    consolidation_flag      CHAR(1)             NOT NULL DEFAULT '1',    -- 連結対象フラグ

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',   -- ステータス
    valid_from              DATE                NOT NULL,
    valid_to                DATE                NOT NULL DEFAULT '9999-12-31',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_COMPANY PRIMARY KEY (company_cd),
    CONSTRAINT FK_M_COMPANY_PARENT FOREIGN KEY (parent_company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT CK_M_COMPANY_STANDARD CHECK (accounting_standard IN ('JGAP', 'IFRS', 'BOTH'))
);

COMMENT ON TABLE M_COMPANY IS '会社マスタ';
COMMENT ON COLUMN M_COMPANY.company_cd IS '会社コード（4桁）';
COMMENT ON COLUMN M_COMPANY.invoice_number IS '適格請求書発行事業者番号（T+法人番号13桁）';
COMMENT ON COLUMN M_COMPANY.industry_type IS '業種区分（01:IT/コンサル 02:不動産 03:有価証券 99:その他）';
```

### 2.2 勘定科目マスタ（M_ACCOUNT）

```sql
-- ================================================
-- テーブル名: M_ACCOUNT（勘定科目マスタ）
-- 目的: 勘定科目の定義と属性を管理
-- ================================================
CREATE TABLE M_ACCOUNT (
    -- 主キー
    company_cd              CHAR(4)             NOT NULL,   -- 会社コード
    account_cd              CHAR(7)             NOT NULL,   -- 勘定科目コード

    -- 基本情報
    account_name_jp         VARCHAR(100)        NOT NULL,   -- 科目名（日本語）
    account_name_en         VARCHAR(100),                   -- 科目名（英語）
    account_name_short      VARCHAR(20),                    -- 科目名（略称）

    -- 分類情報
    account_type            CHAR(1)             NOT NULL,   -- 科目区分(1:資産 2:負債 3:純資産 4:収益 5:費用)
    account_category        CHAR(2)             NOT NULL,   -- 科目分類（細分類）
    account_level           CHAR(1)             NOT NULL,   -- 階層レベル(1:大 2:中 3:小 4:補助)
    parent_account_cd       CHAR(7),                        -- 親科目コード
    bs_pl_flag              CHAR(1)             NOT NULL,   -- B/S P/L区分(B:B/S P:P/L)
    display_order           INTEGER,                        -- 表示順

    -- 属性情報
    cash_flag               CHAR(1)             NOT NULL DEFAULT '0',   -- 現金性フラグ
    clearing_flag           CHAR(1)             NOT NULL DEFAULT '0',   -- 消込対象フラグ
    clearing_type           CHAR(2),                        -- 消込種別（AR/AP/CM）
    tax_applicable          CHAR(1)             NOT NULL DEFAULT '1',   -- 税区分適用(0:対象外 1:必須 2:任意)
    fx_flag                 CHAR(1)             NOT NULL DEFAULT '0',   -- 外貨対応フラグ
    sub_account_flag        CHAR(1)             NOT NULL DEFAULT '0',   -- 補助科目必須フラグ
    sub_account_type        CHAR(2),                        -- 補助科目種別（取引先/物件等）
    cf_category             CHAR(2),                        -- CF区分(01:営業 02:投資 03:財務)
    segment_required        CHAR(1)             NOT NULL DEFAULT '0',   -- セグメント必須フラグ

    -- IFRS対応
    ifrs_account_cd         CHAR(7),                        -- IFRS勘定科目コード
    ifrs_mapping_type       CHAR(1),                        -- IFRSマッピング種別

    -- 有効期間
    valid_from              DATE                NOT NULL,
    valid_to                DATE                NOT NULL DEFAULT '9999-12-31',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_ACCOUNT PRIMARY KEY (company_cd, account_cd),
    CONSTRAINT FK_M_ACCOUNT_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT FK_M_ACCOUNT_PARENT FOREIGN KEY (company_cd, parent_account_cd)
        REFERENCES M_ACCOUNT (company_cd, account_cd),
    CONSTRAINT CK_M_ACCOUNT_TYPE CHECK (account_type IN ('1','2','3','4','5')),
    CONSTRAINT CK_M_ACCOUNT_BSPL CHECK (bs_pl_flag IN ('B','P'))
);

CREATE INDEX IX_M_ACCOUNT_TYPE ON M_ACCOUNT (company_cd, account_type);
CREATE INDEX IX_M_ACCOUNT_PARENT ON M_ACCOUNT (company_cd, parent_account_cd);
CREATE INDEX IX_M_ACCOUNT_CLEARING ON M_ACCOUNT (company_cd, clearing_flag, clearing_type);

COMMENT ON TABLE M_ACCOUNT IS '勘定科目マスタ';
COMMENT ON COLUMN M_ACCOUNT.account_cd IS '勘定科目コード（7桁：大2+中2+小2+補助1）';
```

### 2.3 税コードマスタ（M_TAX_CODE）

```sql
-- ================================================
-- テーブル名: M_TAX_CODE（税コードマスタ）
-- 目的: 消費税コードと税率、インボイス対応を管理
-- ================================================
CREATE TABLE M_TAX_CODE (
    -- 主キー
    tax_cd                  CHAR(10)            NOT NULL,   -- 税コード

    -- 基本情報
    tax_name                VARCHAR(50)         NOT NULL,   -- 税コード名
    tax_name_short          VARCHAR(20),                    -- 税コード名（略称）
    tax_description         VARCHAR(200),                   -- 説明

    -- 税率情報
    tax_rate                DECIMAL(5,2)        NOT NULL,   -- 税率（%）
    local_tax_rate          DECIMAL(5,2)        NOT NULL DEFAULT 0,   -- 地方消費税率（%）
    tax_category            CHAR(2)             NOT NULL,   -- 税区分(S10:課税10% S08:課税8% S00:免税 SN:非課税 SO:不課税)
    sales_purchase          CHAR(1)             NOT NULL,   -- 売上仕入区分(S:売上 P:仕入)
    inclusive_flag          CHAR(1)             NOT NULL DEFAULT '0',  -- 内外税区分(0:外税 1:内税)

    -- インボイス関連
    invoice_required        CHAR(1)             NOT NULL DEFAULT '1',  -- インボイス要否
    deduction_rate          DECIMAL(5,2)        NOT NULL DEFAULT 100.00,  -- 控除率（経過措置用）
    transitional_measure    CHAR(1)             NOT NULL DEFAULT '0',  -- 経過措置フラグ

    -- 申告書連携
    return_category_sales   CHAR(2),                        -- 申告書区分（売上）
    return_category_purchase CHAR(2),                       -- 申告書区分（仕入）
    purchase_purpose        CHAR(1),                        -- 仕入区分（課税売上対応/共通/非課税対応）

    -- 有効期間
    valid_from              DATE                NOT NULL,
    valid_to                DATE                NOT NULL DEFAULT '9999-12-31',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_TAX_CODE PRIMARY KEY (tax_cd),
    CONSTRAINT CK_M_TAX_CATEGORY CHECK (tax_category IN ('S10','S08','S00','SN','SO','P10','P08','PN','PO')),
    CONSTRAINT CK_M_TAX_SP CHECK (sales_purchase IN ('S','P'))
);

COMMENT ON TABLE M_TAX_CODE IS '税コードマスタ';
COMMENT ON COLUMN M_TAX_CODE.deduction_rate IS '経過措置控除率（100/80/50/0）';
```

### 2.4 取引先マスタ（M_PARTNER）

```sql
-- ================================================
-- テーブル名: M_PARTNER（取引先マスタ）
-- 目的: 得意先・仕入先の基本情報を管理
-- ================================================
CREATE TABLE M_PARTNER (
    -- 主キー
    company_cd              CHAR(4)             NOT NULL,   -- 会社コード
    partner_cd              VARCHAR(10)         NOT NULL,   -- 取引先コード

    -- 基本情報
    partner_type            CHAR(1)             NOT NULL,   -- 取引先区分(C:得意先 V:仕入先 B:両方)
    partner_name_jp         VARCHAR(100)        NOT NULL,   -- 取引先名（日本語）
    partner_name_en         VARCHAR(100),                   -- 取引先名（英語）
    partner_name_kana       VARCHAR(100),                   -- 取引先名（カナ）
    partner_name_short      VARCHAR(20),                    -- 取引先名（略称）

    -- 法人情報
    corporate_type          CHAR(1)             NOT NULL,   -- 法人区分(1:法人 2:個人)
    corporate_number        CHAR(13),                       -- 法人番号
    invoice_number          CHAR(14),                       -- 適格請求書発行事業者番号
    invoice_verified_at     TIMESTAMP WITH TIME ZONE,       -- インボイス番号確認日時
    invoice_verified_flag   CHAR(1)             NOT NULL DEFAULT '0',  -- インボイス番号確認済フラグ

    -- 住所情報
    postal_code             CHAR(8),
    address1                VARCHAR(100),
    address2                VARCHAR(100),
    phone_number            VARCHAR(20),
    fax_number              VARCHAR(20),
    email                   VARCHAR(100),

    -- 取引条件（得意先）
    ar_account_cd           CHAR(7),                        -- 売掛金科目
    ar_payment_terms        CHAR(4),                        -- 回収条件コード
    ar_credit_limit         DECIMAL(18,2),                  -- 与信限度額
    ar_tax_rounding         CHAR(1),                        -- 消費税端数処理

    -- 取引条件（仕入先）
    ap_account_cd           CHAR(7),                        -- 買掛金科目
    ap_payment_terms        CHAR(4),                        -- 支払条件コード
    ap_payment_method       CHAR(2),                        -- 支払方法
    ap_tax_rounding         CHAR(1),                        -- 消費税端数処理
    withholding_flag        CHAR(1)             NOT NULL DEFAULT '0',  -- 源泉徴収対象フラグ

    -- 銀行口座
    bank_cd                 CHAR(4),                        -- 銀行コード
    branch_cd               CHAR(3),                        -- 支店コード
    account_type            CHAR(1),                        -- 口座種別(1:普通 2:当座)
    account_number          VARCHAR(10),                    -- 口座番号
    account_holder          VARCHAR(50),                    -- 口座名義

    -- セグメント
    default_dept_cd         CHAR(6),                        -- デフォルト部門
    default_project_cd      VARCHAR(10),                    -- デフォルトプロジェクト

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',
    valid_from              DATE                NOT NULL,
    valid_to                DATE                NOT NULL DEFAULT '9999-12-31',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_PARTNER PRIMARY KEY (company_cd, partner_cd),
    CONSTRAINT FK_M_PARTNER_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT CK_M_PARTNER_TYPE CHECK (partner_type IN ('C','V','B'))
);

CREATE INDEX IX_M_PARTNER_TYPE ON M_PARTNER (company_cd, partner_type);
CREATE INDEX IX_M_PARTNER_NAME ON M_PARTNER (company_cd, partner_name_jp);
CREATE INDEX IX_M_PARTNER_INVOICE ON M_PARTNER (invoice_number);

COMMENT ON TABLE M_PARTNER IS '取引先マスタ';
COMMENT ON COLUMN M_PARTNER.invoice_number IS '適格請求書発行事業者番号（T+13桁）';
```

### 2.5 通貨マスタ（M_CURRENCY）

```sql
-- ================================================
-- テーブル名: M_CURRENCY（通貨マスタ）
-- ================================================
CREATE TABLE M_CURRENCY (
    currency_cd             CHAR(3)             NOT NULL,   -- 通貨コード（ISO4217）
    currency_name_jp        VARCHAR(50)         NOT NULL,   -- 通貨名（日本語）
    currency_name_en        VARCHAR(50),                    -- 通貨名（英語）
    currency_symbol         VARCHAR(5),                     -- 通貨記号
    decimal_places          SMALLINT            NOT NULL DEFAULT 2,     -- 小数桁数
    rounding_method         CHAR(1)             NOT NULL DEFAULT 'R',   -- 端数処理(R:四捨五入 U:切上 D:切捨)
    display_order           INTEGER,
    status                  CHAR(2)             NOT NULL DEFAULT '01',

    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_CURRENCY PRIMARY KEY (currency_cd)
);

COMMENT ON TABLE M_CURRENCY IS '通貨マスタ';
```

### 2.6 為替レートマスタ（M_FX_RATE）

```sql
-- ================================================
-- テーブル名: M_FX_RATE（為替レートマスタ）
-- 目的: 日次・月次為替レートを管理
-- ================================================
CREATE TABLE M_FX_RATE (
    -- 主キー
    rate_date               DATE                NOT NULL,   -- レート適用日
    from_currency_cd        CHAR(3)             NOT NULL,   -- 換算元通貨
    to_currency_cd          CHAR(3)             NOT NULL,   -- 換算先通貨
    rate_type               CHAR(4)             NOT NULL,   -- レート種別

    -- レート
    rate                    DECIMAL(18,6)       NOT NULL,   -- 為替レート
    inverse_rate            DECIMAL(18,6),                  -- 逆レート

    -- 情報
    source                  VARCHAR(20),                    -- レートソース
    confirmed_flag          CHAR(1)             NOT NULL DEFAULT '0',   -- 確定フラグ

    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,

    CONSTRAINT PK_M_FX_RATE PRIMARY KEY (rate_date, from_currency_cd, to_currency_cd, rate_type),
    CONSTRAINT FK_M_FX_RATE_FROM FOREIGN KEY (from_currency_cd)
        REFERENCES M_CURRENCY (currency_cd),
    CONSTRAINT FK_M_FX_RATE_TO FOREIGN KEY (to_currency_cd)
        REFERENCES M_CURRENCY (currency_cd),
    CONSTRAINT CK_M_FX_RATE_TYPE CHECK (rate_type IN ('TTM','TTB','TTS','SPOT','M_END'))
);

CREATE INDEX IX_M_FX_RATE_DATE ON M_FX_RATE (rate_date, rate_type);

COMMENT ON TABLE M_FX_RATE IS '為替レートマスタ';
COMMENT ON COLUMN M_FX_RATE.rate_type IS 'レート種別（TTM:仲値 TTB:買 TTS:売 SPOT:直物 M_END:月末）';
```

---

## 3. トランザクションテーブル（GL）

### 3.1 仕訳ヘッダ（T_JOURNAL_HEADER）

```sql
-- ================================================
-- テーブル名: T_JOURNAL_HEADER（仕訳ヘッダ）
-- パーティション: 会計期間（fiscal_period）で月次パーティション
-- ================================================
CREATE TABLE T_JOURNAL_HEADER (
    -- 主キー
    journal_id              BIGINT              NOT NULL,   -- 仕訳ID（シーケンス）

    -- 会社・期間
    company_cd              CHAR(4)             NOT NULL,
    fiscal_year             CHAR(4)             NOT NULL,   -- 会計年度（YYYY）
    fiscal_period           CHAR(6)             NOT NULL,   -- 会計期間（YYYYMM）

    -- 伝票情報
    slip_no                 VARCHAR(20)         NOT NULL,   -- 伝票番号
    slip_date               DATE                NOT NULL,   -- 伝票日付
    entry_date              DATE                NOT NULL,   -- 起票日
    slip_type               CHAR(2)             NOT NULL DEFAULT '01',  -- 伝票種別
    description             VARCHAR(200),                   -- 摘要

    -- 通貨情報
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',
    fx_rate                 DECIMAL(18,6)       DEFAULT 1,
    fx_rate_type            CHAR(4),
    fx_rate_date            DATE,

    -- 金額集計
    debit_total             DECIMAL(18,2)       NOT NULL DEFAULT 0,
    credit_total            DECIMAL(18,2)       NOT NULL DEFAULT 0,
    debit_total_base        DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 基軸通貨借方合計
    credit_total_base       DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 基軸通貨貸方合計

    -- ステータス・承認
    status                  CHAR(2)             NOT NULL DEFAULT '00',
    approved_at             TIMESTAMP WITH TIME ZONE,
    approved_by             VARCHAR(50),
    posted_at               TIMESTAMP WITH TIME ZONE,       -- GL転記日時
    posted_flag             CHAR(1)             NOT NULL DEFAULT '0',

    -- 発生元情報
    source_type             CHAR(2)             NOT NULL,   -- 発生元区分
    source_id               VARCHAR(50),                    -- 発生元ID
    source_system           VARCHAR(20),                    -- 発生元システム
    batch_id                VARCHAR(50),                    -- バッチID

    -- 逆仕訳
    reversal_flag           CHAR(1)             NOT NULL DEFAULT '0',   -- 逆仕訳フラグ
    reversal_journal_id     BIGINT,                         -- 逆仕訳の仕訳ID
    original_journal_id     BIGINT,                         -- 元仕訳ID（逆仕訳の場合）

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_T_JOURNAL_HEADER PRIMARY KEY (journal_id),
    CONSTRAINT UK_T_JOURNAL_SLIP UNIQUE (company_cd, slip_no),
    CONSTRAINT FK_T_JOURNAL_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT CK_T_JOURNAL_BALANCE CHECK (debit_total = credit_total)
) PARTITION BY RANGE (fiscal_period);

-- パーティション作成（月次）
CREATE TABLE T_JOURNAL_HEADER_202501 PARTITION OF T_JOURNAL_HEADER
    FOR VALUES FROM ('202501') TO ('202502');
CREATE TABLE T_JOURNAL_HEADER_202502 PARTITION OF T_JOURNAL_HEADER
    FOR VALUES FROM ('202502') TO ('202503');
-- 以降、月ごとに作成

CREATE INDEX IX_T_JOURNAL_DATE ON T_JOURNAL_HEADER (company_cd, slip_date);
CREATE INDEX IX_T_JOURNAL_PERIOD ON T_JOURNAL_HEADER (company_cd, fiscal_period);
CREATE INDEX IX_T_JOURNAL_STATUS ON T_JOURNAL_HEADER (company_cd, status) WHERE status != '20';
CREATE INDEX IX_T_JOURNAL_SOURCE ON T_JOURNAL_HEADER (source_type, source_id);

COMMENT ON TABLE T_JOURNAL_HEADER IS '仕訳ヘッダ';
COMMENT ON COLUMN T_JOURNAL_HEADER.source_type IS '発生元区分（01:手入力 02:AR 03:AP 04:FA 05:CM 06:IF 99:その他）';
```

### 3.2 仕訳明細（T_JOURNAL_DETAIL）

```sql
-- ================================================
-- テーブル名: T_JOURNAL_DETAIL（仕訳明細）
-- ================================================
CREATE TABLE T_JOURNAL_DETAIL (
    -- 主キー
    journal_id              BIGINT              NOT NULL,
    line_no                 SMALLINT            NOT NULL,

    -- 借貸・科目
    dr_cr                   CHAR(1)             NOT NULL,   -- D:借方 C:貸方
    account_cd              CHAR(7)             NOT NULL,
    sub_account_cd          VARCHAR(10),                    -- 補助科目（取引先等）

    -- 金額（取引通貨）
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',
    amount_orig             DECIMAL(18,2)       NOT NULL,   -- 取引通貨金額
    fx_rate                 DECIMAL(18,6)       DEFAULT 1,
    amount_base             DECIMAL(18,2)       NOT NULL,   -- 基軸通貨金額

    -- 税情報
    tax_cd                  CHAR(10),
    tax_amount              DECIMAL(18,2)       DEFAULT 0,
    tax_base                DECIMAL(18,2)       DEFAULT 0,  -- 課税標準額
    invoice_no              CHAR(14),                       -- インボイス番号

    -- セグメント
    segment_pc              VARCHAR(10),                    -- プロフィットセンター
    segment_cc              VARCHAR(10),                    -- コストセンター
    segment_prj             VARCHAR(20),                    -- プロジェクト
    segment_unit            VARCHAR(20),                    -- 物件ユニット
    segment_pf              VARCHAR(20),                    -- ポートフォリオ

    -- 取引先
    partner_type            CHAR(1),
    partner_cd              VARCHAR(10),

    -- 摘要
    line_description        VARCHAR(200),

    -- 参照
    ref_doc_type            CHAR(2),                        -- 参照文書種別
    ref_doc_id              VARCHAR(50),                    -- 参照文書ID

    -- 消込
    clearing_status         CHAR(1)             DEFAULT '0',-- 消込ステータス
    clearing_id             VARCHAR(50),                    -- 消込ID

    CONSTRAINT PK_T_JOURNAL_DETAIL PRIMARY KEY (journal_id, line_no),
    CONSTRAINT FK_T_JOURNAL_DTL_HDR FOREIGN KEY (journal_id)
        REFERENCES T_JOURNAL_HEADER (journal_id) ON DELETE CASCADE,
    CONSTRAINT CK_T_JOURNAL_DRCR CHECK (dr_cr IN ('D','C'))
);

CREATE INDEX IX_T_JOURNAL_DTL_ACC ON T_JOURNAL_DETAIL (account_cd, dr_cr);
CREATE INDEX IX_T_JOURNAL_DTL_PARTNER ON T_JOURNAL_DETAIL (partner_cd) WHERE partner_cd IS NOT NULL;
CREATE INDEX IX_T_JOURNAL_DTL_SEGMENT ON T_JOURNAL_DETAIL (segment_pc, segment_cc);
CREATE INDEX IX_T_JOURNAL_DTL_CLEARING ON T_JOURNAL_DETAIL (clearing_status) WHERE clearing_status = '0';

COMMENT ON TABLE T_JOURNAL_DETAIL IS '仕訳明細';
```

### 3.3 勘定残高（T_ACCOUNT_BALANCE）

```sql
-- ================================================
-- テーブル名: T_ACCOUNT_BALANCE（勘定残高）
-- 目的: 月次勘定残高を管理
-- パーティション: 会計期間で月次
-- ================================================
CREATE TABLE T_ACCOUNT_BALANCE (
    -- 主キー
    company_cd              CHAR(4)             NOT NULL,
    fiscal_period           CHAR(6)             NOT NULL,   -- YYYYMM
    account_cd              CHAR(7)             NOT NULL,
    sub_account_cd          VARCHAR(10)         NOT NULL DEFAULT '*',
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',
    segment_pc              VARCHAR(10)         NOT NULL DEFAULT '*',
    segment_cc              VARCHAR(10)         NOT NULL DEFAULT '*',

    -- 残高
    opening_balance         DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 期首残高
    debit_amount            DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 借方発生額
    credit_amount           DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 貸方発生額
    closing_balance         DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 期末残高

    -- 基軸通貨残高
    opening_balance_base    DECIMAL(18,2)       NOT NULL DEFAULT 0,
    debit_amount_base       DECIMAL(18,2)       NOT NULL DEFAULT 0,
    credit_amount_base      DECIMAL(18,2)       NOT NULL DEFAULT 0,
    closing_balance_base    DECIMAL(18,2)       NOT NULL DEFAULT 0,

    -- 確定フラグ
    confirmed_flag          CHAR(1)             NOT NULL DEFAULT '0',
    confirmed_at            TIMESTAMP WITH TIME ZONE,

    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,

    CONSTRAINT PK_T_ACCOUNT_BALANCE PRIMARY KEY
        (company_cd, fiscal_period, account_cd, sub_account_cd, currency_cd, segment_pc, segment_cc)
) PARTITION BY RANGE (fiscal_period);

CREATE INDEX IX_T_ACC_BAL_ACCOUNT ON T_ACCOUNT_BALANCE (company_cd, account_cd, fiscal_period);

COMMENT ON TABLE T_ACCOUNT_BALANCE IS '勘定残高';
```

---

## 4. トランザクションテーブル（AR/AP）

### 4.1 請求書ヘッダ（T_INVOICE_HEADER）

```sql
-- ================================================
-- テーブル名: T_INVOICE_HEADER（請求書ヘッダ）
-- 目的: 売上請求書・仕入請求書のヘッダ情報
-- ================================================
CREATE TABLE T_INVOICE_HEADER (
    -- 主キー
    invoice_id              BIGINT              NOT NULL,

    -- 会社・区分
    company_cd              CHAR(4)             NOT NULL,
    invoice_type            CHAR(1)             NOT NULL,   -- S:売上 P:仕入

    -- 請求書情報
    invoice_no              VARCHAR(30)         NOT NULL,   -- 請求書番号
    invoice_date            DATE                NOT NULL,   -- 請求日
    due_date                DATE                NOT NULL,   -- 支払期日
    partner_cd              VARCHAR(10)         NOT NULL,   -- 取引先コード

    -- 金額
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',
    subtotal_amount         DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 税抜金額
    tax_amount              DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 消費税額
    total_amount            DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 税込金額
    amount_base             DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 基軸通貨金額

    -- 消込
    cleared_amount          DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 消込済金額
    open_amount             DECIMAL(18,2)       NOT NULL DEFAULT 0,     -- 未消込金額
    clearing_status         CHAR(1)             NOT NULL DEFAULT '0',   -- 0:未消込 1:部分消込 2:消込済

    -- インボイス（仕入の場合）
    qualified_invoice_no    CHAR(14),                       -- 適格請求書番号
    qualified_invoice_flag  CHAR(1)             DEFAULT '0',-- 適格請求書フラグ

    -- 参照
    order_no                VARCHAR(30),                    -- 発注番号
    contract_no             VARCHAR(30),                    -- 契約番号

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '00',
    posted_flag             CHAR(1)             NOT NULL DEFAULT '0',
    journal_id              BIGINT,                         -- 計上仕訳ID

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_T_INVOICE_HEADER PRIMARY KEY (invoice_id),
    CONSTRAINT UK_T_INVOICE_NO UNIQUE (company_cd, invoice_type, invoice_no),
    CONSTRAINT FK_T_INVOICE_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT FK_T_INVOICE_PARTNER FOREIGN KEY (company_cd, partner_cd)
        REFERENCES M_PARTNER (company_cd, partner_cd)
);

CREATE INDEX IX_T_INVOICE_PARTNER ON T_INVOICE_HEADER (company_cd, partner_cd, invoice_type);
CREATE INDEX IX_T_INVOICE_DATE ON T_INVOICE_HEADER (company_cd, invoice_date);
CREATE INDEX IX_T_INVOICE_DUE ON T_INVOICE_HEADER (company_cd, due_date) WHERE clearing_status != '2';
CREATE INDEX IX_T_INVOICE_OPEN ON T_INVOICE_HEADER (company_cd, clearing_status) WHERE clearing_status != '2';

COMMENT ON TABLE T_INVOICE_HEADER IS '請求書ヘッダ';
```

### 4.2 消込テーブル（T_CLEARING）

```sql
-- ================================================
-- テーブル名: T_CLEARING（消込）
-- 目的: AR/AP/CMの消込情報を管理
-- ================================================
CREATE TABLE T_CLEARING (
    -- 主キー
    clearing_id             BIGINT              NOT NULL,

    -- 会社
    company_cd              CHAR(4)             NOT NULL,

    -- 消込元（入金/支払）
    receipt_payment_type    CHAR(1)             NOT NULL,   -- R:入金 P:支払
    receipt_payment_id      BIGINT              NOT NULL,   -- 入金/支払ID

    -- 消込先（請求書等）
    document_type           CHAR(2)             NOT NULL,   -- IN:請求書 RT:賃料 DV:配当 DP:敷金
    document_id             BIGINT              NOT NULL,   -- 文書ID

    -- 消込金額
    clear_amount            DECIMAL(18,2)       NOT NULL,   -- 消込金額
    clear_amount_base       DECIMAL(18,2)       NOT NULL,   -- 基軸通貨消込金額
    clear_date              DATE                NOT NULL,   -- 消込日

    -- 消込情報
    clear_type              CHAR(1)             NOT NULL,   -- A:自動 M:手動
    match_score             SMALLINT,                       -- マッチスコア
    match_reasons           JSONB,                          -- マッチ理由

    -- ステータス
    status                  CHAR(1)             NOT NULL DEFAULT 'A',   -- A:有効 R:取消
    reversal_date           DATE,
    reversal_reason         VARCHAR(200),

    -- 仕訳
    journal_id              BIGINT,

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,

    CONSTRAINT PK_T_CLEARING PRIMARY KEY (clearing_id),
    CONSTRAINT FK_T_CLEARING_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd)
);

CREATE INDEX IX_T_CLEARING_RECEIPT ON T_CLEARING (receipt_payment_type, receipt_payment_id);
CREATE INDEX IX_T_CLEARING_DOCUMENT ON T_CLEARING (document_type, document_id);
CREATE INDEX IX_T_CLEARING_DATE ON T_CLEARING (company_cd, clear_date);

COMMENT ON TABLE T_CLEARING IS '消込テーブル';
```

---

## 5. トランザクションテーブル（固定資産）

### 5.1 固定資産台帳（T_FIXED_ASSET）

```sql
-- ================================================
-- テーブル名: T_FIXED_ASSET（固定資産台帳）
-- 目的: 固定資産の取得から除却までを管理
-- ================================================
CREATE TABLE T_FIXED_ASSET (
    -- 主キー
    asset_id                VARCHAR(20)         NOT NULL,

    -- 会社
    company_cd              CHAR(4)             NOT NULL,

    -- 基本情報
    asset_name              VARCHAR(200)        NOT NULL,
    asset_category          CHAR(4)             NOT NULL,   -- 資産区分
    asset_sub_category      CHAR(4),
    acquisition_date        DATE                NOT NULL,
    service_start_date      DATE                NOT NULL,

    -- 取得原価
    acquisition_cost        DECIMAL(18,2)       NOT NULL,
    acquisition_cost_base   DECIMAL(18,2)       NOT NULL,
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',

    -- 償却情報（会計）
    acc_useful_life_months  INTEGER             NOT NULL,
    acc_depreciation_method CHAR(4)             NOT NULL,
    acc_residual_value      DECIMAL(18,2)       NOT NULL DEFAULT 1,
    acc_depreciation_rate   DECIMAL(8,5),
    acc_accum_depreciation  DECIMAL(18,2)       NOT NULL DEFAULT 0,
    acc_book_value          DECIMAL(18,2)       NOT NULL,

    -- 償却情報（税務）
    tax_useful_life_months  INTEGER             NOT NULL,
    tax_depreciation_method CHAR(4)             NOT NULL,
    tax_residual_value      DECIMAL(18,2)       NOT NULL DEFAULT 1,
    tax_depreciation_rate   DECIMAL(8,5),
    tax_guarantee_amount    DECIMAL(18,2),
    tax_revised_rate        DECIMAL(8,5),
    tax_switched_flag       CHAR(1)             NOT NULL DEFAULT '0',
    tax_accum_depreciation  DECIMAL(18,2)       NOT NULL DEFAULT 0,
    tax_book_value          DECIMAL(18,2)       NOT NULL,

    -- 減損
    impairment_loss         DECIMAL(18,2)       DEFAULT 0,
    impairment_date         DATE,

    -- 管理情報
    location_cd             VARCHAR(20),
    location_name           VARCHAR(100),
    dept_cd                 CHAR(6),
    user_id                 VARCHAR(20),

    -- セグメント
    segment_pc              VARCHAR(10),
    segment_cc              VARCHAR(10),
    segment_prj             VARCHAR(20),
    segment_unit            VARCHAR(20),        -- 物件ユニット

    -- 構成要素
    parent_asset_id         VARCHAR(20),
    component_type          CHAR(1),            -- M:主 A:付属 C:構成要素

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',  -- 01:稼働中 02:休止 03:除却
    disposal_date           DATE,
    disposal_type           CHAR(1),
    disposal_amount         DECIMAL(18,2),

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_T_FIXED_ASSET PRIMARY KEY (asset_id),
    CONSTRAINT FK_T_FA_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd),
    CONSTRAINT CK_T_FA_DEP_METHOD CHECK (acc_depreciation_method IN ('SL','DB','DB250','DB200','NONE'))
);

CREATE INDEX IX_T_FA_COMPANY ON T_FIXED_ASSET (company_cd, status);
CREATE INDEX IX_T_FA_CATEGORY ON T_FIXED_ASSET (company_cd, asset_category);
CREATE INDEX IX_T_FA_SEGMENT ON T_FIXED_ASSET (segment_pc, segment_unit);

COMMENT ON TABLE T_FIXED_ASSET IS '固定資産台帳';
COMMENT ON COLUMN T_FIXED_ASSET.acc_depreciation_method IS '償却方法（SL:定額法 DB:定率法 DB250:250%定率法 NONE:非償却）';
```

### 5.2 償却履歴（T_DEPRECIATION_HISTORY）

```sql
-- ================================================
-- テーブル名: T_DEPRECIATION_HISTORY（償却履歴）
-- ================================================
CREATE TABLE T_DEPRECIATION_HISTORY (
    -- 主キー
    depreciation_id         BIGINT              NOT NULL,

    -- 資産
    asset_id                VARCHAR(20)         NOT NULL,
    fiscal_period           CHAR(6)             NOT NULL,   -- YYYYMM

    -- 償却額（会計）
    acc_depreciation        DECIMAL(18,2)       NOT NULL,
    acc_accum_depreciation  DECIMAL(18,2)       NOT NULL,
    acc_book_value          DECIMAL(18,2)       NOT NULL,

    -- 償却額（税務）
    tax_depreciation        DECIMAL(18,2)       NOT NULL,
    tax_accum_depreciation  DECIMAL(18,2)       NOT NULL,
    tax_book_value          DECIMAL(18,2)       NOT NULL,

    -- 差異
    difference_amount       DECIMAL(18,2)       NOT NULL DEFAULT 0,

    -- 仕訳
    journal_id              BIGINT,

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,

    CONSTRAINT PK_T_DEPRECIATION_HISTORY PRIMARY KEY (depreciation_id),
    CONSTRAINT UK_T_DEP_HIST UNIQUE (asset_id, fiscal_period),
    CONSTRAINT FK_T_DEP_HIST_ASSET FOREIGN KEY (asset_id)
        REFERENCES T_FIXED_ASSET (asset_id)
);

COMMENT ON TABLE T_DEPRECIATION_HISTORY IS '償却履歴';
```

---

## 6. トランザクションテーブル（不動産）

### 6.1 物件マスタ（M_PROPERTY）

```sql
-- ================================================
-- テーブル名: M_PROPERTY（物件マスタ）
-- 目的: 不動産物件の基本情報を管理
-- ================================================
CREATE TABLE M_PROPERTY (
    -- 主キー
    company_cd              CHAR(4)             NOT NULL,
    property_cd             VARCHAR(20)         NOT NULL,

    -- 基本情報
    property_name           VARCHAR(200)        NOT NULL,
    property_name_short     VARCHAR(50),
    property_type           CHAR(2)             NOT NULL,   -- 01:オフィス 02:住居 03:商業 04:物流
    address                 VARCHAR(200),
    postal_code             CHAR(8),

    -- 面積・構造
    total_area              DECIMAL(12,2),                  -- 延床面積（m2）
    land_area               DECIMAL(12,2),                  -- 敷地面積（m2）
    structure               VARCHAR(50),                    -- 構造
    floors_above            SMALLINT,                       -- 地上階数
    floors_below            SMALLINT,                       -- 地下階数
    built_year              CHAR(4),                        -- 竣工年

    -- 取得情報
    acquisition_date        DATE,
    acquisition_cost        DECIMAL(18,2),
    building_value          DECIMAL(18,2),                  -- 建物取得価額
    land_value              DECIMAL(18,2),                  -- 土地取得価額

    -- セグメント
    segment_pf              VARCHAR(20),                    -- ポートフォリオ

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_M_PROPERTY PRIMARY KEY (company_cd, property_cd),
    CONSTRAINT FK_M_PROPERTY_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd)
);

COMMENT ON TABLE M_PROPERTY IS '物件マスタ';
```

### 6.2 賃貸借契約（T_LEASE_CONTRACT）

```sql
-- ================================================
-- テーブル名: T_LEASE_CONTRACT（賃貸借契約）
-- ================================================
CREATE TABLE T_LEASE_CONTRACT (
    -- 主キー
    contract_id             BIGINT              NOT NULL,

    -- 会社・物件
    company_cd              CHAR(4)             NOT NULL,
    property_cd             VARCHAR(20)         NOT NULL,
    unit_cd                 VARCHAR(20)         NOT NULL,   -- 区画コード

    -- テナント
    tenant_cd               VARCHAR(10)         NOT NULL,   -- テナント（取引先）コード
    tenant_name             VARCHAR(100)        NOT NULL,

    -- 契約期間
    contract_date           DATE                NOT NULL,
    contract_start_date     DATE                NOT NULL,
    contract_end_date       DATE                NOT NULL,
    renewal_type            CHAR(1),                        -- 更新種別

    -- 賃料
    monthly_rent            DECIMAL(18,2)       NOT NULL,   -- 月額賃料
    common_fee              DECIMAL(18,2)       DEFAULT 0,  -- 共益費
    parking_fee             DECIMAL(18,2)       DEFAULT 0,  -- 駐車場代
    tax_category            CHAR(2)             NOT NULL,   -- 課税/非課税

    -- 敷金・保証金
    deposit_months          DECIMAL(4,1),                   -- 敷金月数
    deposit_amount          DECIMAL(18,2)       DEFAULT 0,  -- 敷金金額
    key_money               DECIMAL(18,2)       DEFAULT 0,  -- 礼金

    -- 支払条件
    payment_day             SMALLINT,                       -- 支払日
    payment_method          CHAR(2),                        -- 支払方法

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',  -- 01:有効 02:終了 03:解約

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_T_LEASE_CONTRACT PRIMARY KEY (contract_id),
    CONSTRAINT FK_T_LEASE_PROPERTY FOREIGN KEY (company_cd, property_cd)
        REFERENCES M_PROPERTY (company_cd, property_cd)
);

CREATE INDEX IX_T_LEASE_PROPERTY ON T_LEASE_CONTRACT (company_cd, property_cd);
CREATE INDEX IX_T_LEASE_TENANT ON T_LEASE_CONTRACT (tenant_cd);
CREATE INDEX IX_T_LEASE_STATUS ON T_LEASE_CONTRACT (status, contract_end_date);

COMMENT ON TABLE T_LEASE_CONTRACT IS '賃貸借契約';
```

---

## 7. トランザクションテーブル（有価証券）

### 7.1 有価証券保有（T_SECURITY_HOLDING）

```sql
-- ================================================
-- テーブル名: T_SECURITY_HOLDING（有価証券保有）
-- ================================================
CREATE TABLE T_SECURITY_HOLDING (
    -- 主キー
    holding_id              BIGINT              NOT NULL,

    -- 会社
    company_cd              CHAR(4)             NOT NULL,

    -- 銘柄情報
    security_cd             VARCHAR(20)         NOT NULL,   -- 銘柄コード
    security_name           VARCHAR(200)        NOT NULL,
    security_type           CHAR(2)             NOT NULL,   -- 01:株式 02:債券 03:投信 04:REIT
    holding_purpose         CHAR(2)             NOT NULL,   -- 01:売買 02:満期保有 03:AFS 04:子会社

    -- 取得情報
    acquisition_date        DATE                NOT NULL,
    quantity                DECIMAL(18,4)       NOT NULL,
    acquisition_price       DECIMAL(18,6)       NOT NULL,   -- 取得単価
    acquisition_cost        DECIMAL(18,2)       NOT NULL,   -- 取得原価
    currency_cd             CHAR(3)             NOT NULL DEFAULT 'JPY',

    -- 評価情報
    current_quantity        DECIMAL(18,4)       NOT NULL,   -- 現在保有数量
    book_value              DECIMAL(18,2)       NOT NULL,   -- 帳簿価額
    fair_value              DECIMAL(18,2),                  -- 時価
    fair_value_date         DATE,
    valuation_diff          DECIMAL(18,2)       DEFAULT 0,  -- 評価差額

    -- 債券情報
    face_value              DECIMAL(18,2),                  -- 額面金額
    coupon_rate             DECIMAL(8,5),                   -- クーポンレート
    maturity_date           DATE,                           -- 満期日
    amortized_cost          DECIMAL(18,2),                  -- 償却原価

    -- セグメント
    segment_pf              VARCHAR(20),                    -- ポートフォリオ

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',  -- 01:保有中 02:売却済 03:償還

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,
    version                 INTEGER             NOT NULL DEFAULT 1,

    CONSTRAINT PK_T_SECURITY_HOLDING PRIMARY KEY (holding_id),
    CONSTRAINT FK_T_SEC_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd)
);

CREATE INDEX IX_T_SEC_COMPANY ON T_SECURITY_HOLDING (company_cd, status);
CREATE INDEX IX_T_SEC_CODE ON T_SECURITY_HOLDING (security_cd);
CREATE INDEX IX_T_SEC_PURPOSE ON T_SECURITY_HOLDING (holding_purpose);

COMMENT ON TABLE T_SECURITY_HOLDING IS '有価証券保有';
COMMENT ON COLUMN T_SECURITY_HOLDING.holding_purpose IS '保有目的（01:売買目的 02:満期保有 03:その他有価証券 04:子会社株式）';
```

---

## 8. システムテーブル

### 8.1 監査ログ（T_AUDIT_LOG）

```sql
-- ================================================
-- テーブル名: T_AUDIT_LOG（監査ログ）
-- パーティション: 日付で月次
-- ================================================
CREATE TABLE T_AUDIT_LOG (
    -- 主キー
    log_id                  BIGINT              NOT NULL,

    -- 日時
    log_timestamp           TIMESTAMP WITH TIME ZONE NOT NULL,
    log_date                DATE                NOT NULL,

    -- ユーザー情報
    user_id                 VARCHAR(50)         NOT NULL,
    user_name               VARCHAR(100),
    client_ip               INET,
    session_id              VARCHAR(100),

    -- 操作情報
    action_type             VARCHAR(20)         NOT NULL,   -- CREATE/UPDATE/DELETE/VIEW/APPROVE/etc.
    resource_type           VARCHAR(50)         NOT NULL,   -- テーブル名/機能名
    resource_id             VARCHAR(100),                   -- 対象ID
    company_cd              CHAR(4),

    -- 詳細
    before_value            JSONB,                          -- 変更前値
    after_value             JSONB,                          -- 変更後値
    description             TEXT,

    -- ハッシュチェーン（改ざん検知）
    previous_hash           CHAR(64),                       -- 前レコードのハッシュ
    record_hash             CHAR(64)            NOT NULL,   -- 当レコードのハッシュ

    CONSTRAINT PK_T_AUDIT_LOG PRIMARY KEY (log_id)
) PARTITION BY RANGE (log_date);

CREATE INDEX IX_T_AUDIT_LOG_USER ON T_AUDIT_LOG (user_id, log_timestamp);
CREATE INDEX IX_T_AUDIT_LOG_RESOURCE ON T_AUDIT_LOG (resource_type, resource_id);
CREATE INDEX IX_T_AUDIT_LOG_DATE ON T_AUDIT_LOG (log_date);

COMMENT ON TABLE T_AUDIT_LOG IS '監査ログ';
COMMENT ON COLUMN T_AUDIT_LOG.record_hash IS 'SHA256ハッシュ（user_id + timestamp + action + before + after + previous_hash）';
```

### 8.2 証憑テーブル（T_EVIDENCE）

```sql
-- ================================================
-- テーブル名: T_EVIDENCE（証憑）
-- 目的: 電子証憑の管理（電帳法対応）
-- ================================================
CREATE TABLE T_EVIDENCE (
    -- 主キー
    evidence_id             BIGINT              NOT NULL,

    -- 会社
    company_cd              CHAR(4)             NOT NULL,

    -- 証憑情報
    evidence_type           CHAR(2)             NOT NULL,   -- 01:請求書 02:領収書 03:契約書 04:見積書
    file_name               VARCHAR(200)        NOT NULL,
    file_path               VARCHAR(500)        NOT NULL,
    file_size               BIGINT              NOT NULL,
    mime_type               VARCHAR(50)         NOT NULL,

    -- 電帳法検索項目（必須3項目）
    transaction_date        DATE                NOT NULL,
    transaction_amount      DECIMAL(18,2)       NOT NULL,
    partner_name            VARCHAR(100)        NOT NULL,

    -- 追加検索項目
    document_no             VARCHAR(50),
    description             VARCHAR(500),

    -- 真実性確保
    timestamp_token         TEXT,                           -- タイムスタンプトークン
    timestamp_at            TIMESTAMP WITH TIME ZONE,
    hash_value              CHAR(64)            NOT NULL,   -- SHA256

    -- 関連
    related_doc_type        CHAR(2),                        -- 関連文書種別
    related_doc_id          BIGINT,                         -- 関連文書ID

    -- ステータス
    status                  CHAR(2)             NOT NULL DEFAULT '01',
    verified_flag           CHAR(1)             NOT NULL DEFAULT '0',

    -- 監査項目
    created_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by              VARCHAR(50)         NOT NULL,
    updated_at              TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by              VARCHAR(50)         NOT NULL,

    CONSTRAINT PK_T_EVIDENCE PRIMARY KEY (evidence_id),
    CONSTRAINT FK_T_EVIDENCE_COMPANY FOREIGN KEY (company_cd)
        REFERENCES M_COMPANY (company_cd)
);

-- 電帳法検索用インデックス
CREATE INDEX IX_T_EVIDENCE_DATE ON T_EVIDENCE (company_cd, transaction_date);
CREATE INDEX IX_T_EVIDENCE_AMOUNT ON T_EVIDENCE (company_cd, transaction_amount);
CREATE INDEX IX_T_EVIDENCE_PARTNER ON T_EVIDENCE (company_cd, partner_name);
CREATE INDEX IX_T_EVIDENCE_DOCNO ON T_EVIDENCE (company_cd, document_no);

COMMENT ON TABLE T_EVIDENCE IS '証憑テーブル（電帳法対応）';
```

---

## 9. パーティション設計

### 9.1 パーティション対象テーブル

| テーブル | パーティションキー | 分割単位 | 保持期間 |
|----------|-------------------|----------|----------|
| T_JOURNAL_HEADER | fiscal_period | 月次 | 10年 |
| T_ACCOUNT_BALANCE | fiscal_period | 月次 | 10年 |
| T_AUDIT_LOG | log_date | 月次 | 7年 |
| T_DEPRECIATION_HISTORY | fiscal_period | 月次 | 10年 |

### 9.2 パーティションメンテナンススクリプト

```sql
-- 新月度パーティション作成（月次バッチで実行）
CREATE OR REPLACE FUNCTION create_monthly_partitions(target_month CHAR(6))
RETURNS VOID AS $$
DECLARE
    next_month CHAR(6);
BEGIN
    next_month := to_char(to_date(target_month || '01', 'YYYYMMDD') + interval '1 month', 'YYYYMM');

    -- T_JOURNAL_HEADER
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS T_JOURNAL_HEADER_%s PARTITION OF T_JOURNAL_HEADER
         FOR VALUES FROM (%L) TO (%L)',
        target_month, target_month, next_month
    );

    -- T_ACCOUNT_BALANCE
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS T_ACCOUNT_BALANCE_%s PARTITION OF T_ACCOUNT_BALANCE
         FOR VALUES FROM (%L) TO (%L)',
        target_month, target_month, next_month
    );

    -- T_AUDIT_LOG
    EXECUTE format(
        'CREATE TABLE IF NOT EXISTS T_AUDIT_LOG_%s PARTITION OF T_AUDIT_LOG
         FOR VALUES FROM (%L) TO (%L)',
        target_month,
        to_date(target_month || '01', 'YYYYMMDD'),
        to_date(target_month || '01', 'YYYYMMDD') + interval '1 month'
    );
END;
$$ LANGUAGE plpgsql;

-- 実行例
SELECT create_monthly_partitions('202501');
```

---

## 10. インデックス設計方針

### 10.1 インデックス種別

| 種別 | 用途 | 対象 |
|------|------|------|
| 主キー | 一意性制約、検索 | 全テーブル |
| ユニーク | 業務上の一意性 | 伝票番号、請求書番号等 |
| 通常 | 検索性能 | WHERE句、JOIN句の頻出カラム |
| 部分 | 特定条件の検索 | 未消込データ、有効データ等 |
| 複合 | 複数条件の検索 | 会社コード+日付等 |
| GIN | JSONB検索 | 監査ログの詳細検索 |

### 10.2 主要インデックス一覧

| テーブル | インデックス | カラム | 種別 |
|----------|-------------|--------|------|
| T_JOURNAL_HEADER | UK_T_JOURNAL_SLIP | company_cd, slip_no | UNIQUE |
| T_JOURNAL_HEADER | IX_T_JOURNAL_DATE | company_cd, slip_date | BTREE |
| T_JOURNAL_DETAIL | IX_T_JOURNAL_DTL_ACC | account_cd, dr_cr | BTREE |
| T_INVOICE_HEADER | IX_T_INVOICE_OPEN | company_cd, clearing_status | PARTIAL |
| T_FIXED_ASSET | IX_T_FA_SEGMENT | segment_pc, segment_unit | BTREE |
| T_EVIDENCE | IX_T_EVIDENCE_DATE | company_cd, transaction_date | BTREE |
| T_AUDIT_LOG | IX_T_AUDIT_LOG_RESOURCE | resource_type, resource_id | BTREE |

---

## 11. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2025/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] 命名規約が統一されているか
- [ ] データ型が適切か（特に金額、為替レート）
- [ ] 主キー、外部キーが正しく設定されているか
- [ ] NOT NULL制約が適切に設定されているか
- [ ] CHECK制約で値の整合性が保たれているか
- [ ] パーティション設計が性能要件を満たしているか
- [ ] インデックスが主要な検索パターンをカバーしているか
- [ ] 監査項目（created_at等）が全テーブルに含まれているか
- [ ] インボイス番号カラムが適切に設計されているか
- [ ] 電帳法対応（検索項目、タイムスタンプ）が考慮されているか
- [ ] セグメント（PC/CC/PRJ/UNIT/PF）が必要なテーブルに設定されているか
- [ ] J-SOX統制要件（監査ログ、改ざん検知）を満たしているか
- [ ] DBAのレビューを受けているか
