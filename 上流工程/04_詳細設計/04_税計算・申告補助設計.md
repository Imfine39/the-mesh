# 税計算・申告補助設計

| 項目 | 内容 |
|------|------|
| 文書番号 | DET-TAX-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2025/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. 税計算機能概要

### 1.1 対象税目

本システムで対応する税目は以下の通り。

| 税目 | 対応機能 | 主な処理 |
|------|----------|----------|
| 消費税 | 売上税額・仕入税額控除計算 | インボイス対応、税率判定、申告書作成支援 |
| 法人税 | 申告調整項目抽出 | 税会差異管理、別表作成支援 |
| 源泉所得税 | 源泉徴収税額計算 | 報酬・給与・配当の源泉計算 |
| 住民税 | 均等割・法人税割計算 | 事業所別集計 |
| 事業税 | 所得割・付加価値割計算 | 外形標準課税対応 |
| 固定資産税 | 償却資産申告支援 | 台帳データ出力 |
| 印紙税 | 課税文書管理 | 契約書の印紙税計算 |

### 1.2 税計算システム構成

```typescript
// ============================================================
// 税計算システム アーキテクチャ
// ============================================================

interface TaxCalculationSystem {
  // 消費税モジュール
  consumptionTax: {
    taxCategoryEngine: TaxCategoryEngine;        // 税区分判定エンジン
    salesTaxCalculator: SalesTaxCalculator;      // 売上税額計算
    inputTaxCalculator: InputTaxCalculator;      // 仕入税額控除計算
    invoiceValidator: InvoiceValidator;          // インボイス検証
    transitionalMeasure: TransitionalMeasureService; // 経過措置
    returnDataGenerator: ConsumptionTaxReturnGenerator; // 申告書データ
  };

  // 法人税モジュール
  corporateTax: {
    taxAdjustmentExtractor: TaxAdjustmentExtractor;  // 申告調整抽出
    scheduleGenerator: TaxScheduleGenerator;          // 別表生成
    deferredTaxCalculator: DeferredTaxCalculator;    // 税効果計算
  };

  // 源泉所得税モジュール
  withholdingTax: {
    compensationTaxCalculator: CompensationTaxCalculator;  // 報酬源泉
    dividendTaxCalculator: DividendTaxCalculator;          // 配当源泉
    interestTaxCalculator: InterestTaxCalculator;          // 利子源泉
  };

  // 共通サービス
  common: {
    taxCalendarService: TaxCalendarService;      // 税務カレンダー
    taxMasterService: TaxMasterService;          // 税率マスタ
    ntaApiClient: NTAApiClient;                  // 国税庁API連携
  };
}
```

---

## 2. 消費税計算

### 2.1 消費税計算フロー

```
[消費税計算フロー]

                              ┌────────────────────────────────────────┐
                              │        取引データ入力                   │
                              │  (売上伝票・仕入伝票・経費精算等)       │
                              └────────────────┬───────────────────────┘
                                               │
                                               ▼
                              ┌────────────────────────────────────────┐
                              │        税区分自動判定                   │
                              │  ・課税/非課税/免税/不課税              │
                              │  ・標準税率(10%)/軽減税率(8%)           │
                              │  ・仕入区分(課税売上対応/共通/非課税)   │
                              └────────────────┬───────────────────────┘
                                               │
            ┌──────────────────────────────────┼──────────────────────────────────┐
            │                                  │                                  │
            ▼                                  ▼                                  ▼
┌──────────────────────┐        ┌──────────────────────┐        ┌──────────────────────┐
│     売上処理         │        │     仕入処理         │        │    経過措置処理      │
│  ・課税売上集計      │        │  ・課税仕入集計      │        │  ・インボイス確認    │
│  ・輸出免税集計      │        │  ・インボイス確認    │        │  ・控除率適用        │
│  ・非課税売上集計    │        │  ・仕入区分判定      │        │  ・80%/50%/0%判定    │
└──────────┬───────────┘        └──────────┬───────────┘        └──────────┬───────────┘
           │                               │                               │
           └───────────────────────────────┼───────────────────────────────┘
                                           │
                                           ▼
                              ┌────────────────────────────────────────┐
                              │        課税売上割合計算                 │
                              │  (課税+免税) / (課税+免税+非課税)       │
                              └────────────────┬───────────────────────┘
                                               │
                         ┌─────────────────────┼─────────────────────┐
                         ▼                     ▼                     ▼
              ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
              │   ≥95%          │   │   <95%          │   │  <95%           │
              │   全額控除      │   │  個別対応方式   │   │ 一括比例配分    │
              └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
                       │                     │                     │
                       └─────────────────────┼─────────────────────┘
                                             │
                                             ▼
                              ┌────────────────────────────────────────┐
                              │        納付税額計算                     │
                              │  売上税額 - 仕入税額控除 = 納付税額    │
                              └────────────────────────────────────────┘
```

### 2.2 税区分判定エンジン

```typescript
// ============================================================
// 税区分判定エンジン
// ============================================================

type TaxCategory =
  | 'S10'      // 課税売上10%
  | 'S08'      // 課税売上8%（軽減税率）
  | 'S00'      // 免税売上（輸出等）
  | 'SN'       // 非課税売上
  | 'SO'       // 不課税売上
  | 'P10'      // 課税仕入10%（インボイスあり・全額控除）
  | 'P10N80'   // 課税仕入10%（インボイスなし・80%控除）
  | 'P10N50'   // 課税仕入10%（インボイスなし・50%控除）
  | 'P10N00'   // 課税仕入10%（インボイスなし・控除不可）
  | 'P08'      // 課税仕入8%（軽減税率・インボイスあり）
  | 'P08N80'   // 課税仕入8%（軽減税率・80%控除）
  | 'P08N50'   // 課税仕入8%（軽減税率・50%控除）
  | 'P08N00'   // 課税仕入8%（軽減税率・控除不可）
  | 'PN'       // 非課税仕入
  | 'PO'       // 不課税仕入
  | 'XX';      // 対象外

type PurchasePurpose =
  | 'TAXABLE_ONLY'       // 課税売上にのみ対応
  | 'NON_TAXABLE_ONLY'   // 非課税売上にのみ対応
  | 'COMMON';            // 共通対応

interface TaxCategoryResult {
  taxCategory: TaxCategory;
  taxRate: Decimal;              // 税率
  deductionRate: Decimal;        // 控除率
  purchasePurpose?: PurchasePurpose; // 仕入区分（仕入の場合）
  reason: string;                // 判定理由
}

interface TransactionForTax {
  transactionType: 'SALES' | 'PURCHASE' | 'EXPENSE';
  transactionDate: Date;
  productServiceCode?: string;
  vendorCustomerId?: string;
  isExport: boolean;
  isDomestic: boolean;
  hasConsideration: boolean;
  isBusiness: boolean;
  invoiceNumber?: string;
  invoiceDate?: Date;
  invoiceVerified?: boolean;
  // 業種別属性
  propertyRelated?: boolean;      // 不動産関連
  securitiesRelated?: boolean;    // 有価証券関連
  consultingRelated?: boolean;    // コンサルティング関連
}

class TaxCategoryEngine {
  private taxMaster: TaxMasterService;
  private invoiceValidator: InvoiceValidator;
  private nonTaxableItems: Set<string>;
  private reducedRateItems: Set<string>;

  constructor(
    taxMaster: TaxMasterService,
    invoiceValidator: InvoiceValidator
  ) {
    this.taxMaster = taxMaster;
    this.invoiceValidator = invoiceValidator;
    this.initializeNonTaxableItems();
    this.initializeReducedRateItems();
  }

  /**
   * 税区分自動判定
   */
  async determineTaxCategory(
    transaction: TransactionForTax
  ): Promise<TaxCategoryResult> {
    // 1. 事業として行う取引か
    if (!transaction.isBusiness) {
      return this.createResult('SO', new Decimal(0), new Decimal(0), '事業外取引');
    }

    // 2. 対価を得て行う取引か
    if (!transaction.hasConsideration) {
      return this.createResult(
        transaction.transactionType === 'SALES' ? 'SO' : 'PO',
        new Decimal(0),
        new Decimal(0),
        '対価のない取引'
      );
    }

    // 3. 国内取引か
    if (!transaction.isDomestic) {
      if (transaction.transactionType === 'SALES' && transaction.isExport) {
        return this.createResult('S00', new Decimal(0), new Decimal(0), '輸出免税');
      }
      return this.createResult(
        transaction.transactionType === 'SALES' ? 'SO' : 'PO',
        new Decimal(0),
        new Decimal(0),
        '国外取引'
      );
    }

    // 4. 非課税取引か
    if (await this.isNonTaxable(transaction)) {
      return this.createResult(
        transaction.transactionType === 'SALES' ? 'SN' : 'PN',
        new Decimal(0),
        new Decimal(0),
        '非課税取引'
      );
    }

    // 5. 課税取引の場合
    if (transaction.transactionType === 'SALES') {
      return this.determineSalesTaxCategory(transaction);
    } else {
      return this.determinePurchaseTaxCategory(transaction);
    }
  }

  /**
   * 売上の税区分判定
   */
  private async determineSalesTaxCategory(
    transaction: TransactionForTax
  ): Promise<TaxCategoryResult> {
    // 輸出免税
    if (transaction.isExport) {
      return this.createResult('S00', new Decimal(0), new Decimal(0), '輸出免税');
    }

    // 軽減税率判定
    const isReduced = await this.isReducedRate(transaction);
    if (isReduced) {
      return this.createResult('S08', new Decimal(0.08), new Decimal(1), '軽減税率対象');
    }

    return this.createResult('S10', new Decimal(0.10), new Decimal(1), '標準税率');
  }

  /**
   * 仕入の税区分判定（インボイス制度対応）
   */
  private async determinePurchaseTaxCategory(
    transaction: TransactionForTax
  ): Promise<TaxCategoryResult> {
    // 軽減税率判定
    const isReduced = await this.isReducedRate(transaction);
    const taxRate = isReduced ? new Decimal(0.08) : new Decimal(0.10);
    const baseCode = isReduced ? 'P08' : 'P10';

    // インボイス検証
    const hasValidInvoice = await this.verifyInvoice(transaction);

    if (hasValidInvoice) {
      // インボイスあり: 全額控除
      return this.createResult(
        baseCode as TaxCategory,
        taxRate,
        new Decimal(1),
        'インボイスあり・全額控除'
      );
    }

    // インボイスなし: 経過措置適用
    const transitionResult = this.getTransitionalDeductionRate(transaction.transactionDate);

    if (transitionResult.rate.equals(0.80)) {
      return this.createResult(
        `${baseCode}N80` as TaxCategory,
        taxRate,
        transitionResult.rate,
        transitionResult.reason
      );
    } else if (transitionResult.rate.equals(0.50)) {
      return this.createResult(
        `${baseCode}N50` as TaxCategory,
        taxRate,
        transitionResult.rate,
        transitionResult.reason
      );
    } else {
      return this.createResult(
        `${baseCode}N00` as TaxCategory,
        taxRate,
        new Decimal(0),
        transitionResult.reason
      );
    }
  }

  /**
   * 非課税取引判定
   */
  private async isNonTaxable(transaction: TransactionForTax): Promise<boolean> {
    // 土地の譲渡・貸付（不動産業）
    if (transaction.propertyRelated) {
      const productCode = transaction.productServiceCode;
      if (productCode?.startsWith('LAND_')) {
        return true;  // 土地関連は非課税
      }
      if (productCode === 'RESIDENTIAL_RENT') {
        return true;  // 住宅の貸付は非課税
      }
    }

    // 有価証券の譲渡（有価証券業）
    if (transaction.securitiesRelated) {
      const productCode = transaction.productServiceCode;
      if (productCode?.startsWith('SEC_SALE_')) {
        return true;  // 有価証券売却は非課税
      }
    }

    // その他の非課税取引
    if (this.nonTaxableItems.has(transaction.productServiceCode || '')) {
      return true;
    }

    return false;
  }

  /**
   * 軽減税率対象判定
   */
  private async isReducedRate(transaction: TransactionForTax): Promise<boolean> {
    const productCode = transaction.productServiceCode;
    if (!productCode) return false;

    // 飲食料品（IT/コンサル、不動産、有価証券業では基本的に該当なし）
    if (productCode.startsWith('FOOD_')) {
      // 酒類は除外
      if (productCode.startsWith('FOOD_ALCOHOL_')) {
        return false;
      }
      // 外食は除外
      if (productCode.includes('_DINEIN')) {
        return false;
      }
      return true;
    }

    // 定期購読の新聞（週2回以上発行）
    if (productCode === 'NEWSPAPER_SUBSCRIPTION') {
      return true;
    }

    return false;
  }

  /**
   * 経過措置の控除率取得
   */
  private getTransitionalDeductionRate(transactionDate: Date): {
    rate: Decimal;
    reason: string;
  } {
    const invoiceStartDate = new Date('2023-10-01');
    const phase1EndDate = new Date('2026-10-01');
    const phase2EndDate = new Date('2029-10-01');

    if (transactionDate < invoiceStartDate) {
      return { rate: new Decimal(1), reason: 'インボイス制度施行前' };
    }

    if (transactionDate < phase1EndDate) {
      return { rate: new Decimal(0.80), reason: '経過措置期間（80%控除）' };
    }

    if (transactionDate < phase2EndDate) {
      return { rate: new Decimal(0.50), reason: '経過措置期間（50%控除）' };
    }

    return { rate: new Decimal(0), reason: '経過措置終了（控除不可）' };
  }

  /**
   * インボイス検証
   */
  private async verifyInvoice(transaction: TransactionForTax): Promise<boolean> {
    if (!transaction.invoiceNumber) {
      return false;
    }

    // 既に検証済みの場合
    if (transaction.invoiceVerified !== undefined) {
      return transaction.invoiceVerified;
    }

    // インボイス番号の検証
    const validationResult = await this.invoiceValidator.validate(
      transaction.invoiceNumber,
      transaction.invoiceDate || transaction.transactionDate
    );

    return validationResult.isValid;
  }

  /**
   * 非課税項目の初期化
   */
  private initializeNonTaxableItems(): void {
    this.nonTaxableItems = new Set([
      'LAND_SALE',           // 土地の譲渡
      'LAND_LEASE',          // 土地の貸付
      'SECURITIES_SALE',     // 有価証券の譲渡
      'LOAN_INTEREST',       // 利子
      'INSURANCE_PREMIUM',   // 保険料
      'POSTAL_STAMP',        // 郵便切手
      'REVENUE_STAMP',       // 印紙
      'RESIDENTIAL_RENT',    // 住宅の貸付
      'MEDICAL_SERVICE',     // 医療
      'EDUCATION_SERVICE',   // 教育
      'SOCIAL_WELFARE',      // 社会福祉
      'BURIAL_SERVICE',      // 埋葬
      'COMMODITY_BOND',      // 物品切手
    ]);
  }

  private createResult(
    taxCategory: TaxCategory,
    taxRate: Decimal,
    deductionRate: Decimal,
    reason: string
  ): TaxCategoryResult {
    return { taxCategory, taxRate, deductionRate, reason };
  }
}
```

### 2.3 インボイス番号検証

```typescript
// ============================================================
// インボイス番号検証サービス
// ============================================================

interface InvoiceValidationResult {
  isValid: boolean;
  invoiceNumber: string;
  businessName?: string;
  registrationDate?: Date;
  invalidReason?: string;
  verificationMethod: 'FORMAT' | 'NTA_API' | 'CACHE';
  verifiedAt: Date;
}

class InvoiceValidator {
  private ntaApiClient: NTAApiClient;
  private cache: InvoiceValidationCache;

  constructor(ntaApiClient: NTAApiClient, cache: InvoiceValidationCache) {
    this.ntaApiClient = ntaApiClient;
    this.cache = cache;
  }

  /**
   * インボイス番号検証メイン
   */
  async validate(
    invoiceNumber: string,
    transactionDate: Date
  ): Promise<InvoiceValidationResult> {
    const normalizedNumber = this.normalizeInvoiceNumber(invoiceNumber);

    // 1. 形式チェック
    const formatResult = this.validateFormat(normalizedNumber);
    if (!formatResult.isValid) {
      return formatResult;
    }

    // 2. キャッシュ確認
    const cachedResult = await this.cache.get(normalizedNumber);
    if (cachedResult && this.isCacheValid(cachedResult, transactionDate)) {
      return {
        ...cachedResult,
        verificationMethod: 'CACHE'
      };
    }

    // 3. 国税庁API照会
    try {
      const ntaResult = await this.ntaApiClient.verifyInvoiceNumber(normalizedNumber);

      const result: InvoiceValidationResult = {
        isValid: ntaResult.isRegistered,
        invoiceNumber: normalizedNumber,
        businessName: ntaResult.businessName,
        registrationDate: ntaResult.registrationDate,
        invalidReason: ntaResult.isRegistered ? undefined : '国税庁に登録なし',
        verificationMethod: 'NTA_API',
        verifiedAt: new Date()
      };

      // 登録日と取引日の整合性チェック
      if (result.isValid && result.registrationDate) {
        if (transactionDate < result.registrationDate) {
          result.isValid = false;
          result.invalidReason = '取引日が登録日より前';
        }
      }

      // キャッシュに保存
      await this.cache.set(normalizedNumber, result);

      return result;

    } catch (error) {
      // API呼び出し失敗時は形式チェックのみで判定
      console.error('NTA API verification failed:', error);
      return {
        isValid: true,  // 形式が正しければ有効として扱う
        invoiceNumber: normalizedNumber,
        invalidReason: undefined,
        verificationMethod: 'FORMAT',
        verifiedAt: new Date()
      };
    }
  }

  /**
   * インボイス番号の形式検証
   *
   * 形式: T + 13桁の数字
   * - 法人: T + 法人番号（13桁、チェックデジット付き）
   * - 個人: T + 13桁の数字（国税庁が付番）
   */
  private validateFormat(invoiceNumber: string): InvoiceValidationResult {
    const pattern = /^T\d{13}$/;

    if (!pattern.test(invoiceNumber)) {
      return {
        isValid: false,
        invoiceNumber,
        invalidReason: '形式不正（T + 13桁の数字が必要）',
        verificationMethod: 'FORMAT',
        verifiedAt: new Date()
      };
    }

    // チェックデジット検証（法人番号の場合）
    const numericPart = invoiceNumber.substring(1);
    if (!this.verifyCheckDigit(numericPart)) {
      return {
        isValid: false,
        invoiceNumber,
        invalidReason: 'チェックデジット不正',
        verificationMethod: 'FORMAT',
        verifiedAt: new Date()
      };
    }

    return {
      isValid: true,
      invoiceNumber,
      verificationMethod: 'FORMAT',
      verifiedAt: new Date()
    };
  }

  /**
   * 法人番号のチェックデジット検証
   *
   * チェックデジット計算式:
   * 9 - ((Σ(Pn × Qn)) mod 9)
   * Pn: n桁目の数字（右から）
   * Qn: n=偶数なら1、n=奇数なら2
   */
  private verifyCheckDigit(number: string): boolean {
    if (number.length !== 13) return false;

    const digits = number.split('').map(Number);
    const checkDigit = digits[0];
    const bodyDigits = digits.slice(1);

    let sum = 0;
    for (let i = 0; i < 12; i++) {
      const weight = (i % 2 === 0) ? 1 : 2;
      sum += bodyDigits[i] * weight;
    }

    const calculatedCheck = (9 - (sum % 9)) % 9;

    return checkDigit === calculatedCheck;
  }

  /**
   * インボイス番号の正規化
   */
  private normalizeInvoiceNumber(invoiceNumber: string): string {
    // 全角を半角に変換
    let normalized = invoiceNumber
      .replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) =>
        String.fromCharCode(s.charCodeAt(0) - 0xFEE0)
      )
      .replace(/[－]/g, '-')
      .replace(/[　]/g, ' ');

    // 空白・ハイフンを除去
    normalized = normalized.replace(/[\s\-]/g, '');

    // 大文字化
    normalized = normalized.toUpperCase();

    return normalized;
  }

  /**
   * キャッシュの有効性確認
   */
  private isCacheValid(
    cachedResult: InvoiceValidationResult,
    transactionDate: Date
  ): boolean {
    // キャッシュは24時間有効
    const cacheExpiry = new Date(cachedResult.verifiedAt);
    cacheExpiry.setHours(cacheExpiry.getHours() + 24);

    if (new Date() > cacheExpiry) {
      return false;
    }

    // 登録日チェック
    if (cachedResult.registrationDate && transactionDate < cachedResult.registrationDate) {
      return false;
    }

    return true;
  }
}
```

### 2.4 消費税計算サービス

```typescript
// ============================================================
// 消費税計算サービス
// ============================================================

interface ConsumptionTaxCalculation {
  period: TaxPeriod;
  salesTax: SalesTaxSummary;
  inputTax: InputTaxSummary;
  taxableRatio: Decimal;
  deductionMethod: 'FULL' | 'INDIVIDUAL' | 'PROPORTIONAL';
  taxPayable: Decimal;
  taxRefund: Decimal;
  calculationDetails: TaxCalculationDetail[];
}

interface SalesTaxSummary {
  taxableSales10: Decimal;      // 課税売上（10%）
  taxableSales08: Decimal;      // 課税売上（8%）
  exemptSales: Decimal;         // 免税売上
  nonTaxableSales: Decimal;     // 非課税売上
  salesTax10: Decimal;          // 売上税額（10%）
  salesTax08: Decimal;          // 売上税額（8%）
  totalSalesTax: Decimal;       // 売上税額合計
}

interface InputTaxSummary {
  taxablePurchases10: Decimal;  // 課税仕入（10%）
  taxablePurchases08: Decimal;  // 課税仕入（8%）
  inputTax10Full: Decimal;      // 仕入税額（10%・全額控除）
  inputTax10Partial80: Decimal; // 仕入税額（10%・80%控除）
  inputTax10Partial50: Decimal; // 仕入税額（10%・50%控除）
  inputTax08Full: Decimal;      // 仕入税額（8%・全額控除）
  inputTax08Partial80: Decimal; // 仕入税額（8%・80%控除）
  inputTax08Partial50: Decimal; // 仕入税額（8%・50%控除）
  totalInputTax: Decimal;       // 仕入税額控除合計
  nonDeductible: Decimal;       // 控除対象外
}

class ConsumptionTaxCalculator {
  private taxCategoryEngine: TaxCategoryEngine;
  private salesRepository: SalesRepository;
  private purchaseRepository: PurchaseRepository;

  /**
   * 消費税計算メイン
   */
  async calculateConsumptionTax(period: TaxPeriod): Promise<ConsumptionTaxCalculation> {
    // 1. 売上税額計算
    const salesTax = await this.calculateSalesTax(period);

    // 2. 課税売上割合計算
    const taxableRatio = this.calculateTaxableRatio(salesTax);

    // 3. 控除方式判定
    const deductionMethod = this.determineDeductionMethod(taxableRatio);

    // 4. 仕入税額控除計算
    const inputTax = await this.calculateInputTax(period, taxableRatio, deductionMethod);

    // 5. 納付税額計算
    const { taxPayable, taxRefund } = this.calculateTaxPayable(salesTax, inputTax);

    return {
      period,
      salesTax,
      inputTax,
      taxableRatio,
      deductionMethod,
      taxPayable,
      taxRefund,
      calculationDetails: []
    };
  }

  /**
   * 売上税額計算
   */
  private async calculateSalesTax(period: TaxPeriod): Promise<SalesTaxSummary> {
    const sales = await this.salesRepository.findByPeriod(period);

    let taxableSales10 = new Decimal(0);
    let taxableSales08 = new Decimal(0);
    let exemptSales = new Decimal(0);
    let nonTaxableSales = new Decimal(0);

    for (const sale of sales) {
      switch (sale.taxCategory) {
        case 'S10':
          taxableSales10 = taxableSales10.plus(sale.amountExclTax);
          break;
        case 'S08':
          taxableSales08 = taxableSales08.plus(sale.amountExclTax);
          break;
        case 'S00':
          exemptSales = exemptSales.plus(sale.amountExclTax);
          break;
        case 'SN':
          nonTaxableSales = nonTaxableSales.plus(sale.amountExclTax);
          break;
      }
    }

    // 売上税額計算（割戻計算）
    const salesTax10 = taxableSales10.times(0.10).floor();
    const salesTax08 = taxableSales08.times(0.08).floor();

    return {
      taxableSales10,
      taxableSales08,
      exemptSales,
      nonTaxableSales,
      salesTax10,
      salesTax08,
      totalSalesTax: salesTax10.plus(salesTax08)
    };
  }

  /**
   * 課税売上割合計算
   */
  private calculateTaxableRatio(salesTax: SalesTaxSummary): Decimal {
    const numerator = salesTax.taxableSales10
      .plus(salesTax.taxableSales08)
      .plus(salesTax.exemptSales);

    const denominator = numerator.plus(salesTax.nonTaxableSales);

    if (denominator.isZero()) {
      return new Decimal(1);  // 売上がない場合は100%
    }

    return numerator.div(denominator);
  }

  /**
   * 控除方式判定
   */
  private determineDeductionMethod(
    taxableRatio: Decimal
  ): 'FULL' | 'INDIVIDUAL' | 'PROPORTIONAL' {
    if (taxableRatio.isGreaterThanOrEqualTo(0.95)) {
      return 'FULL';  // 全額控除
    }
    // 実際には会社の選択による（ここではデフォルトで個別対応方式）
    return 'INDIVIDUAL';
  }

  /**
   * 仕入税額控除計算
   */
  private async calculateInputTax(
    period: TaxPeriod,
    taxableRatio: Decimal,
    method: 'FULL' | 'INDIVIDUAL' | 'PROPORTIONAL'
  ): Promise<InputTaxSummary> {
    const purchases = await this.purchaseRepository.findByPeriod(period);

    const summary: InputTaxSummary = {
      taxablePurchases10: new Decimal(0),
      taxablePurchases08: new Decimal(0),
      inputTax10Full: new Decimal(0),
      inputTax10Partial80: new Decimal(0),
      inputTax10Partial50: new Decimal(0),
      inputTax08Full: new Decimal(0),
      inputTax08Partial80: new Decimal(0),
      inputTax08Partial50: new Decimal(0),
      totalInputTax: new Decimal(0),
      nonDeductible: new Decimal(0)
    };

    for (const purchase of purchases) {
      if (!purchase.taxCategory.startsWith('P')) continue;
      if (purchase.taxCategory === 'PN' || purchase.taxCategory === 'PO') continue;

      const taxAmount = purchase.taxAmount;

      // 控除率の適用
      let deductionRate = new Decimal(1);
      if (purchase.taxCategory.includes('N80')) {
        deductionRate = new Decimal(0.80);
      } else if (purchase.taxCategory.includes('N50')) {
        deductionRate = new Decimal(0.50);
      } else if (purchase.taxCategory.includes('N00')) {
        deductionRate = new Decimal(0);
      }

      // 控除方式に応じた計算
      let deductibleAmount: Decimal;

      if (method === 'FULL') {
        // 全額控除
        deductibleAmount = taxAmount.times(deductionRate);
      } else if (method === 'INDIVIDUAL') {
        // 個別対応方式
        if (purchase.purchasePurpose === 'TAXABLE_ONLY') {
          deductibleAmount = taxAmount.times(deductionRate);
        } else if (purchase.purchasePurpose === 'NON_TAXABLE_ONLY') {
          deductibleAmount = new Decimal(0);
        } else {
          // 共通対応: 課税売上割合で按分
          deductibleAmount = taxAmount.times(deductionRate).times(taxableRatio);
        }
      } else {
        // 一括比例配分方式
        deductibleAmount = taxAmount.times(deductionRate).times(taxableRatio);
      }

      // 集計
      const is10Percent = purchase.taxCategory.startsWith('P10');
      if (is10Percent) {
        summary.taxablePurchases10 = summary.taxablePurchases10.plus(purchase.amountExclTax);
        if (deductionRate.equals(1)) {
          summary.inputTax10Full = summary.inputTax10Full.plus(deductibleAmount);
        } else if (deductionRate.equals(0.80)) {
          summary.inputTax10Partial80 = summary.inputTax10Partial80.plus(deductibleAmount);
        } else if (deductionRate.equals(0.50)) {
          summary.inputTax10Partial50 = summary.inputTax10Partial50.plus(deductibleAmount);
        }
      } else {
        summary.taxablePurchases08 = summary.taxablePurchases08.plus(purchase.amountExclTax);
        if (deductionRate.equals(1)) {
          summary.inputTax08Full = summary.inputTax08Full.plus(deductibleAmount);
        } else if (deductionRate.equals(0.80)) {
          summary.inputTax08Partial80 = summary.inputTax08Partial80.plus(deductibleAmount);
        } else if (deductionRate.equals(0.50)) {
          summary.inputTax08Partial50 = summary.inputTax08Partial50.plus(deductibleAmount);
        }
      }

      summary.totalInputTax = summary.totalInputTax.plus(deductibleAmount.floor());
      summary.nonDeductible = summary.nonDeductible.plus(
        taxAmount.minus(deductibleAmount).floor()
      );
    }

    return summary;
  }

  /**
   * 納付税額計算
   */
  private calculateTaxPayable(
    salesTax: SalesTaxSummary,
    inputTax: InputTaxSummary
  ): { taxPayable: Decimal; taxRefund: Decimal } {
    const netTax = salesTax.totalSalesTax.minus(inputTax.totalInputTax);

    // 100円未満切り捨て
    const rounded = netTax.div(100).floor().times(100);

    if (rounded.isPositive()) {
      return { taxPayable: rounded, taxRefund: new Decimal(0) };
    } else {
      return { taxPayable: new Decimal(0), taxRefund: rounded.abs() };
    }
  }
}
```

---

## 3. 源泉所得税計算

### 3.1 源泉徴収対象と税率

| 対象 | 税率 | 復興特別所得税 | 合計税率 | 備考 |
|------|------|----------------|----------|------|
| 報酬（100万円以下） | 10% | 0.21% | 10.21% | IT/コンサル報酬等 |
| 報酬（100万円超） | 20% | 0.42% | 20.42% | 超過分 |
| 配当（上場） | 15% | 0.315% | 15.315% | |
| 配当（非上場） | 20% | 0.42% | 20.42% | |
| 利子 | 15% | 0.315% | 15.315% | |
| 不動産賃料（法人） | - | - | - | 源泉なし |
| 不動産賃料（個人） | 10% | 0.21% | 10.21% | 個人大家への支払 |

### 3.2 源泉徴収税額計算

```typescript
// ============================================================
// 源泉所得税計算サービス
// ============================================================

type WithholdingTaxType =
  | 'COMPENSATION'      // 報酬・料金
  | 'DIVIDEND_LISTED'   // 配当（上場）
  | 'DIVIDEND_UNLISTED' // 配当（非上場）
  | 'INTEREST'          // 利子
  | 'PROPERTY_RENT'     // 不動産賃料（個人）
  | 'SALARY';           // 給与

interface WithholdingTaxCalculation {
  grossAmount: Decimal;           // 総支払額
  taxableAmount: Decimal;         // 課税対象額
  withholdingTax: Decimal;        // 源泉徴収税額
  reconstructionTax: Decimal;     // 復興特別所得税
  totalWithholding: Decimal;      // 源泉徴収合計
  netPayment: Decimal;            // 差引支払額
  calculationDetails: string;
}

class WithholdingTaxCalculator {
  private readonly RECONSTRUCTION_TAX_RATE = new Decimal(0.021);  // 2.1%

  /**
   * 源泉徴収税額計算メイン
   */
  calculateWithholdingTax(
    taxType: WithholdingTaxType,
    grossAmount: Decimal,
    options?: WithholdingOptions
  ): WithholdingTaxCalculation {
    switch (taxType) {
      case 'COMPENSATION':
        return this.calculateCompensationTax(grossAmount, options);
      case 'DIVIDEND_LISTED':
        return this.calculateDividendTax(grossAmount, true);
      case 'DIVIDEND_UNLISTED':
        return this.calculateDividendTax(grossAmount, false);
      case 'INTEREST':
        return this.calculateInterestTax(grossAmount);
      case 'PROPERTY_RENT':
        return this.calculatePropertyRentTax(grossAmount);
      default:
        throw new Error(`Unknown withholding tax type: ${taxType}`);
    }
  }

  /**
   * 報酬・料金の源泉徴収税額計算
   *
   * 100万円以下: 10%（復興税込み10.21%）
   * 100万円超:   超過分に20%（復興税込み20.42%）
   */
  private calculateCompensationTax(
    grossAmount: Decimal,
    options?: WithholdingOptions
  ): WithholdingTaxCalculation {
    const threshold = new Decimal(1000000);

    let baseTax: Decimal;
    let details: string;

    if (grossAmount.isLessThanOrEqualTo(threshold)) {
      // 100万円以下
      baseTax = grossAmount.times(0.10).floor();
      details = `${grossAmount} × 10% = ${baseTax}`;
    } else {
      // 100万円超
      const basePart = threshold.times(0.10);
      const excessPart = grossAmount.minus(threshold).times(0.20);
      baseTax = basePart.plus(excessPart).floor();
      details = `1,000,000 × 10% + (${grossAmount.minus(threshold)} × 20%) = ${baseTax}`;
    }

    // 復興特別所得税
    const reconstructionTax = baseTax.times(this.RECONSTRUCTION_TAX_RATE).floor();
    const totalWithholding = baseTax.plus(reconstructionTax);

    return {
      grossAmount,
      taxableAmount: grossAmount,
      withholdingTax: baseTax,
      reconstructionTax,
      totalWithholding,
      netPayment: grossAmount.minus(totalWithholding),
      calculationDetails: `${details} + 復興税 ${reconstructionTax}`
    };
  }

  /**
   * 配当の源泉徴収税額計算
   *
   * 上場株式: 15%（復興税込み15.315%）
   * 非上場:   20%（復興税込み20.42%）
   */
  private calculateDividendTax(
    grossAmount: Decimal,
    isListed: boolean
  ): WithholdingTaxCalculation {
    const baseRate = isListed ? new Decimal(0.15) : new Decimal(0.20);
    const baseTax = grossAmount.times(baseRate).floor();
    const reconstructionTax = baseTax.times(this.RECONSTRUCTION_TAX_RATE).floor();
    const totalWithholding = baseTax.plus(reconstructionTax);

    return {
      grossAmount,
      taxableAmount: grossAmount,
      withholdingTax: baseTax,
      reconstructionTax,
      totalWithholding,
      netPayment: grossAmount.minus(totalWithholding),
      calculationDetails: `${grossAmount} × ${baseRate.times(100)}% = ${baseTax}`
    };
  }

  /**
   * 利子の源泉徴収税額計算
   *
   * 税率: 15%（復興税込み15.315%）
   */
  private calculateInterestTax(grossAmount: Decimal): WithholdingTaxCalculation {
    const baseTax = grossAmount.times(0.15).floor();
    const reconstructionTax = baseTax.times(this.RECONSTRUCTION_TAX_RATE).floor();
    const totalWithholding = baseTax.plus(reconstructionTax);

    return {
      grossAmount,
      taxableAmount: grossAmount,
      withholdingTax: baseTax,
      reconstructionTax,
      totalWithholding,
      netPayment: grossAmount.minus(totalWithholding),
      calculationDetails: `${grossAmount} × 15% = ${baseTax}`
    };
  }

  /**
   * 不動産賃料（個人大家）の源泉徴収税額計算
   *
   * 税率: 10%（復興税込み10.21%）
   * ※法人への支払は源泉徴収不要
   */
  private calculatePropertyRentTax(grossAmount: Decimal): WithholdingTaxCalculation {
    const baseTax = grossAmount.times(0.10).floor();
    const reconstructionTax = baseTax.times(this.RECONSTRUCTION_TAX_RATE).floor();
    const totalWithholding = baseTax.plus(reconstructionTax);

    return {
      grossAmount,
      taxableAmount: grossAmount,
      withholdingTax: baseTax,
      reconstructionTax,
      totalWithholding,
      netPayment: grossAmount.minus(totalWithholding),
      calculationDetails: `${grossAmount} × 10% = ${baseTax}`
    };
  }

  /**
   * 源泉徴収税額の逆算（手取り金額から）
   */
  calculateGrossFromNet(
    taxType: WithholdingTaxType,
    netAmount: Decimal
  ): WithholdingTaxCalculation {
    // 反復法で総額を求める
    let grossEstimate = netAmount;
    let iteration = 0;
    const maxIterations = 10;

    while (iteration < maxIterations) {
      const result = this.calculateWithholdingTax(taxType, grossEstimate);
      const diff = netAmount.minus(result.netPayment);

      if (diff.abs().isLessThan(1)) {
        return result;
      }

      grossEstimate = grossEstimate.plus(diff);
      iteration++;
    }

    // 収束しない場合は最後の計算結果を返す
    return this.calculateWithholdingTax(taxType, grossEstimate);
  }
}
```

---

## 4. 法人税申告支援

### 4.1 申告調整項目抽出

```typescript
// ============================================================
// 法人税申告調整サービス
// ============================================================

interface TaxAdjustmentItem {
  adjustmentType: 'ADDITION' | 'DEDUCTION';  // 加算/減算
  category: AdjustmentCategory;
  description: string;
  accountingAmount: Decimal;
  taxAmount: Decimal;
  adjustmentAmount: Decimal;
  scheduleNo: string;  // 対応別表番号
  scheduleRow: string; // 別表の行番号
}

type AdjustmentCategory =
  | 'DEPRECIATION'          // 減価償却超過
  | 'ALLOWANCE'             // 引当金繰入超過
  | 'ENTERTAINMENT'         // 交際費
  | 'DONATION'              // 寄附金
  | 'OFFICERS_COMPENSATION' // 役員給与
  | 'DEFERRED_TAX'          // 税効果会計
  | 'IMPAIRMENT'            // 減損損失
  | 'VALUATION'             // 有価証券評価
  | 'FX_GAIN_LOSS'          // 為替差損益
  | 'OTHER';                // その他

class TaxAdjustmentExtractor {
  private depreciationDiffService: DepreciationDifferenceService;
  private allowanceService: AllowanceService;

  /**
   * 申告調整項目抽出メイン
   */
  async extractAdjustments(fiscalYear: string): Promise<TaxAdjustmentItem[]> {
    const adjustments: TaxAdjustmentItem[] = [];

    // 1. 減価償却の過不足
    const depreciationAdj = await this.extractDepreciationAdjustments(fiscalYear);
    adjustments.push(...depreciationAdj);

    // 2. 引当金
    const allowanceAdj = await this.extractAllowanceAdjustments(fiscalYear);
    adjustments.push(...allowanceAdj);

    // 3. 交際費
    const entertainmentAdj = await this.extractEntertainmentAdjustments(fiscalYear);
    adjustments.push(...entertainmentAdj);

    // 4. 寄附金
    const donationAdj = await this.extractDonationAdjustments(fiscalYear);
    adjustments.push(...donationAdj);

    // 5. 役員給与
    const officersAdj = await this.extractOfficersCompensationAdjustments(fiscalYear);
    adjustments.push(...officersAdj);

    // 6. 減損損失（税務上損金不算入）
    const impairmentAdj = await this.extractImpairmentAdjustments(fiscalYear);
    adjustments.push(...impairmentAdj);

    // 7. 有価証券評価損益
    const valuationAdj = await this.extractValuationAdjustments(fiscalYear);
    adjustments.push(...valuationAdj);

    return adjustments;
  }

  /**
   * 減価償却の申告調整抽出
   */
  private async extractDepreciationAdjustments(
    fiscalYear: string
  ): Promise<TaxAdjustmentItem[]> {
    const adjustments: TaxAdjustmentItem[] = [];
    const depreciationDiffs = await this.depreciationDiffService.getDifferences(fiscalYear);

    for (const diff of depreciationDiffs) {
      if (diff.accountingAmount.isGreaterThan(diff.taxAmount)) {
        // 会計 > 税務 → 加算（償却超過額）
        adjustments.push({
          adjustmentType: 'ADDITION',
          category: 'DEPRECIATION',
          description: `減価償却超過額 ${diff.assetId}`,
          accountingAmount: diff.accountingAmount,
          taxAmount: diff.taxAmount,
          adjustmentAmount: diff.accountingAmount.minus(diff.taxAmount),
          scheduleNo: '16',
          scheduleRow: '24'
        });
      } else if (diff.accountingAmount.isLessThan(diff.taxAmount)) {
        // 会計 < 税務 → 減算（償却不足額の認容）
        adjustments.push({
          adjustmentType: 'DEDUCTION',
          category: 'DEPRECIATION',
          description: `減価償却不足額認容 ${diff.assetId}`,
          accountingAmount: diff.accountingAmount,
          taxAmount: diff.taxAmount,
          adjustmentAmount: diff.taxAmount.minus(diff.accountingAmount),
          scheduleNo: '16',
          scheduleRow: '25'
        });
      }
    }

    return adjustments;
  }

  /**
   * 交際費の申告調整抽出
   *
   * 中小企業: 800万円まで全額損金、または接待飲食費の50%
   * 大企業: 接待飲食費の50%のみ損金
   */
  private async extractEntertainmentAdjustments(
    fiscalYear: string
  ): Promise<TaxAdjustmentItem[]> {
    const adjustments: TaxAdjustmentItem[] = [];

    const entertainmentExpenses = await this.expenseRepository
      .findByCategory(fiscalYear, 'ENTERTAINMENT');

    let totalEntertainment = new Decimal(0);
    let diningExpenses = new Decimal(0);

    for (const expense of entertainmentExpenses) {
      totalEntertainment = totalEntertainment.plus(expense.amount);
      if (expense.subCategory === 'DINING') {
        diningExpenses = diningExpenses.plus(expense.amount);
      }
    }

    // 損金算入限度額計算（中小企業の場合）
    const smeLimit = new Decimal(8000000);
    const diningDeductible = diningExpenses.times(0.50);

    // より有利な方を選択
    const deductibleLimit = Decimal.max(smeLimit, diningDeductible);
    const nonDeductible = Decimal.max(
      totalEntertainment.minus(deductibleLimit),
      new Decimal(0)
    );

    if (nonDeductible.isGreaterThan(0)) {
      adjustments.push({
        adjustmentType: 'ADDITION',
        category: 'ENTERTAINMENT',
        description: '交際費等の損金不算入額',
        accountingAmount: totalEntertainment,
        taxAmount: deductibleLimit,
        adjustmentAmount: nonDeductible,
        scheduleNo: '15',
        scheduleRow: '10'
      });
    }

    return adjustments;
  }

  /**
   * 減損損失の申告調整抽出
   */
  private async extractImpairmentAdjustments(
    fiscalYear: string
  ): Promise<TaxAdjustmentItem[]> {
    const adjustments: TaxAdjustmentItem[] = [];

    const impairmentLosses = await this.assetRepository.findImpairmentLosses(fiscalYear);

    for (const loss of impairmentLosses) {
      // 減損損失は税務上全額損金不算入（売却・除却時まで繰延）
      adjustments.push({
        adjustmentType: 'ADDITION',
        category: 'IMPAIRMENT',
        description: `減損損失 ${loss.assetId} ${loss.assetName}`,
        accountingAmount: loss.impairmentLoss,
        taxAmount: new Decimal(0),
        adjustmentAmount: loss.impairmentLoss,
        scheduleNo: '4',
        scheduleRow: '28'
      });
    }

    return adjustments;
  }
}
```

### 4.2 別表データ生成

```typescript
// ============================================================
// 別表生成サービス
// ============================================================

interface TaxScheduleData {
  scheduleNo: string;
  scheduleName: string;
  rows: TaxScheduleRow[];
  subtotals: Map<string, Decimal>;
  total: Decimal;
}

interface TaxScheduleRow {
  rowNo: string;
  rowName: string;
  accountingAmount: Decimal;
  adjustmentAmount: Decimal;
  taxAmount: Decimal;
  remarks?: string;
}

class TaxScheduleGenerator {
  /**
   * 別表四（所得の金額の計算に関する明細書）生成
   */
  async generateSchedule4(
    fiscalYear: string,
    adjustments: TaxAdjustmentItem[]
  ): Promise<TaxScheduleData> {
    const rows: TaxScheduleRow[] = [];

    // 当期利益
    const accountingProfit = await this.getAccountingProfit(fiscalYear);
    rows.push({
      rowNo: '1',
      rowName: '当期利益又は当期欠損の額',
      accountingAmount: accountingProfit,
      adjustmentAmount: new Decimal(0),
      taxAmount: accountingProfit
    });

    // 加算項目
    const additions = adjustments.filter(a => a.adjustmentType === 'ADDITION');
    let additionTotal = new Decimal(0);

    for (const adj of additions) {
      rows.push({
        rowNo: adj.scheduleRow,
        rowName: adj.description,
        accountingAmount: adj.accountingAmount,
        adjustmentAmount: adj.adjustmentAmount,
        taxAmount: adj.taxAmount
      });
      additionTotal = additionTotal.plus(adj.adjustmentAmount);
    }

    rows.push({
      rowNo: '29',
      rowName: '加算小計',
      accountingAmount: new Decimal(0),
      adjustmentAmount: additionTotal,
      taxAmount: additionTotal
    });

    // 減算項目
    const deductions = adjustments.filter(a => a.adjustmentType === 'DEDUCTION');
    let deductionTotal = new Decimal(0);

    for (const adj of deductions) {
      rows.push({
        rowNo: adj.scheduleRow,
        rowName: adj.description,
        accountingAmount: adj.accountingAmount,
        adjustmentAmount: adj.adjustmentAmount,
        taxAmount: adj.taxAmount
      });
      deductionTotal = deductionTotal.plus(adj.adjustmentAmount);
    }

    rows.push({
      rowNo: '44',
      rowName: '減算小計',
      accountingAmount: new Decimal(0),
      adjustmentAmount: deductionTotal,
      taxAmount: deductionTotal
    });

    // 所得金額
    const taxableIncome = accountingProfit.plus(additionTotal).minus(deductionTotal);
    rows.push({
      rowNo: '52',
      rowName: '所得金額又は欠損金額',
      accountingAmount: accountingProfit,
      adjustmentAmount: additionTotal.minus(deductionTotal),
      taxAmount: taxableIncome
    });

    return {
      scheduleNo: '4',
      scheduleName: '所得の金額の計算に関する明細書',
      rows,
      subtotals: new Map([
        ['addition', additionTotal],
        ['deduction', deductionTotal]
      ]),
      total: taxableIncome
    };
  }

  /**
   * 別表十六（一）（定額法償却資産）生成
   */
  async generateSchedule16_1(fiscalYear: string): Promise<TaxScheduleData> {
    const assets = await this.assetRepository.findByDepreciationMethod(
      fiscalYear,
      ['SL']  // 定額法
    );

    const rows: TaxScheduleRow[] = [];
    let totalDepreciation = new Decimal(0);

    for (const asset of assets) {
      const row: TaxScheduleRow = {
        rowNo: asset.assetId,
        rowName: asset.assetName,
        accountingAmount: asset.accDepreciation,
        adjustmentAmount: asset.accDepreciation.minus(asset.taxDepreciation),
        taxAmount: asset.taxDepreciation,
        remarks: `耐用年数${asset.taxUsefulLife}年`
      };
      rows.push(row);
      totalDepreciation = totalDepreciation.plus(asset.taxDepreciation);
    }

    return {
      scheduleNo: '16-1',
      scheduleName: '旧定額法又は定額法による減価償却資産の償却額の計算に関する明細書',
      rows,
      subtotals: new Map(),
      total: totalDepreciation
    };
  }
}
```

---

## 5. 消費税申告書データ生成

### 5.1 申告書連携データ

```typescript
// ============================================================
// 消費税申告書データ生成
// ============================================================

interface ConsumptionTaxReturnData {
  // 申告基本情報
  filingPeriod: TaxPeriod;
  filingDeadline: Date;
  companyInfo: CompanyInfo;

  // 付表1（課税売上）
  schedule1: {
    taxableSales10: Decimal;      // 課税売上（10%）
    taxableSales08: Decimal;      // 課税売上（8%）
    exemptSales: Decimal;         // 免税売上
    nonTaxableSales: Decimal;     // 非課税売上
    totalSales: Decimal;          // 総売上
    salesTax10: Decimal;          // 売上税額（10%）
    salesTax08: Decimal;          // 売上税額（8%）
    totalSalesTax: Decimal;       // 売上税額合計
  };

  // 付表2（課税仕入）
  schedule2: {
    taxablePurchases10: Decimal;  // 課税仕入（10%）
    taxablePurchases08: Decimal;  // 課税仕入（8%）
    inputTax10: Decimal;          // 仕入税額（10%）
    inputTax08: Decimal;          // 仕入税額（8%）
    totalInputTax: Decimal;       // 仕入税額合計
    taxableRatio: Decimal;        // 課税売上割合
    deductionMethod: string;      // 控除方式
  };

  // 申告書本体
  mainForm: {
    salesTax: Decimal;            // 1欄: 課税売上に係る消費税額
    inputTaxDeduction: Decimal;   // 2欄: 仕入れに係る消費税額
    netTax: Decimal;              // 3欄: 差引税額
    interimPayment: Decimal;      // 4欄: 中間納付税額
    finalTax: Decimal;            // 5欄: 納付税額
    localTax: Decimal;            // 6欄: 地方消費税
    totalPayable: Decimal;        // 7欄: 納付すべき税額
  };

  // インボイス関連
  invoiceSummary: {
    invoiceCount: number;         // インボイス保存件数
    nonInvoiceCount: number;      // インボイスなし件数
    transitionalAmount80: Decimal;// 80%経過措置適用額
    transitionalAmount50: Decimal;// 50%経過措置適用額
    nonDeductibleAmount: Decimal; // 控除対象外額
  };
}

class ConsumptionTaxReturnGenerator {
  /**
   * 消費税申告書データ生成
   */
  async generateReturnData(
    period: TaxPeriod
  ): Promise<ConsumptionTaxReturnData> {
    // 計算結果取得
    const calculation = await this.taxCalculator.calculateConsumptionTax(period);

    // 中間納付額取得
    const interimPayment = await this.getInterimPayment(period);

    // インボイスサマリー
    const invoiceSummary = await this.getInvoiceSummary(period);

    // 申告書データ構築
    const returnData: ConsumptionTaxReturnData = {
      filingPeriod: period,
      filingDeadline: this.calculateFilingDeadline(period),
      companyInfo: await this.getCompanyInfo(),

      schedule1: {
        taxableSales10: calculation.salesTax.taxableSales10,
        taxableSales08: calculation.salesTax.taxableSales08,
        exemptSales: calculation.salesTax.exemptSales,
        nonTaxableSales: calculation.salesTax.nonTaxableSales,
        totalSales: calculation.salesTax.taxableSales10
          .plus(calculation.salesTax.taxableSales08)
          .plus(calculation.salesTax.exemptSales)
          .plus(calculation.salesTax.nonTaxableSales),
        salesTax10: calculation.salesTax.salesTax10,
        salesTax08: calculation.salesTax.salesTax08,
        totalSalesTax: calculation.salesTax.totalSalesTax
      },

      schedule2: {
        taxablePurchases10: calculation.inputTax.taxablePurchases10,
        taxablePurchases08: calculation.inputTax.taxablePurchases08,
        inputTax10: calculation.inputTax.inputTax10Full
          .plus(calculation.inputTax.inputTax10Partial80)
          .plus(calculation.inputTax.inputTax10Partial50),
        inputTax08: calculation.inputTax.inputTax08Full
          .plus(calculation.inputTax.inputTax08Partial80)
          .plus(calculation.inputTax.inputTax08Partial50),
        totalInputTax: calculation.inputTax.totalInputTax,
        taxableRatio: calculation.taxableRatio,
        deductionMethod: calculation.deductionMethod
      },

      mainForm: {
        salesTax: calculation.salesTax.totalSalesTax,
        inputTaxDeduction: calculation.inputTax.totalInputTax,
        netTax: calculation.taxPayable,
        interimPayment,
        finalTax: Decimal.max(
          calculation.taxPayable.minus(interimPayment),
          new Decimal(0)
        ),
        localTax: this.calculateLocalConsumptionTax(calculation.taxPayable),
        totalPayable: this.calculateTotalPayable(calculation.taxPayable, interimPayment)
      },

      invoiceSummary
    };

    return returnData;
  }

  /**
   * 地方消費税計算
   * 国税の78分の22
   */
  private calculateLocalConsumptionTax(nationalTax: Decimal): Decimal {
    return nationalTax.times(22).div(78).floor();
  }

  /**
   * 申告期限計算
   */
  private calculateFilingDeadline(period: TaxPeriod): Date {
    // 課税期間終了の翌日から2ヶ月以内
    const deadline = new Date(period.endDate);
    deadline.setMonth(deadline.getMonth() + 2);
    return deadline;
  }
}
```

---

## 6. 帳票出力

### 6.1 出力帳票一覧

| 帳票名 | 出力内容 | 形式 | 用途 |
|--------|----------|------|------|
| 課税売上高一覧 | 税率別売上明細 | PDF/Excel | 申告書作成 |
| 課税仕入高一覧 | インボイス有無別仕入明細 | PDF/Excel | 申告書作成 |
| 仕入税額控除明細 | 控除額の計算明細 | PDF/Excel | 申告書添付 |
| インボイス保存確認表 | 仕入先別インボイス保存状況 | PDF/Excel | 証跡管理 |
| 経過措置適用明細 | 経過措置適用の仕入明細 | PDF/Excel | 証跡管理 |
| 消費税申告書ドラフト | 申告書様式準拠 | PDF | 申告準備 |
| 法人税別表四ドラフト | 所得金額計算明細 | PDF/Excel | 申告準備 |
| 法人税別表十六 | 減価償却明細 | PDF/Excel | 申告添付 |
| 源泉徴収票 | 支払先別源泉明細 | PDF | 法定調書 |
| 源泉徴収簿 | 月次源泉集計 | PDF/Excel | 納付管理 |

---

## 7. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2025/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] 税区分判定が消費税法に準拠しているか
- [ ] 軽減税率の判定が正確か
- [ ] インボイス制度の要件が満たされているか
- [ ] 経過措置の控除率（80%/50%/0%）が正しいか
- [ ] 課税売上割合の計算が正確か
- [ ] 仕入税額控除の計算（全額/個別/一括）が正確か
- [ ] 源泉所得税の税率が最新か
- [ ] 法人税申告調整項目が網羅されているか
- [ ] 申告書様式との対応が正しいか
- [ ] インボイス番号の検証ロジックが正しいか
- [ ] 不動産業・有価証券業特有の非課税取引が考慮されているか
- [ ] J-SOX統制要件を満たしているか
- [ ] 税理士のレビューを受けているか
