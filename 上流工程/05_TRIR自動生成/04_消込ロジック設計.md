# 消込ロジック設計

*このドキュメントはTRIR仕様から自動生成されました*

# 機能定義

## execute_clearing

**説明**: 入金を請求書に消込

**入力パラメータ**:

- `receipt_id` (string): 
- `invoice_id` (string): 
- `amount` (int): 
- `match_score` (int): 
- `match_reasons` (list(string)): 
- `clear_type` (string): 

**事前条件**:

- 消込対象はOPENまたはPARTIALステータスの請求書のみ
- 消込対象は未処理または部分消込済みの入金のみ

**エラーケース**:

- `INVOICE_NOT_OPEN`: 請求書がOPEN/PARTIAL以外の状態
- `OVER_CLEARING`: 消込額が請求残高を超過
- `INSUFFICIENT_RECEIPT`: 消込額が入金未消込残高を超過

**実行結果**:

- ar_clearingレコードを作成
- ar_invoiceのopen_amountを更新
- ar_invoiceのstatusを更新 (条件: ... = '0')
- ar_invoiceのstatusを更新 (条件: ... gt '0' かつ status = 'OPEN')
- ar_receiptのunallocated_amountを更新
- ar_receiptのstatusを更新 (条件: ... = '0')

## reverse_clearing

**説明**: 消込の取消

**入力パラメータ**:

- `clearing_id` (string): 
- `reason` (string): 

**事前条件**:

- ACTIVEの消込のみ取消可能

**エラーケース**:

- `ALREADY_REVERSED`: 既に取消済み

**実行結果**:

- ar_clearingのstatus, reversed_at, reversal_reasonを更新
- ar_invoiceのopen_amount, statusを更新
- ar_receiptのunallocated_amount, statusを更新


---

# フローチャート

## execute_clearing

```mermaid
flowchart TD
    Start([execute_clearing])
    Pre1{"Check: 消込対象はOPENまたはPARTIALステータスの請求書のみ"}
    Start --> Pre1
    Pre2{"Check: 消込対象は未処理または部分消込済みの入金のみ"}
    Pre1 --> Pre2
    Err3{"Check: 請求書がOPEN/PARTIAL以外の状態"}
    Pre2 --> Err3
    Err3 -->|No| ErrEnd3[/"INVOICE_NOT_OPEN"/]
    Err3 -->|Yes| Next3
    Err4{"Check: 消込額が請求残高を超過"}
    Next3 --> Err4
    Err4 -->|No| ErrEnd4[/"OVER_CLEARING"/]
    Err4 -->|Yes| Next4
    Err5{"Check: 消込額が入金未消込残高を超過"}
    Next4 --> Err5
    Err5 -->|No| ErrEnd5[/"INSUFFICIENT_RECEIPT"/]
    Err5 -->|Yes| Next5
    Act6["Create ar_clearing"]
    Next5 --> Act6
    Act7["Update ar_invoice.open_amount"]
    Act6 --> Act7
    Cond8{"If: ... == 0"}
    Act7 --> Cond8
    Cond8 -->|Yes| Act8["Update ar_invoice.status"]
    Cond8 -->|No| Skip8[Skip]
    Act8 --> Merge8
    Skip8 --> Merge8
    Cond9{"If: ... > 0 and status == OPEN"}
    Merge8 --> Cond9
    Cond9 -->|Yes| Act9["Update ar_invoice.status"]
    Cond9 -->|No| Skip9[Skip]
    Act9 --> Merge9
    Skip9 --> Merge9
    Act10["Update ar_receipt.unallocated_amount"]
    Merge9 --> Act10
    Cond11{"If: ... == 0"}
    Act10 --> Cond11
    Cond11 -->|Yes| Act11["Update ar_receipt.status"]
    Cond11 -->|No| Skip11[Skip]
    Act11 --> Merge11
    Skip11 --> Merge11
    Success([Success])
    Merge11 --> Success
```

## reverse_clearing

```mermaid
flowchart TD
    Start([reverse_clearing])
    Pre1{"Check: ACTIVEの消込のみ取消可能"}
    Start --> Pre1
    Err2{"Check: 既に取消済み"}
    Pre1 --> Err2
    Err2 -->|No| ErrEnd2[/"ALREADY_REVERSED"/]
    Err2 -->|Yes| Next2
    Act3["Update ar_clearing.status, reversed_at"]
    Next2 --> Act3
    Act4["Update ar_invoice.open_amount, status"]
    Act3 --> Act4
    Act5["Update ar_receipt.unallocated_amount, status"]
    Act4 --> Act5
    Success([Success])
    Act5 --> Success
```

