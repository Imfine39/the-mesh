# 方式設計（認証・監査・電帳法）

| 項目 | 内容 |
|------|------|
| 文書番号 | DES-MTH-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2026/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. 認証・認可方式

### 1.1 認証方式

| 項目 | 方式 | 備考 |
|------|------|------|
| 認証方式 | SAML 2.0 / OAuth 2.0 + OIDC | Azure AD / Okta連携 |
| SSO | 対応（社内IdP） | Microsoft Entra ID連携 |
| 多要素認証 | 必須（経理権限以上） | Microsoft Authenticator / TOTP |
| セッション | JWT（RS256署名） | アクセストークン：1時間、リフレッシュ：8時間 |
| パスワード | IdP側で管理 | 社内セキュリティポリシー準拠 |
| APIキー | サービスアカウント用 | 外部システム連携用（IP制限併用） |

**認証フロー**

```
┌─────────────────────────────────────────────────────────────────┐
│                      認証フロー（OIDC）                          │
└─────────────────────────────────────────────────────────────────┘

  User        Frontend        API Gateway       IdP            Backend
   │              │               │              │                │
   │─(1)Access──→│               │              │                │
   │              │─(2)Redirect──────────────→│                │
   │              │               │              │                │
   │←──────────(3)Login Page───────────────────│                │
   │              │               │              │                │
   │─(4)Credentials───────────────────────────→│                │
   │              │               │              │                │
   │←─(5)Auth Code + Redirect──────────────────│                │
   │              │               │              │                │
   │              │─(6)Exchange Code──────────→│                │
   │              │               │              │                │
   │              │←(7)ID Token + Access Token─│                │
   │              │               │              │                │
   │              │─(8)API Call w/ Token─────→│                │
   │              │               │─(9)Validate─→│              │
   │              │               │              │─(10)User Info─→│
   │              │               │              │                │
   │              │←────────────(11)Response────────────────────│
```

**MFA要件**

| 対象ロール | MFA要件 | 許可される認証方式 |
|------------|---------|-------------------|
| ACC_ADMIN | 必須 | ハードウェアトークン、Authenticator |
| ACC_MGR | 必須 | Authenticator、SMS |
| ACC_USER | 必須 | Authenticator、SMS |
| ACC_VIEW | 推奨 | Authenticator、SMS |
| AUDIT | 必須 | Authenticator |
| システム連携 | APIキー+IP制限 | - |

### 1.2 認可（アクセス制御）

#### ロール定義

| ロールID | ロール名 | 説明 | 付与対象 |
|----------|----------|------|----------|
| ACC_ADMIN | 経理管理者 | 全機能アクセス、マスタ管理、ユーザー管理 | 経理部長、CFO |
| ACC_MGR | 経理マネージャー | 承認権限、決算処理、全社照会 | 経理課長 |
| ACC_USER | 経理担当（本社） | 入力・照会（全社）、帳票出力 | 本社経理スタッフ |
| ACC_SUB | 経理担当（子会社） | 入力・照会（自社のみ）、帳票出力 | 子会社経理担当 |
| ACC_VIEW | 照会専用 | 照会のみ（入力不可） | 事業部門、管理職 |
| AR_USER | 売掛金担当 | AR機能（請求・入金） | 営業事務 |
| AP_USER | 買掛金担当 | AP機能（請求登録・支払） | 購買担当 |
| FA_USER | 固定資産担当 | FA機能（資産管理） | 総務担当 |
| PROP_USER | 不動産担当 | Property機能（物件・契約） | 不動産事業部 |
| SEC_USER | 有価証券担当 | Securities機能（投資管理） | 投資運用部 |
| TAX_MGR | 税務マネージャー | 税務機能全般、申告処理 | 税務課長 |
| AUDIT | 監査ロール | 全データ照会・ログ閲覧 | 内部監査/外部監査 |

#### 権限マトリクス（GL機能）

| 機能 | ACC_ADMIN | ACC_MGR | ACC_USER | ACC_SUB | ACC_VIEW | AUDIT |
|------|-----------|---------|----------|---------|----------|-------|
| 仕訳入力 | ○ | ○ | ○ | ○(自社) | × | × |
| 仕訳承認（1次） | ○ | ○ | × | × | × | × |
| 仕訳承認（最終） | ○ | ○ | × | × | × | × |
| 仕訳取消（赤黒） | ○ | ○ | × | × | × | × |
| 仕訳削除 | ○ | × | × | × | × | × |
| 仕訳照会 | ○ | ○ | ○ | ○(自社) | ○ | ○ |
| 試算表照会 | ○ | ○ | ○ | ○(自社) | ○ | ○ |
| 決算締め実行 | ○ | ○ | × | × | × | × |
| 決算締め解除 | ○ | × | × | × | × | × |
| 帳票出力 | ○ | ○ | ○ | ○(自社) | ○ | ○ |
| マスタ照会 | ○ | ○ | ○ | ○ | ○ | ○ |
| マスタ変更 | ○ | △(承認要) | × | × | × | × |
| 監査ログ照会 | ○ | ○ | × | × | × | ○ |
| ユーザー管理 | ○ | × | × | × | × | × |
| システム設定 | ○ | × | × | × | × | × |

#### 権限マトリクス（業種特化機能）

| 機能 | ACC_ADMIN | ACC_MGR | PROP_USER | SEC_USER | AUDIT |
|------|-----------|---------|-----------|----------|-------|
| 物件マスタ登録 | ○ | ○ | ○ | × | × |
| 賃貸契約管理 | ○ | ○ | ○ | × | × |
| 賃料計上処理 | ○ | ○ | ○ | × | × |
| 敷金管理 | ○ | ○ | ○ | × | × |
| 銘柄マスタ登録 | ○ | ○ | × | ○ | × |
| 売買取引登録 | ○ | ○ | × | ○ | × |
| 時価評価処理 | ○ | ○ | × | ○ | × |
| 配当管理 | ○ | ○ | × | ○ | × |
| 保有明細照会 | ○ | ○ | × | ○ | ○ |

#### 会社コードによるデータフィルタリング

```
[アクセス制御ロジック]

// ロールベースフィルタリング
IF ユーザー.ロール = 'ACC_SUB' THEN
    データフィルタ: 会社コード = ユーザー.所属会社コード

ELSE IF ユーザー.ロール IN ('ACC_USER', 'ACC_MGR', 'ACC_ADMIN', 'AUDIT') THEN
    データフィルタ: なし（全社アクセス可）

// 追加の属性ベースフィルタリング
ELSE IF ユーザー.所属部門 = 'RE_DIVISION' AND ユーザー.ロール = 'PROP_USER' THEN
    データフィルタ:
      - Property: 担当ポートフォリオのみ
      - GL: 不動産関連セグメントのみ

ELSE IF ユーザー.所属部門 = 'INV_DIVISION' AND ユーザー.ロール = 'SEC_USER' THEN
    データフィルタ:
      - Securities: 担当ファンドのみ
      - GL: 有価証券関連セグメントのみ
END IF
```

**属性ベースアクセス制御（ABAC）拡張**

| 属性 | 説明 | フィルタ条件 |
|------|------|--------------|
| company_code | 会社コード | 所属会社のみ（ACC_SUB） |
| profit_center | 利益センター | 担当PCのみ |
| portfolio_code | ポートフォリオ | 担当PFのみ（不動産・有価証券） |
| project_code | プロジェクト | 担当PRJのみ |
| amount_limit | 金額上限 | 承認権限の金額制限 |

### 1.3 承認権限と金額制限

| ロール | 承認可能金額（税込） | 承認レベル |
|--------|---------------------|------------|
| ACC_USER | - | 起票のみ（承認不可） |
| ACC_MGR | 1,000万円未満 | 1次承認 |
| ACC_ADMIN | 1億円未満 | 最終承認 |
| CFO | 制限なし | 最終承認（超高額） |

**承認フロー例**

```
[仕訳金額による承認フロー]

金額 < 100万円:
  起票者 → ACC_MGR（1次承認） → 完了

100万円 ≤ 金額 < 1,000万円:
  起票者 → ACC_MGR（1次承認） → ACC_ADMIN（最終承認） → 完了

1,000万円 ≤ 金額 < 1億円:
  起票者 → ACC_MGR（1次承認） → ACC_ADMIN（2次承認） → 完了

金額 ≥ 1億円:
  起票者 → ACC_MGR（1次承認） → ACC_ADMIN（2次承認） → CFO（最終承認） → 完了
```

### 1.4 職務分掌（SoD）制御

| SoDルールID | 競合権限1 | 競合権限2 | 理由 | 検知方法 |
|-------------|-----------|-----------|------|----------|
| SOD-001 | 仕訳入力 | 自己承認 | 自己承認防止 | システム制御（強制） |
| SOD-002 | 仕訳入力 | 支払実行 | 不正支払防止 | 権限付与時チェック |
| SOD-003 | マスタ変更 | 仕訳入力 | 架空取引防止 | 権限付与時チェック |
| SOD-004 | ユーザー管理 | 業務処理 | 権限濫用防止 | 権限付与時チェック |
| SOD-005 | 得意先マスタ変更 | 入金消込 | 横領防止 | 権限付与時チェック |
| SOD-006 | 仕入先マスタ変更 | 支払処理 | 不正支払防止 | 権限付与時チェック |
| SOD-007 | 銀行マスタ変更 | 支払実行 | 振込先詐欺防止 | 権限付与時チェック |
| SOD-008 | 物件マスタ変更 | 賃料計上 | 架空収入防止 | 権限付与時チェック |

**SoD違反検知・対応**

| 検知タイミング | 対応 | アラート先 |
|----------------|------|-----------|
| 権限付与時 | 付与拒否 + 警告 | 申請者、管理者 |
| ログイン時 | 警告表示 + ログ記録 | セキュリティ担当 |
| 定期監査 | レポート出力 | 内部監査部門 |

---

## 2. 監査ログ方式

### 2.1 ログ取得方針

| 項目 | 方針 |
|------|------|
| 取得粒度 | 操作単位（トランザクション単位） |
| 保管期間 | 10年（法定7年 + 予備3年） |
| 保管場所 | 監査ログ専用DB（書込専用、削除不可） |
| 改ざん防止 | ハッシュチェーン + 認定タイムスタンプ |
| アクセス権 | ACC_ADMIN、ACC_MGR、AUDITロールのみ照会可 |
| バックアップ | 日次バックアップ、別リージョン保管 |

### 2.2 ログ取得対象

#### 認証ログ

| 操作 | 取得項目 | 保管期間 |
|------|----------|----------|
| ログイン成功 | ユーザーID、日時、IP、デバイス情報、認証方式 | 3年 |
| ログイン失敗 | ユーザーID、日時、IP、失敗理由、試行回数 | 3年 |
| ログアウト | ユーザーID、日時、セッション時間 | 3年 |
| MFA認証 | ユーザーID、日時、認証方式、結果 | 3年 |
| パスワードリセット | ユーザーID、日時、リセット方法 | 3年 |
| アカウントロック | ユーザーID、日時、ロック理由 | 3年 |

#### 業務操作ログ（GL）

| 操作 | 取得項目 | 保管期間 |
|------|----------|----------|
| 仕訳入力 | 仕訳ID、入力者、日時、仕訳内容全項目（ヘッダ+明細） | 10年 |
| 仕訳承認 | 仕訳ID、承認者、日時、承認レベル、コメント | 10年 |
| 仕訳否認 | 仕訳ID、否認者、日時、否認理由 | 10年 |
| 仕訳修正 | 仕訳ID、修正者、日時、修正前後内容、修正理由 | 10年 |
| 仕訳取消 | 仕訳ID、取消者、日時、取消理由、赤黒仕訳ID | 10年 |
| 仕訳削除 | 仕訳ID、削除者、日時、削除理由、削除前内容 | 10年 |

#### 業務操作ログ（AR/AP）

| 操作 | 取得項目 | 保管期間 |
|------|----------|----------|
| 請求書発行 | 請求書ID、発行者、日時、請求内容全項目 | 10年 |
| 入金消込 | 消込ID、処理者、日時、請求ID、入金ID、消込金額 | 10年 |
| 請求書登録 | 請求書ID、登録者、日時、請求内容、インボイス情報 | 10年 |
| 支払処理 | 支払ID、処理者、日時、支払内容、振込先情報 | 10年 |
| 支払承認 | 支払ID、承認者、日時、承認結果 | 10年 |

#### 業務操作ログ（Property/Securities）

| 操作 | 取得項目 | 保管期間 |
|------|----------|----------|
| 物件登録 | 物件ID、登録者、日時、物件情報全項目 | 10年 |
| 契約登録 | 契約ID、登録者、日時、契約内容全項目 | 10年 |
| 賃料計上 | 処理ID、処理者、日時、対象物件、計上金額 | 10年 |
| 銘柄登録 | 銘柄ID、登録者、日時、銘柄情報全項目 | 10年 |
| 売買取引 | 取引ID、処理者、日時、売買内容全項目 | 10年 |
| 時価評価 | 処理ID、処理者、日時、評価対象、評価結果 | 10年 |

#### マスタ・システムログ

| 操作 | 取得項目 | 保管期間 |
|------|----------|----------|
| マスタ変更 | マスタ種別、キー、変更者、日時、変更前後値、変更理由 | 10年 |
| 決算締め | 期間、実行者、日時、締め種別 | 10年 |
| 決算締め解除 | 期間、実行者、日時、解除理由 | 10年 |
| 帳票出力 | 帳票ID、出力者、日時、出力条件、出力件数 | 3年 |
| システム設定変更 | 設定項目、変更者、日時、変更前後値 | 10年 |
| ユーザー権限変更 | 対象ユーザー、変更者、日時、変更内容 | 10年 |

### 2.3 相関ID（トレースID）

| 項目 | 仕様 |
|------|------|
| 形式 | UUID v4（例：550e8400-e29b-41d4-a716-446655440000） |
| 付与タイミング | APIリクエスト受信時（API Gateway） |
| 伝播方法 | HTTPヘッダー（X-Correlation-ID）、Kafkaヘッダー |
| ログ出力 | 全ログに相関IDを含める |
| 用途 | 一連処理の追跡、障害調査、監査証跡 |

```
[相関IDによるトレース例：仕訳入力→承認→GL反映]

Correlation-ID: 550e8400-e29b-41d4-a716-446655440000

User → Frontend → API Gateway → 会計サービス → DB
           │            │             │           │
           │            │             │           └─ [DB Log]
           │            │             │              correlation_id=550e8400...
           │            │             │              operation=INSERT
           │            │             │              table=journal_header
           │            │             │
           │            │             └─ [App Log]
           │            │                correlation_id=550e8400...
           │            │                action=createJournal
           │            │                journal_id=JE-2026-00001
           │            │
           │            └─ [Gateway Log]
           │               correlation_id=550e8400...
           │               path=/api/v1/journals
           │               method=POST
           │
           └─ [Audit Log]
              correlation_id=550e8400...
              operation=JOURNAL_CREATE
              user_id=user001
              journal_id=JE-2026-00001
```

### 2.4 監査ログテーブル構造

```sql
-- 監査ログメインテーブル
CREATE TABLE audit_log (
    log_id              BIGSERIAL PRIMARY KEY,
    correlation_id      UUID NOT NULL,
    timestamp           TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id             VARCHAR(50) NOT NULL,
    user_name           VARCHAR(100),
    user_role           VARCHAR(50),
    company_code        VARCHAR(10),
    ip_address          VARCHAR(45),
    user_agent          VARCHAR(500),
    operation           VARCHAR(50) NOT NULL,
    operation_category  VARCHAR(50) NOT NULL,
    target_type         VARCHAR(50) NOT NULL,
    target_id           VARCHAR(100),
    target_key          JSONB,
    before_value        JSONB,
    after_value         JSONB,
    result              VARCHAR(20) NOT NULL,
    error_code          VARCHAR(20),
    error_message       TEXT,
    reason              TEXT,
    hash_value          VARCHAR(64) NOT NULL,
    prev_hash           VARCHAR(64),
    timestamp_token     TEXT,
    CONSTRAINT audit_log_result_check
        CHECK (result IN ('SUCCESS', 'FAILURE', 'PARTIAL'))
);

-- パーティション（年月単位）
CREATE TABLE audit_log_202601 PARTITION OF audit_log
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

-- インデックス
CREATE INDEX idx_audit_log_correlation ON audit_log(correlation_id);
CREATE INDEX idx_audit_log_timestamp ON audit_log(timestamp);
CREATE INDEX idx_audit_log_user ON audit_log(user_id);
CREATE INDEX idx_audit_log_operation ON audit_log(operation);
CREATE INDEX idx_audit_log_target ON audit_log(target_type, target_id);

-- 書込専用ポリシー（削除・更新禁止）
REVOKE UPDATE, DELETE ON audit_log FROM PUBLIC;
REVOKE UPDATE, DELETE ON audit_log FROM app_user;
```

### 2.5 改ざん防止方式

```
[ハッシュチェーン方式]

Log N-1: hash_value = SHA256(JSON(内容) + prev_hash)
                                    │
                                    ▼
Log N:   hash_value = SHA256(JSON(内容) + Log N-1.hash_value)
                                    │
                                    ▼
Log N+1: hash_value = SHA256(JSON(内容) + Log N.hash_value)

ハッシュ対象項目:
- log_id
- correlation_id
- timestamp
- user_id
- operation
- target_type
- target_id
- before_value
- after_value
- result
- prev_hash

※検証処理：
1. 開始レコードから順にハッシュ値を再計算
2. 保存されたhash_valueと比較
3. 不一致の場合、改ざんアラートを発報
```

**認定タイムスタンプ**

| 項目 | 仕様 |
|------|------|
| タイムスタンプ局 | セイコーソリューションズ（認定TSA） |
| 付与タイミング | 日次バッチ（前日分をまとめて付与） |
| 付与対象 | 日次の全ログのハッシュ（マークルツリールート） |
| 検証方法 | TSAの公開鍵で署名検証 |

### 2.6 ログ検索・分析機能

| 機能 | 説明 | 利用者 |
|------|------|--------|
| フリーワード検索 | 全項目横断検索 | 監査担当 |
| 日時範囲検索 | 開始〜終了日時指定 | 監査担当 |
| ユーザー検索 | 特定ユーザーの操作履歴 | 管理者、監査担当 |
| 操作種別検索 | 特定操作の履歴 | 監査担当 |
| 相関ID追跡 | 一連処理の追跡 | 運用担当、監査担当 |
| 異常検知 | 通常と異なる操作パターン | セキュリティ担当 |
| レポート出力 | 定期監査レポート | 内部監査、外部監査 |

---

## 3. 電子帳簿保存法（電帳法）対応

### 3.1 対応区分

| 区分 | 対象書類 | 対応要否 | 要件対応 |
|------|----------|----------|----------|
| 電子帳簿等保存 | 仕訳帳、総勘定元帳、補助簿 | 対応 | 優良電子帳簿の要件対応 |
| スキャナ保存 | 紙の請求書・領収書・契約書 | 対応 | タイムスタンプ + 検索要件 |
| 電子取引 | 電子請求書・EDI・メール添付 | 対応（義務） | 2024年以降義務化対応済 |

### 3.2 電子帳簿等保存要件

#### 優良電子帳簿の要件対応

| 要件 | 対応内容 | 実装方法 |
|------|----------|----------|
| 記録事項の訂正削除の履歴 | 訂正削除履歴を全て保存 | 監査ログ + 履歴テーブル |
| 通常の業務処理期間経過後の入力履歴 | 遅延入力の記録 | 入力日と取引日の差異記録 |
| 帳簿間の相互関連性 | 仕訳と証憑の紐付け | 証憑ID参照 |
| 検索機能 | 日付・金額・取引先で検索 | 検索画面実装 |
| ダウンロード機能 | 税務調査時のデータ提供 | CSV/PDF出力機能 |

#### 訂正削除履歴の保存

```sql
-- 仕訳訂正履歴テーブル
CREATE TABLE journal_history (
    history_id          BIGSERIAL PRIMARY KEY,
    journal_id          VARCHAR(20) NOT NULL,
    version             INT NOT NULL,
    operation           VARCHAR(20) NOT NULL,  -- CREATE/UPDATE/DELETE/REVERSE
    operated_by         VARCHAR(50) NOT NULL,
    operated_at         TIMESTAMP WITH TIME ZONE NOT NULL,
    reason              TEXT,
    before_data         JSONB,
    after_data          JSONB,
    CONSTRAINT journal_history_operation_check
        CHECK (operation IN ('CREATE', 'UPDATE', 'DELETE', 'REVERSE'))
);

-- 訂正削除不可制御
-- ※物理削除は禁止、論理削除のみ許可
-- ※訂正は赤黒処理（取消仕訳 + 新規仕訳）で対応
```

### 3.3 スキャナ保存要件

#### 入力期限

| 入力方式 | 入力期限 | 対象 |
|----------|----------|------|
| 早期入力方式 | 受領後概ね7営業日以内 | 標準 |
| 業務処理サイクル方式 | 業務処理サイクル後概ね7営業日以内 | 月次処理 |

#### 解像度・階調要件

| 要件 | 基準 |
|------|------|
| 解像度 | 200dpi以上 |
| 階調 | カラー（RGB各256階調）または グレースケール（256階調） |
| 大きさ情報 | A4以下は不要、A4超は記録必要 |

#### タイムスタンプ要件

| 項目 | 仕様 |
|------|------|
| 付与期限 | 入力後速やかに（概ね7営業日以内） |
| タイムスタンプ局 | 認定TSA（セイコーソリューションズ等） |
| 付与対象 | スキャンデータ（PDF/JPEG）のハッシュ値 |
| 検証方法 | TSA公開鍵による署名検証 |

### 3.4 電子取引データ保存要件

#### 検索要件（義務）

| 検索項目 | 対象 | 検索機能 |
|----------|------|----------|
| 取引年月日 | 必須 | 範囲指定（開始日〜終了日） |
| 取引金額 | 必須 | 範囲指定（下限〜上限） |
| 取引先 | 必須 | 部分一致（前方/後方/中間） |

**検索機能実装**

| 要件 | 対応 | 実装方法 |
|------|------|----------|
| 日付範囲検索 | ○ | WHERE trade_date BETWEEN :from AND :to |
| 金額範囲検索 | ○ | WHERE amount BETWEEN :min AND :max |
| 2項目以上の組合せ | ○ | AND条件での複合検索 |
| ダウンロード | ○ | CSV出力、証憑PDFダウンロード |
| 整然とした形式での出力 | ○ | 日付・金額・取引先を含む一覧 |

### 3.5 真実性確保措置

| 措置 | 対応方法 | 詳細 |
|------|----------|------|
| タイムスタンプ | 認定TSAによる付与 | 電子取引データ受領後7営業日以内 |
| 訂正削除の防止 | 訂正削除履歴の保存 | 変更前データ + 変更理由 + 変更者 + 変更日時 |
| 相互牽制 | 承認ワークフロー | 入力者 ≠ 承認者（システム制御） |
| 事務処理規程 | 規程の備付け | 電子取引データ取扱規程を整備 |

### 3.6 証憑保管方式

| 項目 | 仕様 |
|------|------|
| 保管場所 | AWS S3（オブジェクトストレージ） |
| 保管期間 | 10年（法定7年 + 予備3年） |
| ファイル形式 | PDF/A-1b（長期保存用）、JPEG、PNG |
| 最大ファイルサイズ | 50MB/件 |
| 暗号化 | 保管時暗号化（AES-256-GCM） |
| 冗長化 | 3AZ冗長 + クロスリージョンレプリケーション |

**命名規則**

```
{会社コード}/{年度}/{取引区分}/{月}/{取引日}_{取引先コード}_{連番}.{拡張子}

例：
1000/2026/AP/01/20260108_V00001_001.pdf
1000/2026/AR/01/20260108_C00001_001.pdf
1000/2026/EXP/01/20260108_E00001_001.pdf
```

**フォルダ構成**

```
証憑ストレージ/
├── 1000/                       # 会社コード
│   ├── 2026/                   # 年度
│   │   ├── AP/                 # 買掛金関連
│   │   │   ├── 01/            # 月
│   │   │   │   ├── invoices/  # 請求書
│   │   │   │   └── receipts/  # 領収書
│   │   │   └── 02/
│   │   ├── AR/                 # 売掛金関連
│   │   │   └── 01/
│   │   │       └── invoices/  # 発行請求書
│   │   ├── EXP/                # 経費関連
│   │   │   └── 01/
│   │   │       ├── receipts/  # 領収書
│   │   │       └── others/    # その他
│   │   ├── CONTRACT/           # 契約書
│   │   │   ├── lease/         # 賃貸借契約
│   │   │   └── service/       # 業務委託契約
│   │   └── BANK/               # 銀行関連
│   │       └── statements/    # 取引明細
│   └── 2025/
└── 2000/                       # 別会社
```

### 3.7 タイムスタンプ付与フロー

```
[電子取引データ受領時のフロー]

1. 電子請求書受領（メール/EDI/アップロード）
       │
       ▼
2. システムに取込
   ├─ 取込日時記録
   ├─ ファイルハッシュ計算（SHA-256）
   └─ 仮保管領域に保存
       │
       ▼
3. 検索用メタデータ登録
   ├─ 取引日
   ├─ 金額（税込/税抜）
   ├─ 取引先名
   ├─ 取引先コード
   └─ 取引区分
       │
       ▼
4. タイムスタンプ付与（7営業日以内）
   ├─ 認定TSAへリクエスト
   ├─ タイムスタンプトークン取得
   └─ トークンをDB/ファイルに保存
       │
       ▼
5. 証憑ストレージに正式保管
   ├─ 命名規則に従いファイル移動
   ├─ 暗号化保存
   └─ メタデータ更新（保管場所、タイムスタンプ状態）
       │
       ▼
6. 仕訳との紐付け
   └─ 仕訳明細に証憑IDを設定
```

### 3.8 証憑と仕訳の紐付け

| 項目 | 仕様 |
|------|------|
| 紐付け方式 | 仕訳明細に証憑IDを保持（外部キー） |
| 紐付け単位 | 仕訳明細：証憑 = N:M（中間テーブル） |
| 参照方法 | 仕訳照会画面から証憑プレビュー/ダウンロード可能 |
| 逆引き | 証憑から関連仕訳を照会可能 |
| 整合性チェック | 仕訳金額と証憑金額の照合（バッチ + アラート） |

```sql
-- 証憑-仕訳紐付けテーブル
CREATE TABLE document_journal_link (
    link_id             BIGSERIAL PRIMARY KEY,
    document_id         VARCHAR(50) NOT NULL,
    journal_id          VARCHAR(20) NOT NULL,
    journal_line_no     INT,
    link_type           VARCHAR(20) NOT NULL,  -- PRIMARY/SUPPORTING
    linked_by           VARCHAR(50) NOT NULL,
    linked_at           TIMESTAMP WITH TIME ZONE NOT NULL,
    CONSTRAINT document_journal_link_type_check
        CHECK (link_type IN ('PRIMARY', 'SUPPORTING'))
);

-- 証憑マスタ
CREATE TABLE document_master (
    document_id         VARCHAR(50) PRIMARY KEY,
    document_type       VARCHAR(20) NOT NULL,
    company_code        VARCHAR(10) NOT NULL,
    trade_date          DATE NOT NULL,
    amount              DECIMAL(18,2) NOT NULL,
    tax_amount          DECIMAL(18,2),
    counterparty_code   VARCHAR(20),
    counterparty_name   VARCHAR(200),
    description         TEXT,
    file_path           VARCHAR(500) NOT NULL,
    file_hash           VARCHAR(64) NOT NULL,
    file_size           BIGINT NOT NULL,
    mime_type           VARCHAR(100),
    timestamp_token     TEXT,
    timestamp_at        TIMESTAMP WITH TIME ZONE,
    status              VARCHAR(20) NOT NULL,
    created_by          VARCHAR(50) NOT NULL,
    created_at          TIMESTAMP WITH TIME ZONE NOT NULL,
    CONSTRAINT document_master_status_check
        CHECK (status IN ('PENDING', 'TIMESTAMPED', 'LINKED', 'ARCHIVED'))
);

-- 検索用インデックス（電帳法要件）
CREATE INDEX idx_document_trade_date ON document_master(trade_date);
CREATE INDEX idx_document_amount ON document_master(amount);
CREATE INDEX idx_document_counterparty ON document_master(counterparty_name);
CREATE INDEX idx_document_composite ON document_master(trade_date, amount, counterparty_name);
```

---

## 4. データ保護方式

### 4.1 暗号化

| 対象 | 方式 | アルゴリズム | 鍵管理 |
|------|------|--------------|--------|
| 保管データ（DB） | 透過的暗号化（TDE） | AES-256 | AWS KMS |
| 保管データ（ストレージ） | サーバーサイド暗号化 | AES-256-GCM | AWS KMS |
| 通信データ | TLS | TLS 1.3 | ACM証明書 |
| バックアップ | 暗号化バックアップ | AES-256 | AWS KMS |
| APIキー | ハッシュ化 | bcrypt | - |
| 機密フィールド | アプリケーション暗号化 | AES-256-GCM | AWS Secrets Manager |

### 4.2 機密データ分類

| 分類 | データ項目例 | 保護措置 |
|------|-------------|----------|
| 極秘 | マイナンバー、口座番号、クレジットカード | 別DB管理、アクセス制限強化、暗号化 |
| 秘密 | 取引先情報、契約金額、従業員情報 | アクセス権限制御、監査ログ |
| 社外秘 | 財務データ、仕訳情報 | アクセス権限制御 |
| 公開可 | 勘定科目名、税コード名 | 制限なし |

### 4.3 個人情報保護

| データ項目 | 保護措置 | 備考 |
|------------|----------|------|
| 担当者名 | マスキング可能 | 照会権限に応じて部分表示 |
| 口座番号 | 部分マスキング | 下4桁以外「*」で表示 |
| 電話番号 | 部分マスキング | 中間4桁を「*」で表示 |
| メールアドレス | 部分マスキング | @前の一部を「*」で表示 |
| マイナンバー | 別DB管理 | アクセス権限者のみ、ログ必須 |

### 4.4 データ保持・削除

| データ種別 | 保持期間 | 削除方法 |
|------------|----------|----------|
| 仕訳データ | 10年 | 期間経過後、アーカイブ→削除 |
| 証憑データ | 10年 | 期間経過後、アーカイブ→削除 |
| 監査ログ | 10年 | 期間経過後、アーカイブ→削除 |
| セッションログ | 3年 | 期間経過後、自動削除 |
| 一時ファイル | 24時間 | 日次バッチで削除 |

---

## 5. セキュリティ監視

### 5.1 リアルタイム監視

| 監視項目 | 閾値 | アラート先 |
|----------|------|-----------|
| ログイン失敗（連続） | 5回/10分 | セキュリティ担当 |
| 大量データアクセス | 1,000件/時間 | セキュリティ担当 |
| 権限外アクセス試行 | 1回 | セキュリティ担当、管理者 |
| 深夜帯アクセス | 22:00-06:00 | 管理者（通知のみ） |
| 海外IPからのアクセス | 全件 | セキュリティ担当 |

### 5.2 定期監査

| 監査項目 | 頻度 | 実施者 |
|----------|------|--------|
| アクセス権限棚卸 | 四半期 | 内部監査 |
| SoD違反チェック | 月次 | システム管理者 |
| 監査ログ整合性検証 | 月次 | システム管理者 |
| 脆弱性診断 | 年次 | 外部セキュリティベンダー |
| ペネトレーションテスト | 年次 | 外部セキュリティベンダー |

---

## 6. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2026/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] 認証方式が社内標準（IdP連携）と整合しているか
- [ ] MFA要件が経理業務のリスクレベルに適切か
- [ ] ロールと権限の設計が職務分掌要件を満たしているか
- [ ] 業種特化機能（不動産・有価証券）の権限設計が適切か
- [ ] SoD（職務分掌）違反の検知・防止が実装されているか
- [ ] 承認フローと金額制限が内部統制要件を満たしているか
- [ ] 監査ログがJ-SOX要件（10年保管等）を満たしているか
- [ ] 監査ログの改ざん防止措置（ハッシュチェーン + TSA）が適切か
- [ ] 電帳法の検索要件（3項目）が実装されているか
- [ ] 電帳法の真実性確保措置（タイムスタンプ/訂正削除履歴）が実装されているか
- [ ] 証憑と仕訳の紐付け・相互参照が可能か
- [ ] 証憑保管のファイル構成・命名規則が運用可能か
- [ ] データ保護（暗号化、マスキング）が十分か
- [ ] 内部監査部門・監査法人のレビューを受けているか
- [ ] 情報セキュリティ部門のレビューを受けているか
