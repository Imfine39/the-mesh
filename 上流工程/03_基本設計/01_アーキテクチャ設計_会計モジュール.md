# アーキテクチャ設計（会計モジュール）

| 項目 | 内容 |
|------|------|
| 文書番号 | DES-ARC-ACC-001 |
| 版数 | 1.0 |
| 作成日 | 2026/01/08 |
| 作成者 | システム設計チーム |
| 承認者 | |
| 承認日 | |

---

## 1. システム全体構成

### 1.1 システム概要図

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              外部システム層                                    │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐│
│  │プロジェクト│  │契約管理 │  │工数管理 │  │人事給与 │  │銀行(EB) │  │証券会社 ││
│  │管理     │  │システム │  │システム │  │システム │  │システム │  │システム ││
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘│
└───────┼─────────────┼─────────────┼─────────────┼─────────────┼─────────────┼─────┘
        │             │             │             │             │             │
        ▼             ▼             ▼             ▼             ▼             ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                      連携基盤（API Gateway / ESB）                             │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │  メッセージキュー（Kafka） │ ファイル連携（SFTP） │ REST API Gateway     │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────────┘
        │             │             │             │             │             │
        ▼             ▼             ▼             ▼             ▼             ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                            会計システム                                        │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                     コアモジュール群                                    │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │   │
│  │  │   GL    │  │   AR    │  │   AP    │  │   FA    │  │   Tax   │      │   │
│  │  │(総勘定) │  │(売掛金) │  │(買掛金) │  │(固定資産)│  │ (税務)  │      │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                     業種特化モジュール群                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │   │
│  │  │   Property      │  │   Securities    │  │   Project       │        │   │
│  │  │  (不動産管理)    │  │ (有価証券管理)  │  │ (プロジェクト)   │        │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                     共通基盤                                           │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐ │   │
│  │  │認証・認可 │ │監査ログ  │ │マスタ管理│ │ワークフロー│ │帳票出力 │ │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └─────────┘ │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────────┐
│                              データ層                                          │
│  ┌───────────────────────┐  ┌───────────────────────┐  ┌─────────────────┐   │
│  │       会計DB          │  │    証憑ストレージ      │  │  監査ログDB     │   │
│  │   (PostgreSQL)        │  │    (Object Storage)    │  │  (時系列DB)     │   │
│  └───────────────────────┘  └───────────────────────┘  └─────────────────┘   │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 モジュール構成

#### コアモジュール群

| モジュール | 機能概要 | 主要エンティティ |
|------------|----------|------------------|
| GL（総勘定元帳） | 仕訳入力、承認、照会、試算表、決算、連結パッケージ出力 | 仕訳ヘッダ、仕訳明細、勘定残高、期間管理 |
| AR（売掛金） | 請求書発行、入金管理、消込、債権エイジング | 請求書、入金、消込、得意先残高 |
| AP（買掛金） | 請求書登録、支払管理、消込、インボイス検証 | 請求書、支払、消込、仕入先残高 |
| FA（固定資産） | 資産登録、減価償却、除却、台帳管理 | 資産マスタ、償却履歴、減損履歴 |
| Tax（税務） | 消費税計算、仕入税額控除、申告補助 | 税コード、税計算結果、控除計算 |

#### 業種特化モジュール群

| モジュール | 機能概要 | 主要エンティティ |
|------------|----------|------------------|
| Property（不動産） | 賃貸借管理、敷金保証金、賃料収入、修繕費 | 物件マスタ、契約、収入予定、敷金残高 |
| Securities（有価証券） | 売買管理、時価評価、配当管理、レポーティング | 銘柄マスタ、保有明細、取引履歴、評価履歴 |
| Project（プロジェクト） | 収益認識、原価配賦、進捗管理 | プロジェクト、WBS、収益認識計算 |

#### 共通基盤

| コンポーネント | 機能概要 |
|----------------|----------|
| 認証・認可 | SSO連携、RBAC、MFA対応 |
| 監査ログ | 操作ログ、変更履歴、電帳法対応タイムスタンプ |
| マスタ管理 | 勘定科目、分析軸、税コード、通貨・レート |
| ワークフロー | 承認フロー、代理承認、エスカレーション |
| 帳票出力 | 財務諸表、管理帳票、法定調書 |

---

## 2. モジュール分割境界

### 2.1 GL（総勘定元帳）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 仕訳の一元管理、残高管理、財務諸表作成、連結パッケージ出力 |
| 入力元 | AR/AP/FA/Tax/Property/Securities/Project各モジュール、外部連携、手動入力 |
| 出力先 | 帳票システム、連結システム、経営管理システム、監査法人 |
| 依存関係 | 勘定科目マスタ、分析軸マスタ、税コードマスタ、為替レートマスタ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| postJournal | 仕訳計上 | AR/AP/FA/Property/Securities/外部 | 同期API |
| postJournalBatch | 仕訳一括計上 | バッチ処理 | 非同期 |
| reverseJournal | 仕訳取消（赤黒） | 各モジュール | 同期API |
| getBalance | 残高照会 | 連結/レポート | 同期API |
| getTrialBalance | 試算表取得 | レポート | 同期API |
| closePeriod | 期間締め | バッチ | 非同期 |
| reopenPeriod | 期間再オープン | 管理者 | 同期API |
| generateClosingJournals | 決算仕訳生成 | バッチ | 非同期 |

**仕訳計上IF詳細**

```json
{
  "journalRequest": {
    "journal_date": "2026-01-08",
    "journal_type": "NORMAL",
    "source_module": "AR",
    "source_doc_type": "INVOICE",
    "source_doc_id": "INV-2026-00001",
    "currency": "JPY",
    "lines": [
      {
        "line_no": 1,
        "account_code": "1110100",
        "dr_cr": "DR",
        "amount": 1100000,
        "tax_code": "S10",
        "tax_amount": 100000,
        "segments": {
          "company": "1000",
          "profit_center": "PC01",
          "cost_center": "CC001",
          "project": "PRJ-2026-001"
        },
        "description": "ITコンサルティング売上"
      },
      {
        "line_no": 2,
        "account_code": "4110100",
        "dr_cr": "CR",
        "amount": 1000000,
        "segments": {
          "company": "1000",
          "profit_center": "PC01"
        },
        "description": "コンサルティング収益"
      },
      {
        "line_no": 3,
        "account_code": "2170100",
        "dr_cr": "CR",
        "amount": 100000,
        "description": "仮受消費税"
      }
    ]
  }
}
```

### 2.2 AR（売掛金）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 請求書発行、入金管理、消込、債権エイジング、滞留分析 |
| 入力元 | プロジェクト管理システム、契約管理システム、銀行入金データ |
| 出力先 | GL（売上仕訳、入金仕訳）、帳票（請求書、債権明細） |
| 依存関係 | 得意先マスタ、プロジェクトマスタ、契約マスタ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| createInvoice | 請求書発行 | プロジェクト管理/契約管理 | 同期API |
| createInvoiceBatch | 請求書一括発行 | バッチ | 非同期 |
| applyReceipt | 入金消込 | 銀行連携/手動 | 同期API |
| autoMatching | 自動消込 | バッチ | 非同期 |
| getAging | エイジング照会 | レポート | 同期API |
| getARBalance | 得意先残高照会 | レポート/外部 | 同期API |
| cancelInvoice | 請求書取消 | 手動 | 同期API |

**請求区分**

| 区分 | 説明 | GL連携 |
|------|------|--------|
| IT_CONSULTING | ITコンサルティングサービス | 売上計上時に仕訳生成 |
| PROJECT_TM | T&M型プロジェクト | 月次で工数×単価で計上 |
| PROJECT_FIX | 固定金額プロジェクト | マイルストーン到達時 |
| PROJECT_POC | 進行基準プロジェクト | 進捗率に応じて按分計上 |
| RENT_INCOME | 賃料収入 | 月次で定額計上 |
| DIVIDEND | 配当金収入 | 権利確定時に計上 |

### 2.3 AP（買掛金）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 請求書登録、支払管理、消込、インボイス検証、債務管理 |
| 入力元 | 購買管理システム、請求書OCR、外注管理システム |
| 出力先 | GL（仕入仕訳、支払仕訳）、銀行（FB）、帳票 |
| 依存関係 | 仕入先マスタ、インボイス登録事業者DB、支払条件マスタ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| registerInvoice | 請求書登録 | OCR/手動 | 同期API |
| validateInvoice | インボイス検証 | 登録時自動 | 同期API |
| createPayment | 支払データ作成 | 支払バッチ | 非同期 |
| applyPayment | 支払消込 | 銀行連携/手動 | 同期API |
| getAPBalance | 仕入先残高照会 | レポート | 同期API |
| getPaymentSchedule | 支払予定照会 | 資金繰り | 同期API |

**インボイス検証ルール**

| チェック項目 | 検証内容 | エラー時対応 |
|--------------|----------|--------------|
| 登録番号形式 | T+13桁数字 | 入力エラー |
| 登録事業者確認 | 国税庁API照会 | 警告表示、手動確認 |
| 必須項目 | 取引年月日、取引内容、税率別金額 | 入力エラー |
| 税率整合性 | 税率と税額の整合 | 計算警告 |

### 2.4 FA（固定資産）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 資産登録、減価償却、除却・売却、台帳管理、減損処理 |
| 入力元 | 購買管理、経理手動入力、Property（不動産取得） |
| 出力先 | GL（取得仕訳、償却仕訳、除却仕訳）、帳票（固定資産台帳） |
| 依存関係 | 資産区分マスタ、償却方法マスタ、耐用年数表 |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| registerAsset | 資産登録 | 購買/手動 | 同期API |
| calculateDepreciation | 償却計算 | 月次バッチ | 非同期 |
| postDepreciation | 償却仕訳計上 | 月次バッチ | 非同期 |
| disposeAsset | 除却・売却 | 手動 | 同期API |
| transferAsset | 資産移動 | 手動 | 同期API |
| impairAsset | 減損処理 | 手動 | 同期API |

**償却方法対応**

| 償却方法 | J-GAAP | IFRS | 備考 |
|----------|--------|------|------|
| 定額法 | ○ | ○ | 標準 |
| 定率法（200%） | ○ | - | 税務 |
| 定率法（250%） | ○ | - | 旧定率法 |
| 生産高比例法 | ○ | ○ | 特定資産 |

### 2.5 Property（不動産）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 賃貸借契約管理、賃料収入管理、敷金・保証金管理、修繕費管理 |
| 入力元 | 契約管理システム、PM会社連携、銀行入金データ |
| 出力先 | GL（賃料仕訳、敷金仕訳）、AR（請求連携）、帳票 |
| 依存関係 | 物件マスタ、テナントマスタ、契約マスタ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| registerProperty | 物件登録 | 手動 | 同期API |
| registerContract | 契約登録 | 契約管理連携 | 同期API |
| generateRentSchedule | 賃料スケジュール生成 | 契約登録時 | 同期API |
| postRentIncome | 賃料収入計上 | 月次バッチ | 非同期 |
| manageDeposit | 敷金管理（受入/返還） | 手動 | 同期API |
| postDepositInterest | 敷金利息計上 | 月次バッチ | 非同期 |

**賃料収入パターン**

| パターン | 処理タイミング | 仕訳生成 |
|----------|----------------|----------|
| 前受賃料 | 入金時に前受金計上、翌月に収益振替 | 2段階 |
| 当月賃料 | 当月末に売掛計上、入金時に消込 | 標準 |
| フリーレント | 契約期間按分で収益認識 | IFRS対応 |

### 2.6 Securities（有価証券）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 有価証券売買管理、時価評価、配当管理、保有レポート |
| 入力元 | 証券会社連携、手動入力、配当通知 |
| 出力先 | GL（売買仕訳、評価仕訳、配当仕訳）、帳票 |
| 依存関係 | 銘柄マスタ、証券会社マスタ、時価データ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| registerTrade | 売買取引登録 | 証券連携/手動 | 同期API |
| calculateValuation | 時価評価計算 | 月次バッチ | 非同期 |
| postValuation | 評価仕訳計上 | 月次バッチ | 非同期 |
| registerDividend | 配当登録 | 手動/自動 | 同期API |
| getHoldingReport | 保有明細レポート | レポート | 同期API |

**有価証券区分**

| 区分 | 評価方法 | 評価差額処理 |
|------|----------|--------------|
| 売買目的有価証券 | 時価評価 | P/L（有価証券評価損益） |
| 満期保有目的 | 償却原価法 | - |
| その他有価証券 | 時価評価 | B/S（その他有価証券評価差額金） |
| 子会社・関連会社株式 | 原価法 | 減損時のみP/L |

### 2.7 Tax（税務）モジュール

| 項目 | 内容 |
|------|------|
| 責務 | 消費税計算、仕入税額控除計算、申告データ作成 |
| 入力元 | GL（税コード付仕訳）、AP（インボイス情報） |
| 出力先 | GL（消費税精算仕訳）、帳票（消費税申告書） |
| 依存関係 | 税コードマスタ、課税区分マスタ、経過措置マスタ |

**提供インターフェース**

| IF名 | 機能 | 呼出元 | 方式 |
|------|------|--------|------|
| calculateTax | 消費税計算 | 仕訳計上時 | 同期API |
| calculateInputTax | 仕入税額控除計算 | 月次バッチ | 非同期 |
| generateTaxReturn | 申告データ生成 | 四半期/年次 | 非同期 |
| postTaxSettlement | 消費税精算仕訳 | 決算時 | 同期API |

**インボイス経過措置対応**

| 期間 | 控除割合 | 設定 |
|------|----------|------|
| 2023/10/1 - 2026/9/30 | 80% | 自動適用 |
| 2026/10/1 - 2029/9/30 | 50% | 自動適用 |
| 2029/10/1 - | 0% | 控除不可 |

---

## 3. 連携アーキテクチャ

### 3.1 外部システム連携一覧

| No | 連携先 | 連携内容 | 方向 | 方式 | 頻度 | データ量/日 |
|----|--------|----------|------|------|------|-------------|
| 1 | プロジェクト管理 | 売上データ（T&M/固定/POC） | In | API | 随時/月次 | 約100件 |
| 2 | 契約管理 | 契約データ、請求トリガー | In | API | 随時 | 約50件 |
| 3 | 工数管理 | 工数実績データ | In | Batch | 日次 | 約500件 |
| 4 | 人事給与 | 人件費データ、源泉徴収 | In | Batch | 月次 | 約200件 |
| 5 | 銀行(EB) | 入出金明細 | In | File(SFTP) | 日次 | 約300件 |
| 6 | 銀行(FB) | 支払データ | Out | File(SFTP) | 月2回 | 約100件 |
| 7 | 証券会社 | 約定データ、時価データ | In | API/File | 日次 | 約50件 |
| 8 | PM会社 | 賃貸管理データ | In | File | 月次 | 約200件 |
| 9 | 国税庁 | インボイス登録事業者確認 | Out/In | API | 随時 | 約50件 |
| 10 | 連結システム | 連結パッケージ | Out | File | 月次 | 1件 |
| 11 | 経営管理(BI) | 管理会計データ | Out | API | 日次 | 約1,000件 |
| 12 | 監査法人 | 監査資料 | Out | File | 随時 | 約100件 |

### 3.2 連携方式詳細

#### API連携（REST）

```
┌─────────────────────────────────────────────────────────────────┐
│                      API Gateway                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │認証/認可    │  │レート制限   │  │ロギング     │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   会計API群                                      │
│  /api/v1/journals      - 仕訳API                                │
│  /api/v1/invoices      - 請求書API                              │
│  /api/v1/payments      - 支払API                                │
│  /api/v1/assets        - 固定資産API                            │
│  /api/v1/properties    - 不動産API                              │
│  /api/v1/securities    - 有価証券API                            │
│  /api/v1/reports       - レポートAPI                            │
└─────────────────────────────────────────────────────────────────┘
```

#### ファイル連携（SFTP）

| 連携先 | ファイル形式 | 文字コード | 改行 | スケジュール |
|--------|--------------|------------|------|--------------|
| 銀行(EB) | 全銀フォーマット | Shift_JIS | CRLF | 毎日 09:00 |
| 銀行(FB) | 全銀フォーマット | Shift_JIS | CRLF | 支払日前日 |
| PM会社 | CSV | UTF-8 | LF | 月初 3営業日 |
| 連結システム | Excel/CSV | UTF-8 | LF | 月次締め後 |

#### メッセージ連携（Kafka）

```
┌─────────────────────────────────────────────────────────────────┐
│                      Kafka Cluster                               │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Topics:                                                      ││
│  │  - acc.journal.created      仕訳作成イベント                 ││
│  │  - acc.journal.approved     仕訳承認イベント                 ││
│  │  - acc.invoice.created      請求書作成イベント               ││
│  │  - acc.payment.completed    支払完了イベント                 ││
│  │  - acc.period.closed        期間締めイベント                 ││
│  │  - acc.valuation.completed  評価完了イベント                 ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 非同期イベント処理

```
[非同期イベントフロー例：プロジェクト売上→請求→入金]

プロジェクト管理 ─(売上確定)→ [Event Queue] ─→ AR(請求書発行)
                                                      │
                                                      ▼
                                                GL(売上仕訳)
                                                      │
                                ┌─────────────────────┘
                                ▼
銀行入金 ─(入金通知)→ [Event Queue] ─→ AR(消込処理)
                                                      │
                                                      ▼
                                                GL(入金仕訳)
```

**イベント順序保証**

| イベント名 | 発生元 | 処理先 | 順序保証 | パーティションキー |
|------------|--------|--------|----------|-------------------|
| 売上確定 | プロジェクト管理 | AR→GL | 必要 | project_id |
| 請求発行 | AR | GL | 必要 | customer_id |
| 入金通知 | 銀行 | AR→GL | 必要 | account_date |
| 賃料計上 | Property | AR→GL | 必要 | property_id |
| 約定通知 | 証券会社 | Securities→GL | 必要 | trade_date |
| 償却実行 | FA | GL | 不要 | - |
| 評価実行 | Securities | GL | 不要 | - |

### 3.4 同期/非同期の選択基準

| 条件 | 方式 | 理由 | 具体例 |
|------|------|------|--------|
| 即時レスポンス必要 | 同期（API） | ユーザー操作の応答性 | 仕訳入力、残高照会 |
| 大量データ処理 | 非同期（Batch） | パフォーマンス確保 | 月次償却、一括請求 |
| 処理時間長い | 非同期（Queue） | タイムアウト回避 | 決算処理、連結パッケージ |
| 障害時リトライ必要 | 非同期（Queue） | 永続化・再送 | 外部システム連携 |
| トランザクション整合性 | 同期（API） | ACID保証 | 仕訳承認、消込処理 |

---

## 4. 為替レート管理

### 4.1 レートソース

| 優先度 | レートソース | 取得方式 | 更新頻度 | 備考 |
|--------|--------------|----------|----------|------|
| 1 | 三菱UFJ銀行 | API | 日次 10:00 | TTM/TTB/TTS |
| 2 | 三井住友銀行 | API | 日次 10:00 | フォールバック |
| 3 | 日本銀行 | Web API | 日次 | 参考レート |
| 4 | Bloomberg | API | リアルタイム | 時価評価用 |
| 5 | 手動入力 | 画面 | 都度 | 最終手段 |

### 4.2 レート種別

| 種別 | コード | 説明 | 用途 |
|------|--------|------|------|
| 電信仲値 | TTM | 仲値 | 債権債務計上、標準換算 |
| 電信買相場 | TTB | 買い | 外貨入金時 |
| 電信売相場 | TTS | 売り | 外貨支払時 |
| スポットレート | SPOT | 即時 | 取引時レート |
| 月末レート | M_END | 月末TTM | 期末換算 |
| 期中平均レート | AVG | 月中平均 | P/L換算（連結） |
| 期首レート | B_END | 期首TTM | 資本換算（連結） |

### 4.3 対応通貨

| 通貨コード | 通貨名 | 主な用途 |
|------------|--------|----------|
| JPY | 日本円 | 機能通貨 |
| USD | 米ドル | 外貨建投資、海外取引 |
| EUR | ユーロ | 欧州取引 |
| GBP | 英ポンド | 英国取引 |
| CNY | 人民元 | 中国取引 |
| SGD | シンガポールドル | アジア投資 |
| HKD | 香港ドル | アジア投資 |

### 4.4 為替処理フロー

```
[外貨建有価証券の処理フロー]

1. 取得時（USD建て株式購入）
   投資有価証券（外貨）: USD 100,000 × 取引日TTM(150円) = ¥15,000,000
   現金預金: ¥15,000,000

2. 期末時価評価
   ├─ 外貨時価評価: USD 100,000 → USD 110,000（時価上昇）
   ├─ 円換算: USD 110,000 × 期末TTM(155円) = ¥17,050,000
   └─ 評価差額: ¥17,050,000 - ¥15,000,000 = ¥2,050,000
      └─ その他有価証券評価差額金（税効果考慮後）

3. 売却時
   現金預金: USD 110,000 × TTB(154円) = ¥16,940,000
   投資有価証券: ¥15,000,000（取得原価）
   有価証券売却益: ¥1,940,000（実現損益）
   その他有価証券評価差額金: 戻入
```

```
[外貨建賃料収入の処理フロー]

1. 請求計上時（USD建て賃料）
   売掛金（外貨）: USD 10,000 × 請求日TTM(150円) = ¥1,500,000
   賃貸事業収益: ¥1,500,000

2. 期末換算時
   売掛金残高: USD 10,000 × 期末TTM(155円) = ¥1,550,000
   換算差額: ¥50,000 → 為替差益（P/L）

3. 入金時
   普通預金: USD 10,000 × TTB(154円) = ¥1,540,000
   売掛金: ¥1,550,000（期末換算額）
   為替差損: ¥10,000（実現）
```

---

## 5. レイヤー構成

### 5.1 論理レイヤー

```
┌─────────────────────────────────────────────────────────────────┐
│                   プレゼンテーション層                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Web UI（React SPA）                                      │   │
│  │  - 仕訳入力画面                                          │   │
│  │  - 承認ワークフロー画面                                   │   │
│  │  - 帳票・レポート画面                                     │   │
│  │  - マスタメンテナンス画面                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ API Gateway（Kong）                                      │   │
│  │  - 認証・認可                                            │   │
│  │  - レート制限                                            │   │
│  │  - リクエストルーティング                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   アプリケーション層                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ アプリケーションサービス                                  │   │
│  │  - JournalApplicationService（仕訳ユースケース）          │   │
│  │  - ARApplicationService（売掛金ユースケース）             │   │
│  │  - APApplicationService（買掛金ユースケース）             │   │
│  │  - FAApplicationService（固定資産ユースケース）           │   │
│  │  - PropertyApplicationService（不動産ユースケース）       │   │
│  │  - SecuritiesApplicationService（有価証券ユースケース）   │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ トランザクション制御・セキュリティ                        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ドメイン層                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ エンティティ                                             │   │
│  │  - Journal, JournalLine（仕訳）                          │   │
│  │  - Account, AccountBalance（勘定）                       │   │
│  │  - Invoice, Receipt, Matching（AR/AP）                   │   │
│  │  - Asset, Depreciation（固定資産）                       │   │
│  │  - Property, Contract, RentSchedule（不動産）            │   │
│  │  - Security, Holding, Valuation（有価証券）              │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ドメインサービス                                         │   │
│  │  - PostingRuleEngine（仕訳生成ルールエンジン）           │   │
│  │  - TaxCalculationService（税額計算）                     │   │
│  │  - DepreciationCalculator（償却計算）                    │   │
│  │  - ValuationCalculator（時価評価計算）                   │   │
│  │  - FXRateService（為替レート取得）                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ バリューオブジェクト                                     │   │
│  │  - Money（金額：通貨+金額）                              │   │
│  │  - TaxAmount（税額：本体+税額+税率）                     │   │
│  │  - Period（会計期間）                                    │   │
│  │  - Segment（分析軸セット）                               │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                 インフラストラクチャ層                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ リポジトリ実装                                           │   │
│  │  - JournalRepository（PostgreSQL）                       │   │
│  │  - AccountRepository（PostgreSQL）                       │   │
│  │  - AssetRepository（PostgreSQL）                         │   │
│  │  - DocumentRepository（Object Storage）                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 外部システム連携                                         │   │
│  │  - BankGateway（EB/FB連携）                              │   │
│  │  - InvoiceRegistryGateway（国税庁API）                   │   │
│  │  - FXRateGateway（為替レートAPI）                        │   │
│  │  - SecuritiesGateway（証券会社連携）                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ メッセージング                                           │   │
│  │  - KafkaProducer/Consumer                                │   │
│  │  - EventPublisher                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 コンポーネント構成

| レイヤー | コンポーネント | 技術 | 備考 |
|----------|----------------|------|------|
| プレゼンテーション | Web UI | React 18 + TypeScript | SPA |
| プレゼンテーション | API Gateway | Kong | 認証・ルーティング |
| アプリケーション | 会計サービス | Java 21 + Spring Boot 3 | REST API |
| アプリケーション | バッチサービス | Spring Batch | 月次処理 |
| ドメイン | ドメインモデル | DDD | 純粋Java |
| インフラ | RDB | PostgreSQL 16 | メインDB |
| インフラ | キャッシュ | Redis 7 | セッション・マスタキャッシュ |
| インフラ | メッセージキュー | Apache Kafka | イベント連携 |
| インフラ | 検索 | OpenSearch | 仕訳検索 |
| インフラ | ストレージ | MinIO/S3 | 証憑保管 |

---

## 6. 配置構成

### 6.1 物理配置図

```
┌─────────────────────────────────────────────────────────────────────┐
│                              DMZ                                     │
│    ┌──────────────────┐    ┌──────────────────┐                     │
│    │      WAF         │    │   Load Balancer  │                     │
│    │  (AWS WAF)       │    │    (ALB/NLB)     │                     │
│    └──────────────────┘    └──────────────────┘                     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                        Private Subnet (App)                          │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐        │
│    │  API Server  │    │  API Server  │    │  API Server  │        │
│    │  (ECS/K8s)   │    │  (ECS/K8s)   │    │  (ECS/K8s)   │        │
│    │   Pod x 3    │    │   Pod x 3    │    │   Pod x 3    │        │
│    └──────────────┘    └──────────────┘    └──────────────┘        │
│                                                                      │
│    ┌──────────────┐    ┌──────────────┐                             │
│    │ Batch Server │    │  Worker      │                             │
│    │  (ECS/K8s)   │    │  (Kafka)     │                             │
│    └──────────────┘    └──────────────┘                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────┐
│                        Private Subnet (Data)                         │
│    ┌──────────────────────────────────────────────────────────┐     │
│    │                    PostgreSQL Cluster                     │     │
│    │    ┌──────────────┐    ┌──────────────┐                  │     │
│    │    │   Primary    │───→│   Standby    │                  │     │
│    │    │  (Writer)    │    │  (Reader)    │                  │     │
│    │    └──────────────┘    └──────────────┘                  │     │
│    └──────────────────────────────────────────────────────────┘     │
│                                                                      │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐        │
│    │    Redis     │    │    Kafka     │    │  OpenSearch  │        │
│    │   Cluster    │    │   Cluster    │    │   Cluster    │        │
│    └──────────────┘    └──────────────┘    └──────────────┘        │
│                                                                      │
│    ┌──────────────────────────────────────────────────────────┐     │
│    │               Object Storage (S3/MinIO)                   │     │
│    │    ┌──────────────┐    ┌──────────────┐                  │     │
│    │    │  証憑Bucket  │    │  帳票Bucket  │                  │     │
│    │    └──────────────┘    └──────────────┘                  │     │
│    └──────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 サーバー構成

| サーバー種別 | 構成 | スペック | 備考 |
|--------------|------|----------|------|
| API Server | 3ノード | 4vCPU/16GB | オートスケール対応 |
| Batch Server | 2ノード | 8vCPU/32GB | 月次処理負荷対応 |
| DB Primary | 1ノード | 8vCPU/64GB/1TB SSD | Aurora PostgreSQL |
| DB Standby | 1ノード | 8vCPU/64GB/1TB SSD | リードレプリカ兼用 |
| Redis | 3ノード | 4vCPU/16GB | クラスターモード |
| Kafka | 3ノード | 4vCPU/16GB | 3ブローカー構成 |
| OpenSearch | 3ノード | 4vCPU/32GB | 検索用 |
| Object Storage | - | 5TB | 証憑保管（7年） |

### 6.3 可用性設計

| 要素 | 方式 | RTO | RPO |
|------|------|-----|-----|
| アプリケーション | マルチAZ配置 | 5分 | 0 |
| データベース | 同期レプリケーション | 5分 | 0 |
| ストレージ | クロスリージョンレプリケーション | 1時間 | 15分 |
| バックアップ | 日次フルバックアップ | 4時間 | 24時間 |

### 6.4 スケーリング方針

| 対象 | トリガー | スケール方式 |
|------|----------|--------------|
| API Server | CPU 70%超過 | 水平スケール（最大10ノード） |
| Batch Server | 月次処理時 | スケジュールスケール |
| DB Read | クエリ負荷 | リードレプリカ追加 |
| Kafka | メッセージ滞留 | パーティション追加 |

---

## 7. 更新履歴

| 版数 | 更新日 | 更新者 | 更新内容 |
|------|--------|--------|----------|
| 1.0 | 2026/01/08 | システム設計チーム | 初版作成 |

---

## 【レビューチェックリスト】

- [ ] モジュール間の責務分担が明確か
- [ ] 業種特化モジュール（Property/Securities/Project）の設計が適切か
- [ ] 連携方式（同期/非同期）の選択基準が適切か
- [ ] 為替処理のレートソースと冗長性が確保されているか
- [ ] インボイス制度対応の設計が適切か
- [ ] レイヤー間の依存関係が正しいか（上位→下位のみ）
- [ ] 非機能要件（性能、可用性）を満たす構成か
- [ ] 将来の拡張性（モジュール追加、スケールアウト）が考慮されているか
- [ ] J-GAAP/IFRS両対応の設計が適切か
- [ ] 電帳法・監査対応の設計が適切か
- [ ] インフラチームのレビューを受けているか
